---
title: "Repo Management"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# remotes::install_github("rundel/ghclass")
library(ghclass)
library(tidyverse)
library(glue)
#library(R.cache)
```

# Setup

Create a GitHub org, and a GitHub Classroom within that org.

The first exercise I created as a GitHub classroom assignment, so students could accept it using the 
GitHub Classroom machinery. After that, we'll create a Portfolio repo and just manage it ourselves.

```{r}
ghorg <- "Calvin-DS202-21FA"
org_sitrep(ghorg)
```

```{r}
clones_path <- here::here("student_data/repos/")
portfolio_clone_path <- fs::path_join(c(clones_path, "portfolios"))
```

Students who join a GitHub Classroom by accepting an assignment are added as "outside collaborators".
I think this works ok.

I set the TA/grader as an Owner on the GitHub org.

```{r}
org_outside_collaborators <- function(org) {
  ghclass:::ghclass_api_v3_req(endpoint = "GET /orgs/:org/outside_collaborators", org = org) %>%
    purrr::map_chr("login")
}
members <- org_members(ghorg)
students <- members %>% setdiff(org_admins(ghorg))
students <- union(students, org_outside_collaborators(ghorg))
```

The first quiz includes a question for GitHub username. This establishes a clear link between GitHub and Moodle.

```{r}
roster <-
  read_csv(
    "../student_data/21FA DATA-202-A-Quiz 1-responses.csv",
    col_types = cols(.default = col_character())
  ) %>%
  janitor::clean_names() %>%
  select(-(state:grade_100_00)) %>% # remove Moodle stuff
  rename(
    preferred_name = response_1,
    github = response_2,
    major = response_3,
    covid = response_4,
    secret_word = response_5,
    bool_expr = response_6,
    courses = response_7,
    ideas = response_8,
    other = response_9
  )
nrow(roster)

# All org members should be on the roster.
students %>% setdiff(roster$github)

# All roster members should be in the org.
setdiff(roster$github, students)
```

```{r}
roster %>% count(covid, sort = TRUE)# %>% clipr::write_clip()
```

```{r}
roster %>% mutate(
  num_courses = str_count(courses, "[0-9][0-9][0-9]")) %>% 
  ggplot(aes(x = num_courses)) +
    geom_bar() +
    scale_x_continuous(breaks = 1:10) +
    labs(x = "Number of previous courses")
```


# Create portfolio template

Create the repo manually for now. Clone:

```{r}
#if (!dir.exists(paste0(clones_path, "/portfolio-reference")))
#  local_repo_clone(glue("{ghorg}/portfolio-reference"), clones_path)
```

STOP. Put some files in there by hand. Commit and push by hand.


```{r compute-repo-names}
student_repos <- tibble(
  username = students,
  portfolio_repo = paste0("portfolio-", students),
  portfolio_repo_full = glue("{ghorg}/{portfolio_repo}"),
)
```

IGNORE THE BELOW. Use a GitHub Classroom assignment for this repo also. Because
otherwise students need to accept an emailed invite, and they can lose the email.

Now let's create portfolio repos for everyone.

```{r eval=FALSE}
if (FALSE) {
  repo_set_template(paste0(ghorg, "/", "portfolio-reference"))
  org_create_assignment(
    org = ghorg,
    user = student_repos$username,
    repo = student_repos$portfolio_repo,
    source_repo = paste0(ghorg, "/", "portfolio-reference")
  )
}
```

# Deploy assignments

Once an assignment is deployed, we should treat that as final. Updating templates in-place can cause merge conflicts for students.

```{r eval=FALSE}
# This works because this Rmd file is in the `src` directory, and the directory structure here matches the portfolio repo.
get_assignment_files <- function(path, deploy_solutions, deploy_knitted) {
  # Need to pull out the names so we don't get gobbledygook color control characters in the commit messages.
  files <- names(fs::dir_ls(path, recurse = TRUE, type = "file"))
  
  is_solution <- str_detect(files, "solution")
  if (deploy_solutions) {
    files <- files[is_solution]
  } else {
    files <- files[!is_solution]
  }
  if (!deploy_knitted) files <- files[!(str_ends(files, ".html") | str_ends(files, '.pdf'))]
  files
}

instructor_repos <- glue("{ghorg}/portfolio-{c('demo', 'reference')}")

deploy_assignment <- function(path, deploy_solutions = FALSE, repos = c(instructor_repos, student_repos$portfolio_repo_full),
                              deploy_knitted = FALSE) {
  files <- get_assignment_files(path, deploy_solutions = deploy_solutions, deploy_knitted = deploy_knitted)
  repo_add_file(repos, files, preserve_path = TRUE, overwrite = FALSE)
}

# "ex/ex07-modeling" %>% 
#   get_assignment_files(deploy_solutions = FALSE) %>% 
#   repo_add_file(student_repos$portfolio_repo_full, ., preserve_path = TRUE, overwrite = FALSE)
if (FALSE) {
  deploy_assignment(
   "hw/hwFinal"
    #"ex/ex12-sql"
  #   #"datavis"
  )
}

# If oops:
#repo_delete_file(
#  c(student_repos$portfolio_repo_full, ),
#  "hw/hw02-vis/hw02-vis.md")
```

```{r}
#get_assignment_files("hw/hw10-modeling/", deploy_solutions = F, deploy_knitted = F)
```


## Local clones

I did `git clone --bare git@github.com:Calvin-DS202-21FA/portfolio-reference.git portfolios` 

```{r}
roster_with_repos <- roster %>% 
  separate(preferred_name, into = "fname", extra = "drop", remove = FALSE) %>% 
  mutate(
    full_name = paste0(fname, " ", last_name),
    full_name = case_when(
      full_name == "Grace Grace" ~ "Gloria Grace",
      TRUE ~ full_name
    )) %>% 
  mutate(slugname = str_replace_all(paste0(fname, last_name), "[^A-Za-z]", "")) %>% 
  select(fname, last_name, full_name, slugname, github, email_address) %>% 
  left_join(student_repos, by = c('github' = 'username')) %>% 
  mutate(
    branch = glue("{slugname}-main"),
    worktree = glue("../portfolio-{slugname}"),
    worktree_full = paste0(portfolio_clone_path, '/', worktree))

#write_csv(roster_with_repos, "../student_data/roster-with-repos.csv")
roster_with_repos
```


Set up the remotes. Each student's portfolio repo is given a "remote" name corresponding to their slugname.

```{r eval=FALSE}
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ gert::git_remote_add(repo = I(portfolio_clone_path), name = .$slugname, url = glue("git@github.com:{ghorg}/{.$portfolio_repo}.git")))
```

Fetch all.

```{r}
# Fetch
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ system2('git', c('-C', portfolio_clone_path, 'fetch', .$slugname)))

# Pull from worktrees
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ {cat(.$worktree_full); system2('git', c('-C', .$worktree_full, 'pull'))})

```


Setup branches (one-time)

```{r eval=FALSE}
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ system2('git', c('-C', portfolio_clone_path, 'branch', paste0(.$slugname, "-main"), paste0(.$slugname, "/main"))))
```


Setup worktrees

```{r eval=FALSE}
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ system2('git', c('-C', portfolio_clone_path, 'worktree', 'add', .$worktree, .$branch)))
```

Make pdf's for hw3.

```{r eval=FALSE}
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ paste0(portfolio_clone_path, '/', .$worktree, "/hw/hw03-wrangling/hw03-wrangling.html") %>% pagedown::chrome_print())
```

Pull out submission for hw3.

```{r eval=FALSE}
roster_with_repos %>% 
  rowwise() %>% 
  group_walk(~ file.copy(
    paste0(portfolio_clone_path, '/', .$worktree, "/hw/hw03-wrangling/hw03-wrangling.pdf"),
    paste0("hw3-", .$slugname, ".pdf")))
```



```{r eval=FALSE}
# https://stackoverflow.com/questions/62621474/run-an-expression-rowwise-for-its-side-effect-only/69486771#69486771
tibble(file = c("iris.csv", "mtcars.csv"),
       data = list(iris, mtcars)) %>% 
  rowwise() %>%
  group_walk(~ write_csv(.$data[[1]], .$file))

tibble(file = c("iris.csv", "mtcars.csv"),
       data = list(iris, mtcars)) %>% 
  rowwise() %>%
  group_walk(function(row, key) {
    with(row, {
      write_csv(data[[1]], file)
    })
  })
```

## Team Repos

First, create the template repo.

```{r}
template_repo_name <- "proj-template"
template_repo_fullname <- paste0(ghorg, "/", template_repo_name)
src_dir <- "proj/"
if (!repo_exists(template_repo_fullname))
  repo_create(ghorg, template_repo_name)

if (FALSE) {
withr::with_dir(src_dir, {
  repo_add_file(
    template_repo_fullname,
    get_assignment_files(".", deploy_solutions = FALSE, deploy_knitted = FALSE),
    preserve_path = TRUE,
    overwrite = FALSE
  )
})

repo_set_template(template_repo_fullname, TRUE)
}
```

Step 2: Figure out the teams.

```{r}
team_roster <- readxl::read_excel("~/OneDrive - Calvin University/Teaching/21FA DATA202/21FA DATA202 Students and Project Feedback.xlsx")
```


```{r}
team_githubs <- team_roster %>% select(
  full_name = 1,
  team = 2
) %>% 
  left_join(roster_with_repos, by = "full_name") %>% 
  mutate(proj_repo = paste0("proj-", team))
team_githubs %>% filter(is.na(github))
team_githubs
```

Step 3: Make clones for each team. See <https://rundel.github.io/ghclass/articles/articles/ghclass.html#distributing-a-team-assignment>

```{r}
if (FALSE) {
org_create_assignment(
  org = ghorg,
  user = team_githubs$github,
  repo = team_githubs$proj_repo,
  team = team_githubs$team,
  source_repo = template_repo_fullname,
  private = TRUE
)
}
```

Oops, push update to template. (Next time: `distinct(proj_repo)`!)

```{r}
if (FALSE) {
  withr::with_dir(src_dir, {
    repo_add_file(
      paste0(ghorg, "/", team_githubs$proj_repo),
      get_assignment_files(".", deploy_solutions = FALSE, deploy_knitted = FALSE),
      preserve_path = TRUE,
      overwrite = TRUE
    )
  })
}
```

Clone local repos


```{r}
team_githubs %>% distinct(proj_repo) %>% 
  pull(proj_repo) %>% 
  walk(\(repo) local_repo_clone(glue("{ghorg}/{repo}"), clones_path))
```


```{r}
team_githubs %>% pull(proj_repo) %>% unique() %>% file.path(clones_path, .) %>% local_repo_pull()
```

