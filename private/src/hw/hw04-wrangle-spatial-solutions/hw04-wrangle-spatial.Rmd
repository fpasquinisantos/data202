---
title: "Homework 04 - Wrangling Spatial Data"
author: "Author Goes Here"
output:
  prettydoc::html_pretty
---

### Load packages and data

```{r load-packages, message=FALSE}
library(tidyverse) 
```

```{r load-data, message=FALSE}
dennys <- read_rds("data/dennys.rds")
laquinta <- read_rds("data/laquinta.rds")
states <- read_csv("data/states.csv", col_types = cols(
  name = col_character(),
  abbreviation = col_character(),
  area = col_double()
))
```

### Exercise 1

```{r}
dn_ak <- dennys %>%
  filter(state == "AK")
```

There are `r nrow(dn_ak)` Denny's locations in Alaska.


### Exercise 2


```{r}
lq_ak <- laquinta %>%
  filter(state == "AK")
```

There are `r nrow(lq_ak)` La Quinta locations in Alaska.


### Exercise 3

For each of the `r nrow(dn_ak)` Denny's, we need to calculate its distance to each of the `r nrow(lq_ak)` La Quinta locations, for 
a total of `r nrow(dn_ak) * nrow(lq_ak)` distances.


### Exercise 4

```{r}
dn_lq_ak <- full_join(dn_ak, lq_ak, by = "state", suffix = c("_dn", "_lq"))
dn_lq_ak
```



### Exercise 5


```{r}
# Implementation from dsbox
haversine <- function(long1, lat1, long2, lat2) {
  # convert to radians
  long1 = long1 * pi / 180
  lat1  = lat1  * pi / 180
  long2 = long2 * pi / 180
  lat2  = lat2  * pi / 180
  
  # Earth mean radius in km (WGS84 ellipsoid)
  R = 6371.009
  
  a = sin((lat2 - lat1)/2)^2 + cos(lat1) * cos(lat2) * sin((long2 - long1)/2)^2
  d = R * 2 * asin(sqrt(a))
  # Return the distance in km
  d
}
```

```{r}
dn_lq_ak <- dn_lq_ak %>% 
  mutate(distance = haversine(
    long1 = longitude_dn, lat1 = latitude_dn,
    long2 = longitude_lq, lat2 =latitude_lq))
dn_lq_ak
```



### Exercise 6

```{r}
dn_lq_ak_mindist <- dn_lq_ak %>%
  group_by(address_lq, city_lq) %>%
  summarise(dist_to_nearest = min(distance))
dn_lq_ak_mindist
```


### Exercise 7

No, the closest pair, in Anchorage, is almost 4 km apart.


### Exercise 8

```{r}
compute_closest_dennys <- function(the_state) {
  dn_state <- dennys %>% 
    filter(state == the_state)
  lq_state <- laquinta %>% 
    filter(state == the_state)
  
  # join to get all possible pairings
  dist_to_closest <- full_join(dn_state, lq_state, by = "state", suffix = c("_dn", "_lq")) %>% 
    # compute distances
    mutate(distance = haversine(long1 = longitude_dn, lat1 = latitude_dn,
                                long2 = longitude_lq, lat2 = latitude_lq)) %>% 
    # compute distance to closest Denny's for each La Quinta location.
    group_by(address_lq, city_lq) %>%
    summarise(dist_to_nearest = min(distance), .groups = "drop")
  
  return(dist_to_closest)
}
```

## Exercise 9

```{r}
distances_NC <- compute_closest_dennys("NC")
distances_NC
```

```{r}
distances_NC %>% 
  summarize(min(dist_to_nearest), median(dist_to_nearest))
```

```{r}
distances_NC %>% 
  ggplot(aes(x = dist_to_nearest)) +
  geom_point(aes(y = 0))
```


### Exercise 10


```{r}
distances_TX <- compute_closest_dennys("TX")
distances_TX
```

```{r}
distances_TX %>% 
  summarize(min(dist_to_nearest), median(dist_to_nearest))
```

```{r}
distances_TX %>% 
  ggplot(aes(x = dist_to_nearest)) +
  #geom_point(aes(y = 0))
  geom_histogram(binwidth = 2)
```


### Exercise 10

If we just don't filter by state, we can do all at once.

```{r}
dn_lq_pairs <- inner_join(dennys, laquinta, by = "state", suffix = c("_dn", "_lq"))

# Here's how to consider even pairs that cross state lines.
#dn_lq_pairs <- full_join(dennys, laquinta, by = character(), suffix = c("_dn", "_lq"))
```

```{r}
results_for_all_states <- dn_lq_pairs %>% 
  mutate(distance = haversine(lat1 = latitude_dn, long1 = longitude_dn,
                              lat2 = latitude_lq, long2 = longitude_lq)) %>% 
  # compute distance to closest Denny's for each La Quinta location.
  group_by(state, address_lq, city_lq) %>%
  summarise(dist_to_nearest = min(distance), .groups = "drop")

results_for_all_states %>% 
  group_by(state) %>% 
  mutate(num_in_state = n()) %>% 
  ungroup() %>% 
  filter(num_in_state > 5) %>% 
  ggplot(aes(x = dist_to_nearest, y = fct_infreq(state))) + geom_boxplot()
  
```

That's too much detail. Just show closests:

```{r}
results_for_all_states %>% 
  group_by(state) %>% 
  summarize(min_dist = min(dist_to_nearest), num_in_state = n()) %>% 
  ggplot(aes(x = min_dist, y = fct_reorder(state, min_dist))) + geom_point()
```


### Exercise 11


