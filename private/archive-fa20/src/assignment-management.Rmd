---
title: "Assignment Management"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# remotes::install_github("rundel/ghclass")
library(ghclass)
library(tidyverse)
library(glue)
library(R.cache)
```

# Read and verify roster

```{r}
ghorg <- "Calvin-DS202-FA20"
```

```{r}
roster <- read_csv("../roster.csv", col_types = cols(
  .default = col_character(),
  active = col_integer()
)) %>% janitor::clean_names()
nrow(roster)
stopifnot(
  0 == length(org_members(ghorg) %>% setdiff(org_admins(ghorg)) %>% setdiff(roster$github))
)
```


# Assign Teams


```{r}
fix_roster <- function(roster, assignment) {
  if (assignment != "lab04") {
    roster %>% mutate(
      cohort = case_when(
        str_detect(preferred_email, "bdr22") ~ "H",
        str_detect(preferred_email, "wp22") ~ "B",
        TRUE ~ cohort
      )
    )
  } else if (assignment %in% c("lab04", "lab05", "lab06", "lab07")) {
    roster
  } else {
    roster %>% filter(active == 1)
  }
}
# fix_roster(roster, "lab05", 1) %>% filter(cohort %in% c("B", "H"))
```


```{r assign-teams}
team_seeds <- tribble(
  ~assignment, ~seed,
  "lab04", 0,
  "lab05", 1,
  "lab06", 8, # there wasn't really a lab06, so we reuse this seed.
  "lab07", 8
)

roster_withteams <- team_seeds %>%
  pmap_dfr(function(assignment, seed) {
    roster %>%
      fix_roster(assignment) %>%
      {
        withr::with_seed(seed, slice_sample(., prop = 1))
      } %>%
      group_by(cohort) %>%
      mutate(
        team = glue("{assignment}-{cohort}{if_else((row_number() - 1) / n() < .5, 1, 2)}")
      ) %>%
      ungroup() %>%
      mutate(assignment, .before = everything())
  })
roster_withteams

team_sizes <- roster_withteams %>%
  group_by(assignment, team) %>%
  mutate(team_size = n()) %>%
  filter(str_detect(student_name, "Danish") | (assignment != "lab04" & str_detect(student_name, "Brad")))
if (any(team_sizes$team_size != 3)) {
  stop("Danish and Brad should always be on a team of 3.")
}
```

Run this to copy team membership to clipboard. Paste into Excel and copy back out again for easy formatting as HTML table.

```{r copy-team-membership, eval=FALSE}
copy_team_membership <- function(assignment) {
  roster_withteams %>%
    filter(assignment == !!assignment) %>%
    select(Name = preferred_full_name, Cohort = cohort, Team = team) %>%
    arrange(Team) %>%
    clipr::write_clip() %>%
    count(Team)
}
copy_team_membership("lab07")
```

```{r}
getTeammates <- function(name) {
  roster_withteams %>%
    filter(preferred_name == name) %>%
    select(team) %>%
    left_join(roster_withteams, by = "team")
}
```


# Create Assignment

First make the template repo

```{r}
createAssignmentTemplate <- function(assignmentTemplatePath, use_template_repo = TRUE) {
  assignmentName <- stringr::str_match(assignmentTemplatePath, r"{\w+/([a-z0-9]+)}")[, 2]
  message(glue("Creating assignment {assignmentName}"))
  repoName <- paste0(assignmentName, "-template")
  repo_create(ghorg, repoName, gitignore_template = "")

  # If we have big data files, can't use template repos.
  if (use_template_repo) {
    repo_set_template(paste0(ghorg, "/", repoName))
  }

  message("Pushing local repo")
  system2("./make-repo.sh", c(repoName, assignmentTemplatePath, assignmentName))
  message(glue("Pushed repo to https:://github.com/{ghorg}/{repoName}"))
}
```

```{r, eval=FALSE}
# createAssignmentTemplate("hw/hw04-other-tools")
# createAssignmentTemplate("lab/lab05-ugly-charts")
createAssignmentTemplate("proj/proj")
#createAssignmentTemplate("lab/lab12-clustering")
```

(This is a WIP Python replacement for the shell script)

```python
import subprocess, pathlib
file_list = subprocess.run(
  ["git", "ls-files", "-z"], stdout=subprocess.PIPE, cwd=str(pathlib.Path("hw/hw03-agg"))
).stdout.split(b'\0')[:-1]
for f in file_list:
  f = f.decode('utf-8')
  if "solution" in f:
    continue
  print(f)
  
```


## Push repo to students

```{r solo-assignment}
my_create_assignment <- function(usernames, assignmentName) {
  org_create_assignment(
    org = ghorg,
    user = usernames,
    repo = paste0(assignmentName, "-", usernames),
    source_repo = paste0(ghorg, "/", assignmentName, "-template")
  )
}
pushSoloAssignment <- function(assignmentName, includeStaff = TRUE, usernames = NULL) {
  if (is.null(usernames)) {
    usernames <- roster$github
    if (includeStaff) {
      usernames <- c(usernames, "kcarnold", "kimyejae")
    }
  }
  my_create_assignment(usernames, assignmentName = assignmentName)
}
```


```{r push-solo-assignment, eval=FALSE}
pushSoloAssignment("hw09")
```

```{r eval=FALSE}
# Push solo assignments for Sonali
{
  username <- roster %>%
    filter(str_detect(preferred_full_name, "Sonali")) %>%
    pull(github)
  # team_seeds$assignment
  "lab07" %>% walk(~ my_create_assignment(usernames = username, assignmentName = .x))
}
```


```{r team-flex-assignments, eval=FALSE}
push_flexTeam_assignments <- function(assignmentName) {
  expand_grid(
    fix_roster(roster, assignmentName),
    repo_idx = 1:5
  ) %>%
    mutate(repo = glue("{assignmentName}-{cohort}{repo_idx}")) %>%
    select(github, repo) %>%
    bind_rows(tibble(github = c("kcarnold", "kimyejae"), repo = paste0(assignmentName, "-staff"))) %>%
    {
      org_create_assignment(
        org = ghorg,
        user = .$github,
        repo = .$repo,
        team = .$repo,
        source_repo = glue("{ghorg}/{assignmentName}-template")
      )
    }
}
push_flexTeam_assignments("lab11")
```


```{r team-assignment, eval=FALSE}
pushTeamAssignment <- function(assignmentName) {
  templateRepoName <- paste0(ghorg, "/", assignmentName, "-template")
  stopifnot(repo_exists(templateRepoName))
  roster_withteams %>%
    filter(assignment == assignmentName) %>%
    select(github, team) %>%
    # Add the staff
    bind_rows(tibble(github = c("kcarnold", "kimyejae"), team = paste0(assignmentName, "-staff"))) %>%
    mutate(
      repo_base = team,
      repo_full = paste0(ghorg, "/", repo_base)
    ) %>%
    {
      org_create_assignment(
        org = ghorg,
        user = .$github,
        repo = .$repo_base,
        team = .$team,
        source_repo = templateRepoName
      )
    }
}
# pushTeamAssignment("lab07")
```


# Harvest Student Work

```{r}
all_repos <- org_repos(ghorg)
```

Maintain local clones of all student repos:

```{r}
local_repo_status <- tibble(repo_full = all_repos) %>%
  separate(repo_full, c(NA, "repo"), "/", remove = FALSE) %>%
  mutate(
    repo_url = glue("https://github.com/{repo_full}"),
    local_path = fs::path_expand(file.path("../fa20/all_repos", repo)) %>% fs::path_abs() %>% as.character(),
    exists = file.exists(local_path)
  )
```

Check out missing repos:

```{r checkout-missing-repos}
local_repo_status %>%
  filter(!exists) %>%
  select(repo_url, local_path) %>%
  pwalk(function(repo_url, local_path) {
    purrr::safely(gert::git_clone)(url = repo_url, path = local_path, branch = "master", verbose = TRUE)
  })
```


```{r}
updateLocalClones <- function(assignment_to_update) {
  updatesToDo <-
    local_repo_status %>%
    filter(exists, str_detect(repo, assignment_to_update))
  updateStatus <-
    updatesToDo %>%
    pull(local_path) %>%
    map(local_repo_pull)

  updatesToDo %>%
    mutate(update_failed = !(updateStatus %>% map(list(1, "error")) %>% map_lgl(is_null))) %>%
    filter(update_failed) %>%
    select(repo, local_path)
}
```

Get all students who are on all repos

```{r}
get_collaborators_by_assignment <- function(assignment) {
  all_repos %>%
    keep(~ str_detect(., assignment)) %>%
    map_dfr(~ repo_collaborators(.x, include_admins = FALSE))
}
cached_collaborators <- function(assignment) {
  evalWithMemoization(
    {
      get_collaborators_by_assignment(assignment)
    },
    key = assignment
  )
}
cached_collaborators("lab04")
```

```{r lookup-names}
local_repo_owners <- tibble(assignment = c("hw01", "hw02", "hw03", "hw04", "hw09", "lab01", "lab02", "lab03", "lab04", "lab05", "datavis", "proj")) %>%
  rowwise() %>%
  mutate(collaborators = list(cached_collaborators(assignment))) %>%
  unnest(collaborators) %>%
  select(-c(pull, push, admin)) %>%
  full_join(
    local_repo_status %>% rename(repo_short = repo, repo = repo_full),
    by = c("repo")
  ) %>%
  left_join(
    roster,
    by = c("username" = "github")
  ) %>%
  select(repo_short, assignment, local_path, name = preferred_full_name)
```

Make links to each student's work.

```{r}
local_repo_owners %>%
  drop_na() %>%
  pwalk(function(repo_short, assignment, local_path, name) {
    user_path <- fs::path_wd(paste0("../fa20/", name))
    fs::dir_create(user_path)
    fs::link_create(
      path = local_path,
      new_path = file.path(user_path, repo_short)
    )
  })
```


Make a table for everyone's work.

```{r collect-repo-data}
repos_display <- local_repo_owners %>%
  mutate(
    repo_url = glue("https://github.com/{ghorg}/{repo_short}"),
    pr_url = glue("{repo_url}/pull/1/files"),
  ) %>%
  rowwise() %>%
  mutate(html = paste0(
    {
      files <- Sys.glob(file.path(local_path, "*.html"))
      bn <- basename(files)
      glue("[{bn}]({files})")
    },
    collapse = ", "
  )) %>%
  mutate(
    md = glue("[{repo_short}]({repo_url}) ([feedback]({pr_url})) {html}")
  )
```

```{r}
openStudentWork <- function(assignment, name) {
  repos <- local_repo_owners %>%
    filter(assignment == !!assignment, str_detect(name, coll(!!name, ignore_case = TRUE)))
  stopifnot(nrow(repos) == 1)

  files <- Sys.glob(file.path(repos$local_path, "*.Rmd"))

  stopifnot(length(files) == 1)

  usethis::edit_file(files)
}
# openStudentWork("datavis", "Wang")
```



## By assignment

```{r results='asis'}
repos_display %>%
  mutate(
    md = glue("* {name}: {md}")
  ) %>%
  group_by(assignment) %>%
  summarize(md = paste0(c("### ", first(assignment), "\n", paste0(md, collapse = "\n"), "\n\n"), collapse = ""), .groups = "drop") %>%
  pull(md) %>%
  cat(sep = "\n")
```

## By Student

```{r results='asis'}
repos_display %>%
  group_by(name) %>%
  summarize(md = paste0(c("* ", first(name), ": ", paste0(md, collapse = ", ")), collapse = ""), .groups = "drop") %>%
  pull(md) %>%
  cat(sep = "\n")
```


## Feedback PRs

A feedback PR is a PR from `master` into a branch called `feedback`, which refs the
template code.

To make them:

1. Identify the appropriate ref for the `feedback` branch based on the earliest commit from the local checkout.
2. Create the `feedback` branch on the repo.
3. Open a PR.

```{r eval=FALSE}
createFeedbackPRs <- function(assignment) {
  all_repos %>%
    purrr::keep(~ str_detect(., assignment)) %>%
    purrr::walk(function(full_repo) {
      owner <- ghclass:::get_repo_owner(full_repo)
      repo <- ghclass:::get_repo_name(full_repo)
      # Find the first commit hash
      first_commit_sha <- local_repo_status %>%
        filter(repo == !!repo) %>%
        pull(local_path) %>%
        gert::git_log(repo = .) %>%
        slice_tail(n = 1) %>%
        pull(commit)
      # Create the branch
      res <- purrr::safely(ghclass:::ghclass_api_v3_req)("POST /repos/:owner/:repo/git/refs",
        owner = ghorg, repo = repo,
        ref = paste0("refs/heads/", "feedback"), sha = first_commit_sha)
      ghclass:::status_msg(res, fail = "Failed to create feedback branch for repo {.val {repo}}.")
    })

  make_pr_body <- function(repo) {
    subscribers <- cached_collaborators(repo) %>%
      filter(repo == paste0(ghorg, "/", !!repo)) %>%
      pull(username) %>%
      map_chr(~ paste0("@", .)) %>%
      paste0(collapse = ", ")
    paste0("This is a place for the course staff to leave feedback on your work. It will update automatically. **Don't close or merge this pull request** unless instructed to do so by your instructor.\n\nSubscribed: ", subscribers)
  }

  all_repos %>%
    purrr::keep(~ str_detect(., assignment)) %>%
    purrr::walk(function(full_repo) {
      owner <- ghclass:::get_repo_owner(full_repo)
      repo <- ghclass:::get_repo_name(full_repo)
      pr_body <- make_pr_body(repo)
      ghclass::pr_create(paste0(ghorg, "/", repo), "Feedback", head = "master", base = "feedback", body = pr_body)
    })
}
```

## Final Projects

### Make teams


```{r}
final_proj_teams_raw <- read_csv("../fa20/final-projects-2.csv", col_types = cols_only(
  `Student Name` = col_character(),
  `Team Name` = col_character()
)) %>% janitor::clean_names()
```

```{r}
final_proj_teams <- final_proj_teams_raw %>%
  mutate(team_name = str_trim(team_name)) %>% 
  filter(team_name != "(No Submission)") %>% 
  left_join(roster %>% select(student_name, github, last_name), by = "student_name") %>%
  mutate(team_name = case_when(
    team_name == "N/A" ~ last_name,
    str_detect(team_name, "TBD") ~ last_name,
    str_detect(team_name, r"((\w+) / (\w+))") ~ team_name,
    team_name == "(Open to have a Partner)" ~ last_name
)) %>% mutate(
  team_name = team_name %>% 
    str_replace_all("/", "-") %>% 
    str_replace_all("[^-A-Za-z0-9]", "")
)
final_proj_teams
# For Moodle
final_proj_teams %>% select(groupname = team_name) %>% distinct(groupname) %>% write_csv("../fa20/final-project-groupnames.csv")
```

```{r}
roster %>% count(last_name) %>% filter(n > 1)
```

```{r}
final_proj_teams %>% 
  group_by(team_name) %>% 
  summarize(members = str_c(student_name, collapse = ", ")) %>% 
  mutate(breakout = (row_number() - 1) %% 5 + 1) %>% 
  write_csv("../fa20/final-project-group-members.csv")
```



```{r eval=FALSE}
org_create_assignment(
  org = ghorg,
  user = final_proj_teams$github,
  repo = paste0("proj", "-", final_proj_teams$team_name),
  team = final_proj_teams$team_name,
  source_repo = paste0(ghorg, "/", "proj", "-template")
)
```

Fixup final proj teams

```{r eval=FALSE}
tribble(
  ~student_name, ~team_name,
  "Danish Ansari", "Ansari",
  "Kaitlyn E. Westra", "Westra",
  "Matthew C. Lobbes", "Lobbes-Padilla",
  "Richard A. Padilla", "Lobbes-Padilla"
) %>% 
  left_join(roster %>% select(student_name, github), by = "student_name") %>% {
  org_create_assignment(
    org = ghorg,
    user = .$github,
    repo = paste0("proj-", .$team_name),
    team = .$team_name,
    source_repo = paste0(ghorg, "/", "proj", "-template")
  )
}
```

