<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Classification</title>
    <meta charset="utf-8" />
    <meta name="author" content="K Arnold" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Classification
### K Arnold

---




## Objectives

* Apply the `tidymodels` pipeline to a classification task
* Identify when validation is necessary to believe an outcome
* Apply the concepts of sensitivity and specificity

(punted to next time:)
* Identify corresponding elements between R and Python data wrangling and modeling workflows

---

## Outline

* Problem introduction
  * Data wrangling in R
* Classification workflow
  * Models: decision tree, logistic regression
  * Model outputs: scores and decisions
  * Model metrics: accuracy, sensitivity, specificity
  * Validation


&lt;!-- If time permits... --&gt;

&lt;!-- * Python --&gt;
&lt;!--   * Data wrangling with Pandas --&gt;
&lt;!--   * scikit-learn model API: construct, fit, predict --&gt;
&lt;!--   * scikit-learn modeling pipelines --&gt;

---

## Logistics notes

* Discussion on fairness definitions posted, due next Tuesday.
* Your **project** should be
  * **Interesting**: not every project will go into depth in every aspect (e.g., some won't have 
    much data wrangling), but all projects should be interesting in *some* aspect.
  * **Your own**: examples abound on the Internet. Following a tutorial is a
    very boring project. Adapting its approach to a new dataset or question? Interesting.

---

## Setup


```r
library(tidyverse)
library(tidymodels)
library(ggridges)
```




---

## Can a blood test diagnose autism?

We'll use an example from &lt;https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1005385&gt;



```r
data_filename &lt;- "data/autism.csv"
if (!file.exists(data_filename)) {
  dir.create("data")
  download.file("https://doi.org/10.1371/journal.pcbi.1005385.s001", data_filename)
}
```


```r
col_names &lt;- names(read_csv(data_filename, n_max = 1, col_types = cols(.default = col_character())))
autism &lt;- read_csv(data_filename, skip = 2, col_names = col_names, col_types = cols(
  .default = col_double(),
  Group = col_character()
)) %&gt;% mutate(
  Group = as_factor(Group)
)
```

---

We have 3 kinds of data about 206 children:

1. The outcome (`Group`): ASD (diagnosed with ASD), SIB (sibling not diagnosed with ASD), and NEU (age-matched neurotypical children, for control)


```r
autism %&gt;% group_by(Group) %&gt;% summarize(n = n()) %&gt;% kable()
```



|Group |  n|
|:-----|--:|
|ASD   | 83|
|NEU   | 76|
|SIB   | 47|

---

1. The outcome (`Group`): ASD, SIB, NEU
2. Concentrations of various metabolites in a blood sample:


```r
autism %&gt;% select(-1, -last_col())
```

```
## # A tibble: 206 x 24
##   Methion.   SAM   SAH `SAM/SAH` `% DNA methylat… `8-OHG` Adenosine Homocysteine Cysteine
##      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;            &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt;    &lt;dbl&gt;
## 1     17.3  56.2 15.2       3.69             3.35   0.055     0.103         4.48     215.
## 2     14.9  37.2  7.58      4.91             3.04   0.045     0.055         4.31     163.
## 3     15.9  37.9  9.87      3.84             2.81   0.058     0.071         6.21     159.
## 4     18.7  79.2 24.5       3.23             4.24   0.085     0.079         7.15     226.
## 5     21.5  77.6 19.2       4.04             3.49   0.041     0.058         3.82     201.
## 6     18.1  67.6 12.8       5.30             3.01   0.156     0.091         4.03     205.
## # … with 200 more rows, and 15 more variables: `Glu.-Cys.` &lt;dbl&gt;, `Cys.-Gly.` &lt;dbl&gt;, tGSH &lt;dbl&gt;,
## #   fGSH &lt;dbl&gt;, GSSG &lt;dbl&gt;, `fGSH/GSSG` &lt;dbl&gt;, `tGSH/GSSG` &lt;dbl&gt;, Chlorotyrosine &lt;dbl&gt;,
## #   Nitrotyrosine &lt;dbl&gt;, Tyrosine &lt;dbl&gt;, Tryptophane &lt;dbl&gt;, fCystine &lt;dbl&gt;, fCysteine &lt;dbl&gt;,
## #   `fCystine/fCysteine` &lt;dbl&gt;, `% oxidized` &lt;dbl&gt;
```

---

1. The outcome (`Group`): ASD, SIB, NEU
2. Concentrations of various metabolites in a blood sample
3. For the ASD children only, a measure of life skills ("Vineland ABC")


```r
autism %&gt;% 
  ggplot(aes(x = `Vineland ABC`, y = Group)) + geom_boxplot()
```

```
## Warning: Removed 159 rows containing non-finite values (stat_boxplot).
```

&lt;img src="w11d2-classification_files/figure-html/show-behavior-score-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

## Exploratory Data Analysis (EDA)

What do these metabolites look like?

&lt;img src="w11d2-classification_files/figure-html/bad-metabolite-plot-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

code for the previous plot:

```r
autism %&gt;%
  select(-`Vineland ABC`) %&gt;% 
  pivot_longer(-Group, names_to = "Measure") %&gt;% 
  ggplot(aes(x = value, y = Measure)) +
  geom_density_ridges() + 
  facet_wrap(vars(Group), scales = "free_x")
```

---

## EDA

Better question: **Can these metabolites help us distinguish autism?**

---

&lt;img src="w11d2-classification_files/figure-html/ridgeplot-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

code for previous plot:


```r
autism %&gt;%
  select(-`Vineland ABC`) %&gt;% 
  pivot_longer(-Group, names_to = "Measure") %&gt;% 
  ggplot(aes(x = value, y = Group)) +
  geom_density_ridges() +
  facet_wrap(vars(Measure), scales = "free_x") + 
  theme_ridges()
```

---

## Can we predict ASD vs non-ASD from metabolites?

* Let's start by (1) ignoring the behavior scores (that's an *outcome*) and comparing
just ASD and NEU.
* We need to drop SIB... and tell the model that we don't actually care about it.


```r
data &lt;- 
  autism %&gt;% 
  select(-`Vineland ABC`) %&gt;% 
  filter(Group != "SIB") %&gt;% 
  mutate(Group = factor(Group))
```

---

## Decision Tree *Classification*


```r
spec &lt;- workflow() %&gt;% add_recipe(
* recipe(Group ~ ., data = data)) %&gt;%
* add_model(decision_tree(mode = "classification") %&gt;% set_engine("rpart"))
model &lt;- spec %&gt;% fit(data)
```


&lt;img src="w11d2-classification_files/figure-html/show-tree-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

### What do the *predictions* look like?


```r
model %&gt;% predict(data, type = "prob")
```

```
## # A tibble: 159 x 2
##   .pred_ASD .pred_NEU
##       &lt;dbl&gt;     &lt;dbl&gt;
## 1     0.959    0.0411
## 2     0.959    0.0411
## 3     0.959    0.0411
## 4     0.959    0.0411
## 5     0.959    0.0411
## 6     0.959    0.0411
## # … with 153 more rows
```

---

### Were those predictions *good*?

.small-code[

```r
model %&gt;%
  predict(data, type = "prob") %&gt;%
  bind_cols(data) %&gt;% 
  mutate(idx = row_number()) %&gt;% 
  ggplot(aes(x = idx, y = .pred_ASD, color = Group, shape = Group)) +
  geom_hline(yintercept = .5) +
  geom_point() 
```

&lt;img src="w11d2-classification_files/figure-html/plot-predicted-probs-tree-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---

### Quantifying that:


```r
metrics &lt;- yardstick::metric_set(accuracy, sensitivity, specificity)
model %&gt;% 
  predict(data, type = "class") %&gt;% 
  bind_cols(data) %&gt;% 
  metrics(truth = Group, estimate = .pred_class)
```

```
## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.912
## 2 sens     binary         0.928
## 3 spec     binary         0.895
```

---

## Recall from Week 6...

|                      | Seizure happened              | No seizure happened           |
|----------------------|-------------------------------|-------------------------------|
| Seizure predicted    | True positive                 | False positive (Type 1 error) |
| No seizure predicted | False negative (Type 2 error) | True negative                 |

--
- **Accuracy** (% correct) = (TP + TN) / (# episodes)
- **False negative** ("miss") **rate** = FN / (# actual seizures)
- **False positive** ("false alarm") **rate** = FP / (# true non-seizures)

--
- **Sensitivity** ("true positive rate") = TP / (# actual seizures)
  - Sensitivity = 1 − False negative rate
- **Specificity** ("true negative rate") = TN / (# actual seizures)
  - Specificity = 1 − False positive rate
- [Wikipedia article](https://en.wikipedia.org/wiki/Sensitivity_and_specificity)


---

class: center, middle

## Logistic Regression

---

## Logistic Regression


```r
spec &lt;- workflow() %&gt;% add_recipe(
* recipe(Group ~ ., data = data)) %&gt;%
* add_model(logistic_reg(penalty = .001) %&gt;% set_engine("glmnet"))
model &lt;- spec %&gt;% fit(data)
```

.small-code[

```r
model %&gt;% pull_workflow_fit() %&gt;% pluck('fit') %&gt;% coef(s = .1) %&gt;% as.matrix() %&gt;% as_tibble(rownames = "name") %&gt;% 
  rename(coef = 2) %&gt;% filter(abs(coef) &gt; .01) %&gt;% 
  ggplot(aes(x = coef, y = fct_reorder(name, coef, abs))) + geom_col()
```

&lt;img src="w11d2-classification_files/figure-html/vis-logisticreg-model-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---


```r
model %&gt;% predict(data, type = "prob")
```

```
## # A tibble: 159 x 2
##   .pred_ASD    .pred_NEU
##       &lt;dbl&gt;        &lt;dbl&gt;
## 1     0.912 0.0876      
## 2     0.999 0.000964    
## 3     1.00  0.0000000524
## 4     1.00  0.0000000369
## 5     0.988 0.0124      
## 6     1.00  0.0000222   
## # … with 153 more rows
```

---

### Are those predictions good?

.small-code[

```r
model %&gt;%
  predict(data, type = "prob") %&gt;%
  bind_cols(data) %&gt;% 
  mutate(idx = row_number()) %&gt;% 
  ggplot(aes(x = idx, y = .pred_ASD, color = Group, shape = Group)) +
  geom_hline(yintercept = .5) +
  geom_point() 
```

&lt;img src="w11d2-classification_files/figure-html/plot-predicted-probs-linreg-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]

---

### Quantifying that...


```r
model %&gt;% 
  predict(data, type = "class") %&gt;% 
  bind_cols(data) %&gt;% 
  metrics(truth = Group, estimate = .pred_class)
```

```
## # A tibble: 3 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary             1
## 2 sens     binary             1
## 3 spec     binary             1
```


---

## Cross validation!

Stratify by `group` to ensure each fold has good representation.


```r
resamples &lt;- data %&gt;% vfold_cv(v = 10, strata = Group)
```



```r
cv_results &lt;- spec %&gt;% 
  fit_resamples(resamples, metrics = metrics)
```

---


```r
cv_results %&gt;% 
  collect_metrics(summarize = FALSE) %&gt;% 
  ggplot(aes(x = .estimate, y = .metric)) + geom_boxplot()
```

&lt;img src="w11d2-classification_files/figure-html/cv-results-logreg-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

## Cross-validate the decision tree


```r
spec &lt;- workflow() %&gt;% add_recipe(
* recipe(Group ~ ., data = data)) %&gt;%
* add_model(decision_tree(mode = "classification") %&gt;% set_engine("rpart"))

cv_results &lt;- spec %&gt;% 
  fit_resamples(resamples, metrics = metrics)
```


```r
cv_results %&gt;% 
  collect_metrics(summarize = FALSE) %&gt;% 
  ggplot(aes(x = .estimate, y = .metric)) + geom_boxplot()
```

&lt;img src="w11d2-classification_files/figure-html/cv-results-tree-1.png" width="100%" style="display: block; margin: auto;" /&gt;

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
