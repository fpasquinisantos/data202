<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Grammar of Data Transformation</title>
    <meta charset="utf-8" />
    <meta name="author" content="K Arnold, based on IntroDS.org" />
    <script src="libs/header-attrs-2.3/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Grammar of Data Transformation
### K Arnold, based on IntroDS.org

---




## Week 3

* Lab 2 end-of-day today
* Discussion 1 replies by tomorrow
* Hw 2 due Wednesday
  * Check that your `.md` file is on GitHub
  * What does each row represent?
  * How many rows *should* there be?
* Office Hours: [kca] Mon 8-9am, Fri 3-4pm; [yk] Wed 4:30-5:30pm

---

## Question-answers

&gt; Am I submitting my labs and homework correctly?

* See checklist at end of Lab 1.
* Main point: Check your `.md` file on GitHub.

&gt; When will we get feedback?

* General feedback already given in class.
* A bit backed up on specific feedback.

&gt; Can we make animated plots like in the video/

* Stay tuned for Plotly.

---

## Questions for you

- How is week 3 of Fall 2020?
- What's working well in DATA 202? What's challenging?

--


- How are the readings and prep exercises?
- How long are you spending on labs outside of class?
- How hard are labs compared with homework?


---

## So far

* *R/RStudio/Rmarkdown/Git*: a toolkit for reproducible collaborative analysis and reporting
* `ggplot2`: a *Grammar of Graphics*
  * a language for describing, and building, visualizations
  * concepts apply to many other toolkits

This week:

* `dplyr`: a *Grammar of Data Transformation*
  * basic concepts will show up again in Python (Pandas) and SQL.

---

class: center, middle

# Data wrangling and summarizing&lt;br&gt; with *dplyr*

---

## A grammar of data wrangling

Functions as verbs that manipulate data frames

.pull-left[
&lt;img src="img/dplyr-part-of-tidyverse.png" width="80%" style="display: block; margin: auto;" /&gt;
]
.pull-right[
.midi[
- `select`: pick columns by name
- `arrange`: reorder rows
- `slice`: pick rows by index(es)
- `slice_sample`: randomly sample rows
- `filter`: pick rows matching criteria
- `distinct`: filter for unique rows
- `mutate`: add new variables
- `summarize`: reduce variables to values
- `pull`: grab a column as a vector
- ... (many more)
]
]

---

## Rules of *dplyr* functions

- First argument is *always* a data frame
- Subsequent arguments say what to do with that data frame
- Always return a data frame
- Don't modify in place

---

## Bike crashes in NC 2007 - 2014




```r
ncbikecrash &lt;- read_csv("data/ncbikecrash.csv")
```


```r
glimpse(ncbikecrash)
```

```
## Rows: 7,467
## Columns: 53
## $ object_id            &lt;dbl&gt; 1686, 1674, 1673, 1687, 1653, 1665, 1642, 1675, …
## $ city                 &lt;chr&gt; "None - Rural Crash", "Henderson", "None - Rural…
## $ county               &lt;chr&gt; "Wayne", "Vance", "Lincoln", "Columbus", "New Ha…
## $ region               &lt;chr&gt; "Coastal", "Piedmont", "Piedmont", "Coastal", "C…
## $ development          &lt;chr&gt; "Farms, Woods, Pastures", "Residential", "Farms,…
## $ locality             &lt;chr&gt; "Rural (&lt;30% Developed)", "Mixed (30% To 70% Dev…
## $ on_road              &lt;chr&gt; "SR 1915", "NICHOLAS ST", "US 321", "W BURKHEAD …
## $ rural_urban          &lt;chr&gt; "Rural", "Urban", "Rural", "Urban", "Urban", "Ru…
## $ speed_limit          &lt;chr&gt; "50 - 55  MPH", "30 - 35  MPH", "50 - 55  MPH", …
## $ traffic_control      &lt;chr&gt; "No Control Present", "Stop Sign", "Double Yello…
## $ weather              &lt;chr&gt; "Clear", "Clear", "Clear", "Rain", "Clear", "Clo…
## $ workzone             &lt;chr&gt; "No", "No", "No", "No", "No", "No", "No", "No", …
## $ bike_age             &lt;chr&gt; "52", "66", "33", "52", "22", "15", "41", "14", …
## $ bike_age_group       &lt;chr&gt; "50-59", "60-69", "30-39", "50-59", "20-24", "11…
## $ bike_alcohol         &lt;chr&gt; "No", "No", "No", "Yes", "No", "No", "No", "No",…
## $ bike_alcohol_drugs   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ bike_direction       &lt;chr&gt; "With Traffic", "With Traffic", "With Traffic", …
## $ bike_injury          &lt;chr&gt; "B: Evident Injury", "C: Possible Injury", "C: P…
## $ bike_position        &lt;chr&gt; "Bike Lane / Paved Shoulder", "Travel Lane", "Tr…
## $ bike_race            &lt;chr&gt; "Black", "Black", "White", "Black", "White", "Na…
## $ bike_sex             &lt;chr&gt; "Male", "Male", "Male", "Male", "Female", "Male"…
## $ driver_age           &lt;chr&gt; "34", NA, "37", "55", "25", "17", NA, "50", "32"…
## $ driver_age_group     &lt;chr&gt; "30-39", NA, "30-39", "50-59", "25-29", "0-19", …
## $ driver_alcohol       &lt;chr&gt; "No", "Missing", "No", "No", "No", "No", "Missin…
## $ driver_alcohol_drugs &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, …
## $ driver_est_speed     &lt;chr&gt; "51-55 mph", "6-10 mph", "41-45 mph", "11-15 mph…
## $ driver_injury        &lt;chr&gt; "O: No Injury", "Unknown Injury", "O: No Injury"…
## $ driver_race          &lt;chr&gt; "White", "Unknown/Missing", "Hispanic", "Black",…
## $ driver_sex           &lt;chr&gt; "Male", NA, "Female", "Male", "Male", "Female", …
## $ driver_vehicle_type  &lt;chr&gt; "Single Unit Truck (2-Axle, 6-Tire)", NA, "Passe…
## $ crash_alcohol        &lt;chr&gt; "No", "No", "No", "Yes", "No", "No", "No", "No",…
## $ crash_date           &lt;chr&gt; "11DEC2013", "20NOV2013", "03NOV2013", "14DEC201…
## $ crash_day            &lt;chr&gt; "Wednesday", "Wednesday", "Sunday", "Saturday", …
## $ crash_group          &lt;chr&gt; "Motorist Overtaking Bicyclist", "Bicyclist Fail…
## $ crash_hour           &lt;dbl&gt; 6, 20, 18, 18, 13, 17, 17, 7, 15, 2, 12, 22, 12,…
## $ crash_location       &lt;chr&gt; "Non-Intersection", "Intersection", "Non-Interse…
## $ crash_month          &lt;chr&gt; "December", "November", "November", "December", …
## $ crash_severity       &lt;chr&gt; "B: Evident Injury", "C: Possible Injury", "C: P…
## $ crash_time           &lt;time&gt; 06:10:00, 20:41:00, 18:05:00, 18:34:00, 13:27:0…
## $ crash_type           &lt;chr&gt; "Motorist Overtaking - Undetected Bicyclist", "B…
## $ crash_year           &lt;dbl&gt; 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, …
## $ ambulance_req        &lt;chr&gt; "Yes", "No", "Yes", "Yes", "Yes", "Yes", "Yes", …
## $ hit_run              &lt;chr&gt; "No", "Yes", "No", "No", "No", "No", "Yes", "No"…
## $ light_condition      &lt;chr&gt; "Dark - Roadway Not Lighted", NA, "Dark - Roadwa…
## $ road_character       &lt;chr&gt; "Straight - Level", "Straight - Level", "Straigh…
## $ road_class           &lt;chr&gt; "State Secondary Route", "Local Street", "US Rou…
## $ road_condition       &lt;chr&gt; "Dry", "Dry", "Dry", "Water (Standing, Moving)",…
## $ road_configuration   &lt;chr&gt; "Two-Way, Not Divided", "Two-Way, Divided, Unpro…
## $ road_defects         &lt;chr&gt; "None", NA, "None", "None", "None", "None", "Non…
## $ road_feature         &lt;chr&gt; "No Special Feature", "T-Intersection", "No Spec…
## $ road_surface         &lt;chr&gt; "Coarse Asphalt", "Smooth Asphalt", "Smooth Asph…
## $ num_lanes            &lt;chr&gt; "2 lanes", "2 lanes", "2 lanes", "1 lane", "8 la…
## $ geo_point            &lt;chr&gt; "35.3336070056, -77.9955023901", "36.3151872016,…
```


---

## Variables

View the names of variables via

```r
names(ncbikecrash)
```

```
##  [1] "object_id"            "city"                 "county"              
##  [4] "region"               "development"          "locality"            
##  [7] "on_road"              "rural_urban"          "speed_limit"         
## [10] "traffic_control"      "weather"              "workzone"            
## [13] "bike_age"             "bike_age_group"       "bike_alcohol"        
## [16] "bike_alcohol_drugs"   "bike_direction"       "bike_injury"         
## [19] "bike_position"        "bike_race"            "bike_sex"            
## [22] "driver_age"           "driver_age_group"     "driver_alcohol"      
## [25] "driver_alcohol_drugs" "driver_est_speed"     "driver_injury"       
## [28] "driver_race"          "driver_sex"           "driver_vehicle_type" 
## [31] "crash_alcohol"        "crash_date"           "crash_day"           
## [34] "crash_group"          "crash_hour"           "crash_location"      
## [37] "crash_month"          "crash_severity"       "crash_time"          
## [40] "crash_type"           "crash_year"           "ambulance_req"       
## [43] "hit_run"              "light_condition"      "road_character"      
## [46] "road_class"           "road_condition"       "road_configuration"  
## [49] "road_defects"         "road_feature"         "road_surface"        
## [52] "num_lanes"            "geo_point"
```

and see detailed descriptions [here](https://introds.org/hw/hw-02/hw-02-bike-crash.html).

---

## Select columns

.midi[

```r
select(ncbikecrash, county, bike_age)
```

```
## # A tibble: 7,467 x 2
##    county      bike_age
##    &lt;chr&gt;       &lt;chr&gt;   
##  1 Wayne       52      
##  2 Vance       66      
##  3 Lincoln     33      
##  4 Columbus    52      
##  5 New Hanover 22      
##  6 Robeson     15      
##  7 Richmond    41      
##  8 Wake        14      
##  9 Columbus    16      
## 10 Craven      54      
## # … with 7,457 more rows
```
]

--

.question[
What if we wanted to select these columns, and then arrange the data in ascending order of biker age?
]

---

## Data wrangling, step-by-step

.midi[
.pull-left[
Select:

```r
ncbikecrash %&gt;%
  select(county, bike_age)
```

```
## # A tibble: 7,467 x 2
##    county      bike_age
##    &lt;chr&gt;       &lt;chr&gt;   
##  1 Wayne       52      
##  2 Vance       66      
##  3 Lincoln     33      
##  4 Columbus    52      
##  5 New Hanover 22      
##  6 Robeson     15      
##  7 Richmond    41      
##  8 Wake        14      
##  9 Columbus    16      
## 10 Craven      54      
## # … with 7,457 more rows
```
]
.pull-right[
Select, then arrange:

```r
ncbikecrash %&gt;%
  select(county, bike_age) %&gt;%
  arrange(bike_age)
```

```
## # A tibble: 7,467 x 2
##    county      bike_age
##    &lt;chr&gt;       &lt;chr&gt;   
##  1 New Hanover 0       
##  2 Carteret    1       
##  3 Guilford    1       
##  4 Pitt        10      
##  5 Cumberland  10      
##  6 Carteret    10      
##  7 Hoke        10      
##  8 Martin      10      
##  9 New Hanover 10      
## 10 Onslow      10      
## # … with 7,457 more rows
```
]
]

---

class: center, middle

# Pipes

---

## What is a pipe?

In programming, a pipe is a technique for passing information from one process to another.

--

.pull-left[
- Start with the data frame `ncbikecrash`
]
.pull-right[

```r
*ncbikecrash %&gt;%
  select(county, bike_age) %&gt;%
  arrange(bike_age)
```

```
## # A tibble: 7,467 x 2
##    county      bike_age
##    &lt;chr&gt;       &lt;chr&gt;   
##  1 New Hanover 0       
##  2 Carteret    1       
##  3 Guilford    1       
##  4 Pitt        10      
##  5 Cumberland  10      
##  6 Carteret    10      
##  7 Hoke        10      
##  8 Martin      10      
##  9 New Hanover 10      
## 10 Onslow      10      
## # … with 7,457 more rows
```
]

---

## What is a pipe?

In programming, a pipe is a technique for passing information from one process to another.

.pull-left[
- Start with the data frame `ncbikecrash`,
- then we `select` the variables `county` and `bike_age`,
]
.pull-right[

```r
ncbikecrash %&gt;%
* select(county, bike_age) %&gt;%
  arrange(bike_age)
```

```
## # A tibble: 7,467 x 2
##    county      bike_age
##    &lt;chr&gt;       &lt;chr&gt;   
##  1 New Hanover 0       
##  2 Carteret    1       
##  3 Guilford    1       
##  4 Pitt        10      
##  5 Cumberland  10      
##  6 Carteret    10      
##  7 Hoke        10      
##  8 Martin      10      
##  9 New Hanover 10      
## 10 Onslow      10      
## # … with 7,457 more rows
```
]

---

## What is a pipe?

In programming, a pipe is a technique for passing information from one process to another.

.pull-left[
- Start with the data frame `ncbikecrash`,
- then we `select` the variables `county` and `bike_age`,
- and then we `arrange` the data frame by `bike_age` in ascending order.
]
.pull-right[

```r
ncbikecrash %&gt;%
  select(county, bike_age) %&gt;%
* arrange(bike_age)
```

```
## # A tibble: 7,467 x 2
##    county      bike_age
##    &lt;chr&gt;       &lt;chr&gt;   
##  1 New Hanover 0       
##  2 Carteret    1       
##  3 Guilford    1       
##  4 Pitt        10      
##  5 Cumberland  10      
##  6 Carteret    10      
##  7 Hoke        10      
##  8 Martin      10      
##  9 New Hanover 10      
## 10 Onslow      10      
## # … with 7,457 more rows
```
]

---

## How does a pipe work?

Conventional (nested functions):


```r
arrange(select(ncbikecrash, county, bike_age), bike_age)
```

With pipes:


```r
ncbikecrash %&gt;%
  select(county, bike_age) %&gt;%
  arrange(bike_age)
```

---

## What about other arguments?

Use the dot (`.`) to

- send results to a function argument other than first one or 
- use the previous result for multiple arguments


```r
starwars %&gt;%
  filter(., species == "Human") %&gt;%
* lm(mass ~ height, data = .)
```

```
## 
## Call:
## lm(formula = mass ~ height, data = .)
## 
## Coefficients:
## (Intercept)       height  
##     -116.58         1.11
```

---

## A note on piping and layering

- The `%&gt;%` operator in **dplyr** functions is called the *pipe* operator. This means you "pipe" the output of the previous line of code as the first input of the next line of code.
- The `+` operator in **ggplot2** functions is used for "*layering*". This means you create the plot in layers, separated by `+`.
- Many of the styling principles are consistent across `%&gt;%` and `+`:
  - always a space before
  - always a line break after (for pipelines with more than 2 lines)

---

class: center, middle

# Data wrangling with dplyr

---

class: center, middle

[Exercise: Hotel Wrangling](https://rsconnect.calvin.edu:3939/content/105)

---

## `select` to keep variables


```r
ncbikecrash %&gt;%
* select(locality, speed_limit)
```

```
## # A tibble: 7,467 x 2
##    locality                     speed_limit 
##    &lt;chr&gt;                        &lt;chr&gt;       
##  1 Rural (&lt;30% Developed)       50 - 55  MPH
##  2 Mixed (30% To 70% Developed) 30 - 35  MPH
##  3 Rural (&lt;30% Developed)       50 - 55  MPH
##  4 Urban (&gt;70% Developed)       30 - 35  MPH
##  5 Urban (&gt;70% Developed)       &lt;NA&gt;        
##  6 Rural (&lt;30% Developed)       50 - 55  MPH
##  7 Mixed (30% To 70% Developed) 30 - 35  MPH
##  8 Urban (&gt;70% Developed)       30 - 35  MPH
##  9 Rural (&lt;30% Developed)       30 - 35  MPH
## 10 Urban (&gt;70% Developed)       20 - 25  MPH
## # … with 7,457 more rows
```

---

## `select` to exclude variables


```r
ncbikecrash %&gt;%
* select(-object_id)
```

```
## # A tibble: 7,467 x 52
##    city  county region development locality on_road rural_urban speed_limit
##    &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt;      
##  1 None… Wayne  Coast… Farms, Woo… Rural (… SR 1915 Rural       50 - 55  M…
##  2 Hend… Vance  Piedm… Residential Mixed (… NICHOL… Urban       30 - 35  M…
##  3 None… Linco… Piedm… Farms, Woo… Rural (… US 321  Rural       50 - 55  M…
##  4 Whit… Colum… Coast… Commercial  Urban (… W BURK… Urban       30 - 35  M…
##  5 Wilm… New H… Coast… Residential Urban (… RACINE… Urban       &lt;NA&gt;       
##  6 None… Robes… Coast… Farms, Woo… Rural (… SR 1513 Rural       50 - 55  M…
##  7 None… Richm… Piedm… Residential Mixed (… SR 1903 Rural       30 - 35  M…
##  8 Rale… Wake   Piedm… Commercial  Urban (… PERSON… Urban       30 - 35  M…
##  9 Whit… Colum… Coast… Residential Rural (… FLOWER… Urban       30 - 35  M…
## 10 New … Craven Coast… Residential Urban (… SUTTON… Urban       20 - 25  M…
## # … with 7,457 more rows, and 44 more variables: traffic_control &lt;chr&gt;,
## #   weather &lt;chr&gt;, workzone &lt;chr&gt;, bike_age &lt;chr&gt;, bike_age_group &lt;chr&gt;,
## #   bike_alcohol &lt;chr&gt;, bike_alcohol_drugs &lt;chr&gt;, bike_direction &lt;chr&gt;,
## #   bike_injury &lt;chr&gt;, bike_position &lt;chr&gt;, bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;,
## #   driver_age &lt;chr&gt;, driver_age_group &lt;chr&gt;, driver_alcohol &lt;chr&gt;,
## #   driver_alcohol_drugs &lt;chr&gt;, driver_est_speed &lt;chr&gt;, driver_injury &lt;chr&gt;,
## #   driver_race &lt;chr&gt;, driver_sex &lt;chr&gt;, driver_vehicle_type &lt;chr&gt;,
## #   crash_alcohol &lt;chr&gt;, crash_date &lt;chr&gt;, crash_day &lt;chr&gt;, crash_group &lt;chr&gt;,
## #   crash_hour &lt;dbl&gt;, crash_location &lt;chr&gt;, crash_month &lt;chr&gt;,
## #   crash_severity &lt;chr&gt;, crash_time &lt;time&gt;, crash_type &lt;chr&gt;,
## #   crash_year &lt;dbl&gt;, ambulance_req &lt;chr&gt;, hit_run &lt;chr&gt;,
## #   light_condition &lt;chr&gt;, road_character &lt;chr&gt;, road_class &lt;chr&gt;,
## #   road_condition &lt;chr&gt;, road_configuration &lt;chr&gt;, road_defects &lt;chr&gt;,
## #   road_feature &lt;chr&gt;, road_surface &lt;chr&gt;, num_lanes &lt;chr&gt;, geo_point &lt;chr&gt;
```

---

## `select` variables with certain characteristics


```r
ncbikecrash %&gt;%
* select(starts_with("bike_"))
```

```
## # A tibble: 7,467 x 9
##    bike_age bike_age_group bike_alcohol bike_alcohol_dr… bike_direction
##    &lt;chr&gt;    &lt;chr&gt;          &lt;chr&gt;        &lt;chr&gt;            &lt;chr&gt;         
##  1 52       50-59          No           &lt;NA&gt;             With Traffic  
##  2 66       60-69          No           &lt;NA&gt;             With Traffic  
##  3 33       30-39          No           &lt;NA&gt;             With Traffic  
##  4 52       50-59          Yes          &lt;NA&gt;             &lt;NA&gt;          
##  5 22       20-24          No           &lt;NA&gt;             Facing Traffic
##  6 15       11-15          No           &lt;NA&gt;             With Traffic  
##  7 41       40-49          No           &lt;NA&gt;             Facing Traffic
##  8 14       11-15          No           &lt;NA&gt;             &lt;NA&gt;          
##  9 16       16-19          No           &lt;NA&gt;             Facing Traffic
## 10 54       50-59          No           &lt;NA&gt;             With Traffic  
## # … with 7,457 more rows, and 4 more variables: bike_injury &lt;chr&gt;,
## #   bike_position &lt;chr&gt;, bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;
```

---

## `select` variables with certain characteristics


```r
ncbikecrash %&gt;%
* select(ends_with("age"))
```

```
## # A tibble: 7,467 x 2
##    bike_age driver_age
##    &lt;chr&gt;    &lt;chr&gt;     
##  1 52       34        
##  2 66       &lt;NA&gt;      
##  3 33       37        
##  4 52       55        
##  5 22       25        
##  6 15       17        
##  7 41       &lt;NA&gt;      
##  8 14       50        
##  9 16       32        
## 10 54       69        
## # … with 7,457 more rows
```

---

## Select helpers

- `starts_with()`: Starts with a prefix
- `ends_with()`: Ends with a suffix
- `contains()`: Contains a literal string
- `num_range()`: Matches a numerical range like x01, x02, x03
- `one_of()`: Matches variable names in a character vector
- `everything()`: Matches all variables
- `last_col()`: Select last variable, possibly with an offset
- `matches()`: Matches a regular expression (a sequence of symbols/characters expressing a string/pattern to be searched for within text)

.footnote[
See help for any of these functions for more info, e.g. `?everything`.
]

---

## `arrange` in ascending / descending order

.pull-left[

```r
ncbikecrash %&gt;%
  select(ends_with("age")) %&gt;%
* arrange(bike_age)
```

```
## # A tibble: 7,467 x 2
##    bike_age driver_age
##    &lt;chr&gt;    &lt;chr&gt;     
##  1 0        47        
##  2 1        70+       
##  3 1        61        
##  4 10       30        
##  5 10       19        
##  6 10       22        
##  7 10       18        
##  8 10       27        
##  9 10       53        
## 10 10       &lt;NA&gt;      
## # … with 7,457 more rows
```
]
.pull-right[

```r
ncbikecrash %&gt;%
  select(ends_with("age")) %&gt;%
* arrange(desc(bike_age))
```

```
## # A tibble: 7,467 x 2
##    bike_age driver_age
##    &lt;chr&gt;    &lt;chr&gt;     
##  1 9        23        
##  2 9        35        
##  3 9        70+       
##  4 9        41        
##  5 9        53        
##  6 9        18        
##  7 9        45        
##  8 9        19        
##  9 9        70+       
## 10 9        59        
## # … with 7,457 more rows
```
]

---

## `slice` for certain row numbers

First five


```r
ncbikecrash %&gt;%
* slice(1:5)
```

```
## # A tibble: 5 x 53
##   object_id city  county region development locality on_road rural_urban
##       &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      
## 1      1686 None… Wayne  Coast… Farms, Woo… Rural (… SR 1915 Rural      
## 2      1674 Hend… Vance  Piedm… Residential Mixed (… NICHOL… Urban      
## 3      1673 None… Linco… Piedm… Farms, Woo… Rural (… US 321  Rural      
## 4      1687 Whit… Colum… Coast… Commercial  Urban (… W BURK… Urban      
## 5      1653 Wilm… New H… Coast… Residential Urban (… RACINE… Urban      
## # … with 45 more variables: speed_limit &lt;chr&gt;, traffic_control &lt;chr&gt;,
## #   weather &lt;chr&gt;, workzone &lt;chr&gt;, bike_age &lt;chr&gt;, bike_age_group &lt;chr&gt;,
## #   bike_alcohol &lt;chr&gt;, bike_alcohol_drugs &lt;chr&gt;, bike_direction &lt;chr&gt;,
## #   bike_injury &lt;chr&gt;, bike_position &lt;chr&gt;, bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;,
## #   driver_age &lt;chr&gt;, driver_age_group &lt;chr&gt;, driver_alcohol &lt;chr&gt;,
## #   driver_alcohol_drugs &lt;chr&gt;, driver_est_speed &lt;chr&gt;, driver_injury &lt;chr&gt;,
## #   driver_race &lt;chr&gt;, driver_sex &lt;chr&gt;, driver_vehicle_type &lt;chr&gt;,
## #   crash_alcohol &lt;chr&gt;, crash_date &lt;chr&gt;, crash_day &lt;chr&gt;, crash_group &lt;chr&gt;,
## #   crash_hour &lt;dbl&gt;, crash_location &lt;chr&gt;, crash_month &lt;chr&gt;,
## #   crash_severity &lt;chr&gt;, crash_time &lt;time&gt;, crash_type &lt;chr&gt;,
## #   crash_year &lt;dbl&gt;, ambulance_req &lt;chr&gt;, hit_run &lt;chr&gt;,
## #   light_condition &lt;chr&gt;, road_character &lt;chr&gt;, road_class &lt;chr&gt;,
## #   road_condition &lt;chr&gt;, road_configuration &lt;chr&gt;, road_defects &lt;chr&gt;,
## #   road_feature &lt;chr&gt;, road_surface &lt;chr&gt;, num_lanes &lt;chr&gt;, geo_point &lt;chr&gt;
```

---

## `slice` for certain row numbers

Last five
 

```r
last_row &lt;- nrow(ncbikecrash)
ncbikecrash %&gt;%
* slice((last_row - 4):last_row)
```

```
## # A tibble: 5 x 53
##   object_id city  county region development locality on_road rural_urban
##       &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      
## 1      6989 High… Guilf… Piedm… Residential Urban (… &lt;NA&gt;    Urban      
## 2      6991 Wilm… New H… Coast… Residential Urban (… &lt;NA&gt;    Urban      
## 3      6995 Kins… Lenoir Coast… Commercial  Urban (… &lt;NA&gt;    Urban      
## 4      6998 Faye… Cumbe… Coast… Residential Urban (… &lt;NA&gt;    Urban      
## 5      7000 None… Onslow Coast… Farms, Woo… Rural (… &lt;NA&gt;    Rural      
## # … with 45 more variables: speed_limit &lt;chr&gt;, traffic_control &lt;chr&gt;,
## #   weather &lt;chr&gt;, workzone &lt;chr&gt;, bike_age &lt;chr&gt;, bike_age_group &lt;chr&gt;,
## #   bike_alcohol &lt;chr&gt;, bike_alcohol_drugs &lt;chr&gt;, bike_direction &lt;chr&gt;,
## #   bike_injury &lt;chr&gt;, bike_position &lt;chr&gt;, bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;,
## #   driver_age &lt;chr&gt;, driver_age_group &lt;chr&gt;, driver_alcohol &lt;chr&gt;,
## #   driver_alcohol_drugs &lt;chr&gt;, driver_est_speed &lt;chr&gt;, driver_injury &lt;chr&gt;,
## #   driver_race &lt;chr&gt;, driver_sex &lt;chr&gt;, driver_vehicle_type &lt;chr&gt;,
## #   crash_alcohol &lt;chr&gt;, crash_date &lt;chr&gt;, crash_day &lt;chr&gt;, crash_group &lt;chr&gt;,
## #   crash_hour &lt;dbl&gt;, crash_location &lt;chr&gt;, crash_month &lt;chr&gt;,
## #   crash_severity &lt;chr&gt;, crash_time &lt;time&gt;, crash_type &lt;chr&gt;,
## #   crash_year &lt;dbl&gt;, ambulance_req &lt;chr&gt;, hit_run &lt;chr&gt;,
## #   light_condition &lt;chr&gt;, road_character &lt;chr&gt;, road_class &lt;chr&gt;,
## #   road_condition &lt;chr&gt;, road_configuration &lt;chr&gt;, road_defects &lt;chr&gt;,
## #   road_feature &lt;chr&gt;, road_surface &lt;chr&gt;, num_lanes &lt;chr&gt;, geo_point &lt;chr&gt;
```

---

## `sample_n` / `sample_frac` for a random sample

- `slice_sample`: randomly sample `n = 5` observations


```r
ncbikecrash_n5 &lt;- ncbikecrash %&gt;%
* slice_sample(n = 5, replace = FALSE)
dim(ncbikecrash_n5)
```

```
## [1]  5 53
```

--

- `sample_frac`: randomly sample `prop = 20%` of observations


```r
ncbikecrash_perc20 &lt;-ncbikecrash %&gt;%
* slice_sample(prop = 0.2, replace = FALSE)
dim(ncbikecrash_perc20)
```

```
## [1] 1493   53
```

---

## `filter` to select a subset of rows

Crashes in Durham County


```r
ncbikecrash %&gt;%
* filter(county == "Durham")
```

```
## # A tibble: 340 x 53
##    object_id city  county region development locality on_road rural_urban
##        &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      
##  1      2452 Durh… Durham Piedm… Residential Urban (… &lt;NA&gt;    Urban      
##  2      2441 Durh… Durham Piedm… Commercial  Urban (… &lt;NA&gt;    Urban      
##  3      2466 Durh… Durham Piedm… Commercial  Urban (… &lt;NA&gt;    Urban      
##  4       549 Durh… Durham Piedm… Residential Urban (… PARK A… Urban      
##  5       598 Durh… Durham Piedm… Residential Urban (… BELT S… Urban      
##  6       603 Durh… Durham Piedm… Residential Urban (… HINSON… Urban      
##  7      3974 Durh… Durham Piedm… Commercial  Urban (… &lt;NA&gt;    Urban      
##  8      7134 Durh… Durham Piedm… Commercial  Urban (… &lt;NA&gt;    Urban      
##  9      1670 Durh… Durham Piedm… Commercial  Urban (… INFINI… Urban      
## 10      1773 Durh… Durham Piedm… Residential Urban (… &lt;NA&gt;    Urban      
## # … with 330 more rows, and 45 more variables: speed_limit &lt;chr&gt;,
## #   traffic_control &lt;chr&gt;, weather &lt;chr&gt;, workzone &lt;chr&gt;, bike_age &lt;chr&gt;,
## #   bike_age_group &lt;chr&gt;, bike_alcohol &lt;chr&gt;, bike_alcohol_drugs &lt;chr&gt;,
## #   bike_direction &lt;chr&gt;, bike_injury &lt;chr&gt;, bike_position &lt;chr&gt;,
## #   bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;, driver_age &lt;chr&gt;, driver_age_group &lt;chr&gt;,
## #   driver_alcohol &lt;chr&gt;, driver_alcohol_drugs &lt;chr&gt;, driver_est_speed &lt;chr&gt;,
## #   driver_injury &lt;chr&gt;, driver_race &lt;chr&gt;, driver_sex &lt;chr&gt;,
## #   driver_vehicle_type &lt;chr&gt;, crash_alcohol &lt;chr&gt;, crash_date &lt;chr&gt;,
## #   crash_day &lt;chr&gt;, crash_group &lt;chr&gt;, crash_hour &lt;dbl&gt;, crash_location &lt;chr&gt;,
## #   crash_month &lt;chr&gt;, crash_severity &lt;chr&gt;, crash_time &lt;time&gt;,
## #   crash_type &lt;chr&gt;, crash_year &lt;dbl&gt;, ambulance_req &lt;chr&gt;, hit_run &lt;chr&gt;,
## #   light_condition &lt;chr&gt;, road_character &lt;chr&gt;, road_class &lt;chr&gt;,
## #   road_condition &lt;chr&gt;, road_configuration &lt;chr&gt;, road_defects &lt;chr&gt;,
## #   road_feature &lt;chr&gt;, road_surface &lt;chr&gt;, num_lanes &lt;chr&gt;, geo_point &lt;chr&gt;
```

---

## `filter` for many conditions at once

Crashes in Durham County where biker is 0-5 years old


```r
ncbikecrash %&gt;%
* filter(
*   county == "Durham",
*   bike_age_group == "0-5"
*   )
```

```
## # A tibble: 4 x 53
##   object_id city  county region development locality on_road rural_urban
##       &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;       &lt;chr&gt;    &lt;chr&gt;   &lt;chr&gt;      
## 1      4062 Durh… Durham Piedm… Residential Urban (… &lt;NA&gt;    Urban      
## 2       414 Durh… Durham Piedm… Residential Urban (… PVA 90… Urban      
## 3      3016 Durh… Durham Piedm… Residential Urban (… &lt;NA&gt;    Urban      
## 4      1383 Durh… Durham Piedm… Residential Urban (… PVA 62… Urban      
## # … with 45 more variables: speed_limit &lt;chr&gt;, traffic_control &lt;chr&gt;,
## #   weather &lt;chr&gt;, workzone &lt;chr&gt;, bike_age &lt;chr&gt;, bike_age_group &lt;chr&gt;,
## #   bike_alcohol &lt;chr&gt;, bike_alcohol_drugs &lt;chr&gt;, bike_direction &lt;chr&gt;,
## #   bike_injury &lt;chr&gt;, bike_position &lt;chr&gt;, bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;,
## #   driver_age &lt;chr&gt;, driver_age_group &lt;chr&gt;, driver_alcohol &lt;chr&gt;,
## #   driver_alcohol_drugs &lt;chr&gt;, driver_est_speed &lt;chr&gt;, driver_injury &lt;chr&gt;,
## #   driver_race &lt;chr&gt;, driver_sex &lt;chr&gt;, driver_vehicle_type &lt;chr&gt;,
## #   crash_alcohol &lt;chr&gt;, crash_date &lt;chr&gt;, crash_day &lt;chr&gt;, crash_group &lt;chr&gt;,
## #   crash_hour &lt;dbl&gt;, crash_location &lt;chr&gt;, crash_month &lt;chr&gt;,
## #   crash_severity &lt;chr&gt;, crash_time &lt;time&gt;, crash_type &lt;chr&gt;,
## #   crash_year &lt;dbl&gt;, ambulance_req &lt;chr&gt;, hit_run &lt;chr&gt;,
## #   light_condition &lt;chr&gt;, road_character &lt;chr&gt;, road_class &lt;chr&gt;,
## #   road_condition &lt;chr&gt;, road_configuration &lt;chr&gt;, road_defects &lt;chr&gt;,
## #   road_feature &lt;chr&gt;, road_surface &lt;chr&gt;, num_lanes &lt;chr&gt;, geo_point &lt;chr&gt;
```

---

## Logical operators in R

operator    | definition                   || operator     | definition
------------|------------------------------||--------------|----------------
`&lt;`         | less than                    ||`x`&amp;nbsp;&amp;#124;&amp;nbsp;`y`     | `x` OR `y` 
`&lt;=`        |	less than or equal to        ||`is.na(x)`    | test if `x` is `NA`
`&gt;`         | greater than                 ||`!is.na(x)`   | test if `x` is not `NA`
`&gt;=`        |	greater than or equal to     ||`x %in% y`    | test if `x` is in `y`
`==`        |	exactly equal to             ||`!(x %in% y)` | test if `x` is not in `y`
`!=`        |	not equal to                 ||`!x`          | not `x`
`x &amp; y`     | `x` AND `y`                  ||              |

---

.question[
Fill in the blanks for filtering for crashes **not** in Durham County where crash year is after 2014 and `bike_position` is not `NA`.
]


```r
ncbikecrash %&gt;%
  filter(
    county ____ "Durham", 
    crash_year ____ 2014,
    ____
    )
```

---

.question[
Fill in the blanks for filtering for crashes **not** in Durham County where crash year is after 2014 and `bike_position` is not `NA`.
]


```r
ncbikecrash %&gt;%
  filter(
*   county != "Durham",
*   crash_year &gt; 2014,
*   !is.na(bike_position)
    )
```

```
## # A tibble: 0 x 53
## # … with 53 variables: object_id &lt;dbl&gt;, city &lt;chr&gt;, county &lt;chr&gt;, region &lt;chr&gt;,
## #   development &lt;chr&gt;, locality &lt;chr&gt;, on_road &lt;chr&gt;, rural_urban &lt;chr&gt;,
## #   speed_limit &lt;chr&gt;, traffic_control &lt;chr&gt;, weather &lt;chr&gt;, workzone &lt;chr&gt;,
## #   bike_age &lt;chr&gt;, bike_age_group &lt;chr&gt;, bike_alcohol &lt;chr&gt;,
## #   bike_alcohol_drugs &lt;chr&gt;, bike_direction &lt;chr&gt;, bike_injury &lt;chr&gt;,
## #   bike_position &lt;chr&gt;, bike_race &lt;chr&gt;, bike_sex &lt;chr&gt;, driver_age &lt;chr&gt;,
## #   driver_age_group &lt;chr&gt;, driver_alcohol &lt;chr&gt;, driver_alcohol_drugs &lt;chr&gt;,
## #   driver_est_speed &lt;chr&gt;, driver_injury &lt;chr&gt;, driver_race &lt;chr&gt;,
## #   driver_sex &lt;chr&gt;, driver_vehicle_type &lt;chr&gt;, crash_alcohol &lt;chr&gt;,
## #   crash_date &lt;chr&gt;, crash_day &lt;chr&gt;, crash_group &lt;chr&gt;, crash_hour &lt;dbl&gt;,
## #   crash_location &lt;chr&gt;, crash_month &lt;chr&gt;, crash_severity &lt;chr&gt;,
## #   crash_time &lt;time&gt;, crash_type &lt;chr&gt;, crash_year &lt;dbl&gt;, ambulance_req &lt;chr&gt;,
## #   hit_run &lt;chr&gt;, light_condition &lt;chr&gt;, road_character &lt;chr&gt;,
## #   road_class &lt;chr&gt;, road_condition &lt;chr&gt;, road_configuration &lt;chr&gt;,
## #   road_defects &lt;chr&gt;, road_feature &lt;chr&gt;, road_surface &lt;chr&gt;,
## #   num_lanes &lt;chr&gt;, geo_point &lt;chr&gt;
```

---

## `distinct` to filter for unique rows

... and `arrange` to order alphabetically

.pull-left[

```r
ncbikecrash %&gt;% 
* distinct(county) %&gt;%
  arrange(county)
```

```
## # A tibble: 101 x 1
##    county   
##    &lt;chr&gt;    
##  1 Alamance 
##  2 Alexander
##  3 Alleghany
##  4 Anson    
##  5 Ashe     
##  6 Avery    
##  7 Beaufort 
##  8 Bertie   
##  9 Bladen   
## 10 Brunswick
## # … with 91 more rows
```
]
.pull-right[

```r
ncbikecrash %&gt;% 
  select(county, city) %&gt;% 
* distinct() %&gt;%
  arrange(county, city)
```

```
## # A tibble: 391 x 2
##    county    city              
##    &lt;chr&gt;     &lt;chr&gt;             
##  1 Alamance  Alamance          
##  2 Alamance  Burlington        
##  3 Alamance  Elon              
##  4 Alamance  Elon College      
##  5 Alamance  Gibsonville       
##  6 Alamance  Graham            
##  7 Alamance  Green Level       
##  8 Alamance  Mebane            
##  9 Alamance  None - Rural Crash
## 10 Alexander None - Rural Crash
## # … with 381 more rows
```
]




---

## Code Style

&gt;"Good coding style is like correct punctuation: you can manage without it, butitsuremakesthingseasiertoread."
&gt;
&gt;Hadley Wickham

- Recommended: Tidyverse style guide &lt;https://style.tidyverse.org/&gt;

---

## Summary

* File names and code chunks: `data-wrangling`, not `Data Wrangling`.
* Variable names: `hourly_rides`, not `hourlyRides` or `hourly.rides` or `rides_by_hour_with_weather`
  * Informative but short. Don't reuse.

---

## Spacing

- Put a space before and after all infix operators (=, +, -, &lt;-, etc.), and when 
naming arguments in function calls
- Always put a space after a comma, and never before (just like in regular English)


```r
# Good
average &lt;- mean(feet / 12 + inches, na.rm = TRUE)

# Bad
average&lt;-mean(feet/12+inches,na.rm=TRUE)
```

---

## ggplot2

- Always end a line with `+`
- Always indent the next line


```r
# Good
ggplot(diamonds, mapping = aes(x = price)) +
  geom_histogram()

# Bad
ggplot(diamonds,mapping=aes(x=price))+geom_histogram()
```


---

class: center, middle

# Tidy data

---

## Tidy data

&gt;Happy families are all alike; every unhappy family is unhappy in its own way. 
&gt;
&gt;Leo Tolstoy

--

.pull-left[
**Characteristics of tidy data:**

- Each variable forms a column.
- Each observation forms a row.
- Each type of observational unit forms a table.
]
--
.pull-right[
**Characteristics of untidy data:**

- Varies.
]

---

## 

.question[
What makes this data not tidy?
]

&lt;img src="img/untidy-data/hyperwar-airplanes-on-hand.png" width="90%" style="display: block; margin: auto;" /&gt;

.footnote[
Source: [Army Air Forces Statistical Digest, WW II](https://www.ibiblio.org/hyperwar/AAF/StatDigest/aafsd-3.html)
]

---

.question[
What makes this data not tidy?
]

&lt;br&gt;

&lt;img src="img/untidy-data/hiv-est-prevalence-15-49.png" width="95%" style="display: block; margin: auto;" /&gt;

.footnote[
Source: [Gapminder, Estimated HIV prevalence among 15-49 year olds](https://www.gapminder.org/data)
]

---

.question[
What makes this data not tidy?
]

&lt;br&gt;

&lt;img src="img/untidy-data/us-general-economic-characteristic-acs-2017.png" width="95%" style="display: block; margin: auto;" /&gt;

.footnote[
Source: [US Census Fact Finder, General Economic Characteristics, ACS 2017](https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?pid=ACS_17_5YR_DP03&amp;src=pt)
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
