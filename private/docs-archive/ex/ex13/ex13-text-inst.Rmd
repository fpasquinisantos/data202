---
title: "Guided Exercise 13 - Text"
output: 
  tufte::tufte_html:
    css: ../ex.css
    tufte_variant: "envisioned"
    highlight: pygments
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = "")
library(tidyverse)
theme_set(theme_bw())
options(scipen = 5) # encourage metrics to print in fixed-point notation
options(dplyr.summarise.inform = FALSE) # silence a warning message
```

Humans, created as representatives of a speaking God, do a lot of speaking. So, naturally, text data is everywhere: social media posts, product descriptions, customer surveys, newspaper articles, emails, press releases, etc.

Words are amazingly flexible, but sometimes we want to quantify, which entails reducing that flexibility to overly simplistic numbers. Keeping in mind that trade-off, this exercise is about equipping you with a few tools to turn text into tabular data. The tools we'll see today are:

-   *regular expressions* (**regex**): a little programming language used for looking for specific kinds of things in text strings. For example, the regular expression `th[eo]se` matches either "these" or "those" (and nothing else).
-   *web scraping*: a way of pulling text (or other data) out of loosely-structured web pages

Learning objectives:

-   Predict how a regular expression will match a given text
-   Write regular expressions to perform extraction and separation tasks
-   Scrape data from web pages

## Getting started

**There isn't a template today**. Instead, create a new R Markdown document in an `ex13` folder in your portfolio. Refer to past exercises to see how to write the YAML header (with title etc.) and the setup chunk (to load `tidyverse`).

You may also want to have the following resources handy:

- We'll be working through exactly the examples in [Chapter 19](https://mdsr-book.github.io/mdsr2e/ch-text.html) of our textbook.
- [Strings chapter in *R for Data Science*](https://r4ds.had.co.nz/strings.html)
- the [Regular Expressions vignette in `stringr`](https://stringr.tidyverse.org/articles/regular-expressions.html)
- [RegExr](https://regexr.com/) might be helpful for visualizing regular expressions.

## `separate`

First, let's hit one of the most common things you need to do with string data: separate a string into several pieces. So: **do the `separate()` section of the [Tidy Your Data primer](https://rstudio.cloud/learn/primers/4.2)**. (Don't worry about `unite()`, and come back later to the Case Study if you want more practice with a cool wrangling puzzle.)

> Note: the tutorial uses the old name of `pivot_longer`, which was `gather`.

## Macbeth

Following the textbook, we'll be working with the text of Macbeth.

We can retrieve this text from Project Gutenberg. But to avoid making too many requests to the Project Gutenberg web server, the textbook
authors included the text data in their `mdsr` package. So we'll load it from there instead. 
The commented code may be useful if you want to pull in text from a different source, though.

```{r}
#macbeth_url <- "http://www.gutenberg.org/cache/epub/1129/pg1129.txt"
#macbeth_raw <- read_file(macbeth_url)
Macbeth_raw <- mdsr::Macbeth_raw
```

Now we split the raw text into lines:

```{r}
macbeth <- Macbeth_raw %>% 
  stringi::stri_split_lines() %>%
  pluck(1)
length(macbeth)
```

### Finding Matches

The `str_detect` function tells whether or not a line contains a pattern. Using the sum-as-count pattern, we can count matches.

```{r}
pattern <- "MACBETH"
macbeth %>% str_detect(pattern) %>% sum()
```

We can also filter for which lines contain a pattern, using `str_subset`:

```{r}
macbeth %>% str_subset(pattern) %>% head()
macbeth %>% str_subset(pattern) %>% length()
```

::: {.exercises}

1.  How many lines contain "MACBETH"? How many lines contain "MACDUFF"?

### Regex Patterns

#### Anything

The `.` character matches any single character.

```{r}
pattern <- "MAC."
macbeth %>% str_subset(pattern) %>% head()
```

`str_extract` can tell us what matched:

```{r}
macbeth %>% 
  str_subset(pattern) %>% 
  str_extract(pattern) %>% 
  head()
```

#### Character Sets

Square brackets define *character sets*: they match any character in the set. You can give specific characters...

```{r eval=FALSE}
pattern <- "MAC[BD]"
macbeth %>% str_subset(pattern) %>% head()
```

or ranges of characters:

```{r eval=FALSE}
pattern <- "MAC[D-H]"
macbeth %>% str_subset(pattern) %>% head()
```

Also:

- `\d` matches a digit (though you'll need to escape the backslash; see note below)
- `\s` matches a whitespace character (space, newline, etc.) 
- `[^a-c]` matches any character *except* a, b, or c. 

2.  How many lines have a vowel followed by an exclamation point?
<!-- times does *i* follow *e* in the play? How many times does *e* follow *i*? -->

```{r include=FALSE}
macbeth %>% str_subset("[aeiou]!")
```


### Anchors

`^` matches nothing, but only at the beginning of a string. `$` matches nothing, but only at the end.


### Repetition

- `?`: match the preceding pattern either zero or one times
- `+`: match the preceding pattern one or more times (this is often useful)
- `*`: match 0 or more times (not as commonly useful)
- `{n}`: match exactly *n* times
- `{n,m}`: between *n* and *m* times
- omit either *n* or *m*: at least *n* or at most *m*.

Compare the following three regex's:

```{r eval=FALSE}
macbeth %>% str_subset("^ +L")
macbeth %>% str_subset(" +L")
macbeth %>% str_subset("^ L")
```

**Bonus**: Are there any lines that start with a number?

```{r include=FALSE}
macbeth %>% str_subset('^[0-9]')
```

### Escaping

What if we wanted to match a literal `.`, `?`, `[`, etc? We need to *escape* them: `\.` matches a period.

But `\` is itself a special character for strings, so we need to escape *it*! So we'd write `"\\."`.


3. Consider the expression `^la{2,3}`. Predict which of the following strings will match:

- ""
- "la"
- "laa"
- "lala"
- "lalala"
- "lalalala"
- "blalalala"

Now, try them. Here are those strings as a character vector (to use instead of `macbeth`):

```{r}
c("", "la", "laa", "lala", "lalala", "lalalala", "blalalala")
```

> Note: you might try this in RegExr, but you'll need to set the MULTILINE flag... and get rid of the quotes.


Follow-up:

- What happens if you put parentheses around `la`?
- You'll notice that something matched that was longer than you expected. Can you figure out how to modify the pattern so it *doesn`t* match the long one?

4. Give an example of a string that matches this expression: `\d{3}-\d{3}-\d{4}`. Hint: you probably know several of these from memory and share them with others regularly.

**Note**: when you write these in your code, you'll need to double the `\`s because a single `\` is used as an escape character. Or use a new feature called *raw character constants*: `r"(\d{3}-\d{3}-\d{4})"`. (The `(` is not counted as part of the string.)

5. In CS 108 or 106, you wrote a function to check whether a string was a valid SSN (123-45-6789). Write a regular expression that does the same thing.

> Note: The `tidyr::separate()` function allows regular expressions for the `sep`. For more advanced text extraction, see `tidyr::extract()`.

:::

## Web scraping

Walk through the [Ingesting text](https://mdsr-book.github.io/mdsr2e/ch-text.html#ingesting-text) example in the book.
