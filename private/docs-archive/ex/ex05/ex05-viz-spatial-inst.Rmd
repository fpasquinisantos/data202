---
title: "Exercise 5 - Visualizing Spatial Data"
output: 
  tufte::tufte_html:
    css: ../ex.css
    tufte_variant: "envisioned"
    highlight: pygments
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE)
```


```{r fig.margin = TRUE, echo = FALSE}
knitr::include_graphics("img/mitch-hedgeberg-lqd.jpg")
```

Have you ever taken a road trip in the US and thought to yourself "I wonder what La Quinta means"?
Well, the late comedian [Mitch Hedberg](https://en.wikipedia.org/wiki/Mitch_Hedberg) thinks it's Spanish for *next to Denny's*.

If you're not familiar with these two establishments, [Denny's](https://www.dennys.com/) is a casual diner chain that is open 24 hours and [La Quinta Inn and Suites](http://www.lq.com/) is a hotel chain.

These two establishments tend to be clustered together, or at least this observation is a joke made famous by Mitch Hedberg.
In this lab we explore the validity of this joke and along the way learn some more data wrangling and tips for visualizing spatial data.

The inspiration for this lab comes from a blog post by John Reiser on his *new jersey geographer* blog.
You can read that analysis [here](http://njgeo.org/2014/01/30/mitch-hedberg-and-gis/).
Reiser's blog post focuses on scraping data from Denny's and La Quinta Inn and Suites websites using Python.
In this lab we focus on visualization and analysis of these data.
However note that the data scraping was also done in R, and we we will discuss web scraping later in the course.
But for now we focus on the data that has already been scraped and tidied for you.

# Learning goals

-   Visualizing spatial data
-   Joining data frames

# Getting started

As usual, we're using our **portfolio repo** for this assignment. So:

- Open your `portfolio` project in RStudio (you should see `Project: portfolio-YOURGITHUB` in the top right).
- Go to the Git tab in RStudio and click `r emo::ji("arrow_down")` **Pull**.
- Find and open `ex05-viz-spatial/ex05-viz-spatial.Rmd` (you may need to navigate in the Files tab to find it).
- Change data in the YAML header as appropriate.

`r emo::ji("white_check_mark")` `r emo::ji("arrow_up")` *Now is a good time to commit and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

Now, Run All chunks (on the Run menu).

## Data

The datasets we'll use are called `dennys` and `laquinta`. They were scraped from [here](https://locations.dennys.com/) and [here](https://www.lq.com/en/findandbook/hotel-listings.html), respectively.

```{r include=FALSE}
library(tidyverse)
library(dsbox) # devtools::install_github("rstudio-education/dsbox")
dennys <- dsbox::dennys
laquinta <- dsbox::laquinta
write_rds(dennys, here::here("src/ex/ex05-viz-spatial/data/dennys.rds"))
write_rds(laquinta, here::here("src/ex/ex05-viz-spatial/data/laquinta.rds"))
fs::file_copy("data/states.csv", here::here("src/ex/ex05-viz-spatial/data/states.csv"), overwrite = TRUE)
```

These datasets are given to you in `rds` format, which is an R-internal format for datasets that maintains data types.

```{r eval=FALSE}
dennys <- read_rds("data/dennys.rds")
laquinta <- read_rds("data/laquinta.rds")
```

You can find out more about the datasets by inspecting their documentation [here](https://rstudio-education.github.io/dsbox/reference/dennys.html) (`dennys`) and [here](https://rstudio-education.github.io/dsbox/reference/laquinta.html) (`laquinta`).

To help with our analysis we will also use a dataset on US states, which is located in your repository's `data` folder.

```{r}
states <- read_csv("data/states.csv", col_types = cols(
  name = col_character(),
  abbreviation = col_character(),
  area = col_double()
))
```

Each observation in this dataset represents a state, including DC.
Along with the name of the state we have the two-letter abbreviation and we have the geographic area of the state (in square miles).

# Exercises

::: {.exercises}

1.  What are the dimensions of the Denny's dataset?
    (Hint: Use inline R code and functions like `nrow` and `ncol` to compose your answer.) What does each row in the dataset represent?
    What are the variables?

```{r include=FALSE}
dennys
laquinta
```


2.  What are the dimensions of the La Quinta's dataset?
    What does each row in the dataset represent?
    What are the variables?

üß∂ ‚úÖ ‚¨ÜÔ∏è Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

We would like to limit our analysis to Denny's and La Quinta locations in the United States.
We will determine whether or not the establishment has a location outside the US using the `state` variable in the `dennys` and `laquinta` datasets.
We know exactly which states are in the US, and we have this information in the `states` dataframe we loaded.

5.  Find the Denny's locations that are outside the US, if any. To do so, filter the Denny's locations for observations where `state` is not in `states$abbreviation`. One way to code this is given below. Note that the `%in%` operator matches the states listed in the `state` variable to those listed in the `states$abbreviation` vector. The `!` operator means **not**. Are there any Denny's locations outside the US?

```{marginfigure}
"Filter for `state`s that are not in `states$abbreviation`."
```

```{r eval=FALSE}
dennys %>%
  filter(!(state %in% states$abbreviation))
```

**Bonus**: can you use an `anti_join` instead? Come back and try this after you finish the rest.

```{r include=FALSE}
dennys %>% anti_join(states, by = c("state" = "abbreviation"))
```


6.  Add a country variable to the Denny's dataset and set all observations equal to `"United States"`. Remember, you can use the `mutate` function for adding a variable. Make sure to **save the result of this as `dennys` again** so that the stored data frame contains the new variable going forward.

```{marginfigure}
We don't need to tell R how many times to repeat the character string "United States" to fill in the data for all observations, R takes care of that automatically.

Also, reassigning to the same variable is good practice only when the operation is "idempotent", which means that it doesn't matter if you run the assignment a second time. Is this assignment idempotent?
```

```{r eval=FALSE}
dennys %>%
  mutate(country = "United States")
```

```{r include=FALSE}
dennys <- dennys %>%
  mutate(country = "United States")
```


7.  Find the La Quinta locations that are outside the US, and figure out which country they are in.
    One way to do this is by [finding their lat/long on Google Maps](https://support.google.com/maps/answer/18539): for the first one, you could search `21.755585,-102.27633` (you don't need many decimal places).
    Take notes, you will need to use this information in the next exercise.

```{r include=FALSE}
laquinta %>% anti_join(states, by = c("state" = "abbreviation"))
```


8.  Add a country variable to the La Quinta dataset.
    Use the `case_when` function to populate this variable.
    You'll need to refer to your notes from the previous exercise about which country the non-US locations are in.
    Here is some starter code to get you going:

```{r eval = FALSE}
laquinta %>%
  mutate(country = case_when(
    state %in% state.abb     ~ "United States",
    state %in% c("ON", "BC") ~ "Canada",
    state == "ANT"           ~ "Colombia",
    ...                      # fill in the rest
  ))
```

```{r include=FALSE}
laquinta <- laquinta %>%
  mutate(country = case_when(
    state %in% state.abb     ~ "United States",
    state %in% c("ON", "BC") ~ "Canada",
    state == "ANT"           ~ "Colombia",
    state %in% c("AG", "QR", "CH", "NL", "VE", "PU", "SL")  ~ "Mexico",
    state == "FM"  ~  "Honduras"
  ))
laquinta %>% filter(is.na(country))# %>% select(state, latitude, longitude) %>% mutate(latlong = glue("{latitude},{longitude}"))

```


üß∂ ‚úÖ ‚¨ÜÔ∏è Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

Going forward we will work with the data from the United States only.
All Denny's locations are in the United States, so we don't need to worry about them.
However we do need to filter the La Quinta dataset for locations in United States.

```{r}
laquinta <- laquinta %>%
  filter(country == "United States")
```

9.  Which states have the most and fewest Denny's locations? What about La Quinta? Is this surprising? Why or why not?

```{r include=FALSE}
dennys_by_state <- dennys %>% 
  group_by(state) %>% 
  summarize(count = n()) %>% 
  arrange(desc(count))
dennys_by_state

laquinta_by_state <- laquinta %>% count(state, sort = TRUE)
laquinta_by_state
```

10. Which states have the most Denny's locations *per thousand square miles*? What about La Quinta?

Note: to do this, you'll need to look up the states in the `states` dataset. 

```{r include=FALSE}
dennys_by_state %>% 
  inner_join(states, by = c("state" = "abbreviation")) %>% 
  mutate(count_per_area = count / area) %>% 
  arrange(desc(count_per_area))
```


11. Plot the locations (latitude and longitude) of both establishments.

To do this, we'll put the two datasets together into a single data frame.
Before we do so, we need to add an identifier variable.
We'll call this `establishment` and set the value accordingly.

```{r}
dennys <- dennys %>%
  mutate(establishment = "Denny's")
laquinta <- laquinta %>%
  mutate(establishment = "La Quinta")
```

Since the two data frames have the same columns, we can easily bind them with the `bind_rows` function:

```{r}
dn_lq <- bind_rows(dennys, laquinta)
```

We can plot the locations of the two establishments using a scatter plot, and color the points by the establishment type.
Note that the latitude is plotted on the x-axis and the longitude on the y-axis.

The following two questions ask you to create visualizations.
These should follow best practices you learned in class, such as informative titles, axis labels, etc.
See <http://ggplot2.tidyverse.org/reference/labs.html> for help with the syntax.
You can also choose different themes to change the overall look of your plots, see <http://ggplot2.tidyverse.org/reference/ggtheme.html> for help with these.

11. Filter the data for observations in North Carolina only, and recreate the plot.
    You should also adjust the transparency of the points, by setting the `alpha` level, so that it's easier to see the overplotted ones.
    Visually, does Mitch Hedberg's joke appear to hold here?

12. Now filter the data for observations in Texas only, and recreate the plot, with an appropriate `alpha` level.
    Visually, does Mitch Hedberg's joke appear to hold here?

That's it for now!
In homework we will take a more quantitative approach to answering these questions.

üß∂ ‚úÖ ‚¨ÜÔ∏è Knit, *commit, and push your changes to GitHub with an appropriate commit message. Make sure to commit and push all changed files so that your Git pane is cleared up afterwards.*

:::

*This exercise was based on an [RStudio Education example](https://rstudio-education.github.io/datascience-box/course-materials/lab-instructions/lab-04/lab-04-viz-sp-data.html).
