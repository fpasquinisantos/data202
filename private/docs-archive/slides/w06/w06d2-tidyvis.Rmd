---
title: "Data tidying and visualizing <br> `r emo::ji('broom')`"
author: "DATA 202 21FA"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "slides.css"]
    lib_dir: libs
    self_contained: false
    nature:
      ratio: "4:3"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r child = "../slide-setup.Rmd"}
```

```{r packages, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(emo)
library(knitr)
library(skimr)
library(scales)
library(patchwork)
knitr::opts_chunk$set(comment = "")
```

## This stuff isn't easy.


---

## Q&A

> Why isn't all data already long-format?

Usually: data meant for *human* consumption.

> What are other uses of pivoting? `pivot_wider` and `pivot_longer` together??

See `vignette("pivot", package = "tidyr")`.

> Performance?

Usually a `join` is the tighter bottleneck.

---

## Reminders

- First project milestone due Friday
- Quiz closes today
- Test *next* Friday (in lab)

---

## Micro-Pivot

```{r include=FALSE}
xx <- tribble(
  ~id, ~col1, ~col2,
  "A", "A1", "A2",
  "B", "B1", "B2"
)
```

```{r include=FALSE}
x <- xx %>% head(1)
```


```{r}
x
```
--

```{r}
x %>% 
  pivot_longer(
    cols = starts_with("col"),
    names_to = "column_name", values_to = "value_was")
```

---

## Micro-Pivot

```{r include=FALSE}
x <- xx
```


```{r}
x
```

--

```{r}
x %>% 
  pivot_longer(cols = starts_with("col"), names_to = "column_name", values_to = "value_was")
```


---

class: middle

# Instructional staff employment trends

---

- American Association of University Professors (AAUP)
- nonprofit association of academic professionals
- [2013 report](https://www.aaup.org/sites/default/files/files/AAUP_Report_InstrStaff-75-11_apr2013.pdf):
  trends in instructional staff employees between 1975 
and 2011
-  contains an image very similar to this:

```{r echo=FALSE, out.width="80%"}
include_graphics("img/staff-employment.png")
```

---

## Data

Each row in this dataset represents a faculty type, and the columns are the 
years for which we have data. The values are percentage of hires of that type 
of faculty for each year.

```{r load-data-staff, message=FALSE}
staff <- read_csv("data/instructional-staff.csv")
staff
```

---

## Recreate the visualization

To recreate this visualization we need to first reshape the data to have 
one variable for faculty type and one variable for year. In other words, 
we will convert the data from *wide format* to *long format*.

But before we do so... 

.question[
If the long data will have a row for each year/faculty type combination, 
and there are 5 faculty types and 11 years of data, how many rows will the data have?
]

---

class: middle

```{r echo=FALSE,out.width="80%"}
include_graphics("img/pivot.gif")
```

---

## Write the pivot.

```{r}
staff
```


---

## Pivot staff data

```{r}
staff %>%
  pivot_longer(
    cols = -faculty_type, 
    names_to = "year", 
    values_to = "percentage"
    )
```

---

## Pivot staff data, and save result

```{r}
staff_long <- staff %>%
  pivot_longer(
    cols = -faculty_type, 
    names_to = "year", 
    values_to = "percentage"
    )

staff_long
```

---

.question[
This doesn't look quite right, how would you fix it?
]

```{r out.width="80%"}
ggplot(staff_long, aes(x = percentage, y = year, color = faculty_type)) +
  geom_col()
```

---

## Some improvement...

```{r out.width="80%"}
staff_long %>%
  ggplot(aes(x = percentage, y = year, fill = faculty_type)) +
  geom_col()
```

---

## More improvement

```{r out.width="80%"}
staff_long %>%
  ggplot(aes(x = year, y = percentage, group = faculty_type, color = faculty_type)) +
  geom_line()
```

---

.question[
What is the difference between these two plots?
]

```{r echo=FALSE, out.width="70%", fig.asp=0.7}
p1 <- staff_long %>%
  ggplot(aes(x = year, y = percentage, group = faculty_type, color = faculty_type)) +
  geom_line() +
  guides(color = "none")
p2 <- staff_long %>%
  mutate(year = as.numeric(year)) %>%
  ggplot(aes(x = year, y = percentage, group = faculty_type, color = faculty_type)) +
  geom_line() +
  guides(color = "none")
p1 + p2 + 
  plot_layout(nrow = 2)
```

---

## Make year numeric again!

.small[
```{r out.width="70%"}
staff_long <- staff_long %>%
  mutate(year = as.numeric(year)) #<<

staff_long %>%
  ggplot(aes(x = year, y = percentage, group = faculty_type, color = faculty_type)) +
  geom_line()
```
]

---

.question[
How would you go about creating the following plot?
]

```{r echo=FALSE, out.width="80%"}
staff_long %>%
  mutate(part_time = if_else(faculty_type == "Part-Time Faculty",
                             "Part-Time Faculty", 
                             "Other Faculty")) %>%
  ggplot(aes(x = year, y = percentage/100, 
             group = faculty_type, 
             color = part_time)) +
  geom_line() +
  scale_color_manual(values = c("gray", "red")) +
  theme_minimal() +
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Proportion",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r eval=FALSE}
staff_long %>%
  mutate(part_time = if_else(faculty_type == "Part-Time Faculty", #<<
                             "Part-Time Faculty", #<<
                             "Other Faculty")) %>% #<<
  ggplot(aes(x = year, y = percentage/100, 
             group = faculty_type, 
             color = part_time)) + 
  geom_line() +
  scale_color_manual(values = c("gray", "red")) + 
  theme_minimal() + 
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Proportion",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r eval=FALSE}
staff_long %>%
  mutate(part_time = if_else(faculty_type == "Part-Time Faculty", 
                             "Part-Time Faculty", 
                             "Other Faculty")) %>% 
  ggplot(aes(x = year, y = percentage/100, 
             group = faculty_type, #<< 
             color = part_time)) + #<<
  geom_line() +
  scale_color_manual(values = c("gray", "red")) + #<<
  theme_minimal() + #<<
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Proportion",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r echo=FALSE}
staff_long %>%
  mutate(part_time = if_else(faculty_type == "Part-Time Faculty", 
                             "Part-Time Faculty", 
                             "Other Faculty")) %>% 
  ggplot(aes(x = year, y = percentage/100, 
             group = faculty_type, #<< 
             color = part_time)) + #<<
  geom_line() +
  scale_color_manual(values = c("gray", "red")) + #<<
  theme_minimal() + #<<
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Proportion",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r eval=FALSE}
library(scales) #<<
staff_long %>%
  mutate(part_time = 
           if_else(faculty_type == "Part-Time Faculty", 
                   "Part-Time Faculty", "Other Faculty")) %>% 
  ggplot(aes(x = year, y = percentage/100, group = faculty_type, 
             color = part_time)) +
  geom_line() +
  scale_color_manual(values = c("gray", "red")) +
  scale_y_continuous(labels = percent) + #<<
  theme_minimal() +
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Percentage", #<<
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r echo=FALSE}
library(scales)
staff_long %>%
  mutate(part_time = 
           if_else(faculty_type == "Part-Time Faculty", 
                   "Part-Time Faculty", "Other Faculty")) %>% 
  ggplot(aes(x = year, y = percentage/100, group = faculty_type, 
             color = part_time)) +
  geom_line() +
  scale_color_manual(values = c("gray", "red")) +
  scale_y_continuous(labels = percent) +
  theme_minimal() +
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Percentage",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r echo=FALSE}
library(scales)
staff_long %>%
  mutate(part_time = 
           if_else(faculty_type == "Part-Time Faculty", 
                   "Part-Time Faculty", "Other Faculty")) %>% 
  ggplot(aes(x = year, y = percentage/100, group = faculty_type, 
             color = part_time)) +
  geom_line() +
  scale_color_manual(values = c("gray", "red")) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) +
  theme_minimal() +
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Percentage",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

```{r eval=FALSE}
library(scales)
staff_long %>%
  mutate(part_time = 
           if_else(faculty_type == "Part-Time Faculty", 
                   "Part-Time Faculty", "Other Faculty")) %>% 
  ggplot(aes(x = year, y = percentage/100, group = faculty_type, 
             color = part_time)) +
  geom_line() +
  scale_color_manual(values = c("gray", "red")) +
  scale_y_continuous(labels = percent_format(accuracy = 1)) + #<<
  theme_minimal() +
  labs(
    title = "Instructional staff employment trends",
    x = "Year",
    y = "Percentage",
    color = ""
  ) +
  theme(legend.position = "bottom")
```

---

class: middle

# Other common tidying moves

---

```{r echo=FALSE, out.width="85%"}
include_graphics("img/relig-income.png")
```

.xsmall[
Source: [pewforum.org/religious-landscape-study/income-distribution](https://www.pewforum.org/religious-landscape-study/income-distribution/), Retrieved 14 April, 2020
]

---

## Read data 

```{r}
library(readxl)
rel_inc <- read_excel("data/relig-income.xlsx") # directly from Excel!
```

.small[
```{r echo=FALSE}
rel_inc
```
]

---

## Rename columns

.midi[
```{r}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  )
```
]

--

.question[
If we want a new variable called `income` with levels such as "Less than $30,000", "$30,000-$49,999", ... etc. which function should we use?
]

---

## Pivot longer

.midi[
```{r}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n),   # all but religion and n
    names_to = "income", 
    values_to = "proportion"
  )
```
]

---

## Calculate frequencies

.midi[
```{r}
rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n), 
    names_to = "income", 
    values_to = "proportion"
  ) %>%
  mutate(frequency = round(proportion * n))
```
]

---

## Save data

```{r}
rel_inc_long <- rel_inc %>%
  rename(
    religion = `Religious tradition`,
    n = `Sample Size`
  ) %>%
  pivot_longer(
    cols = -c(religion, n), 
    names_to = "income", 
    values_to = "proportion"
  ) %>%
  mutate(frequency = round(proportion * n))
```

---

## Religion

```{r out.width="80%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency)) +
  geom_col()
```

---

## Reverse religion order

```{r out.width="75%"}
rel_inc_long <- rel_inc_long %>%
  mutate(religion = fct_rev(religion)) #<<

ggplot(rel_inc_long, aes(y = religion, x = frequency)) + 
  geom_col(color = "blue", fill = "green")
```

---

## Add income

```{r out.width="80%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) + #<<
  geom_col()
```

---

## Fix income level ordering

```{r}
rel_inc_long <- rel_inc_long %>%
  mutate(
    income = fct_relevel(income, "$100,000 or more", #<<
                         "$50,000-$99,999", "$30,000-$49,999", #<<
                         "Less than $30,000") #<<
    )
```

---

## Plot again

```{r out.width="80%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) + 
  geom_col()
```

---

## Fill bars

.small[
```{r out.width="80%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") #<<
```
]

---

## Change colors

.small[
```{r out.width="80%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() #<<
```
]

---


## Change theme

.small[
```{r out.width="80%"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() #<<
```
]

---

## Move legend to the bottom

.midi[
```{r bottom-legend, fig.show="hide"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(legend.position = "bottom") #<<
```
]

---

## Move legend to the bottom (plot)

```{r ref.label = "bottom-legend", echo=FALSE, out.width="80%"}
```

---

## Legend adjustments

.small[
```{r legend-adjust, fig.show="hide"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(
    legend.position = "bottom", 
    legend.key.size = unit(0.3, "cm"), #<<
    legend.box.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "pt") #<<
    ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) #<<
```
]

---

## Legend adjustments (plot)

```{r ref.label = "legend-adjust", echo=FALSE, out.width="80%"}
```

---

## Fix labels

.midi[
```{r fix-labels, fig.show="hide"}
ggplot(rel_inc_long, aes(y = religion, x = frequency, fill = income)) +
  geom_col(position = "fill") +
  scale_fill_viridis_d() +
  theme_minimal() +
  theme(
    legend.position = "bottom", 
    legend.key.size = unit(0.3, "cm"), 
    legend.box.margin = margin(t = 0, r = 0, b = 0, l = 0, unit = "pt") 
    ) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  labs(
    x = "Frequency", y = "", #<<
    title = "Income distribution by religious group", #<<
    subtitle = "Source: Pew Research Center, Religious Landscape Study", #<<
    fill = "Income"
    )
```
]

---

## Fix labels (plot)

```{r ref.label = "fix-labels", echo=FALSE, out.width="80%"}
```

