---
title: "Wrangling practice: one table"
author: "DATA 202 21FA, based on [datasciencebox.org](https://datasciencebox.org/)"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "slides.css"]
    lib_dir: libs
    nature:
      ratio: "4:3"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r child = "../slide-setup.Rmd"}
```

```{r packages, include=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(forcats)
```


## Q&A

> When are `ggplot2` vs `dplyr` used in the real world?

Usually they're used *together*: wrangle-wrangle-wrangle-plot.
Reports often include both *tables* and *graphics*.

> Are `mutate`, `select`, etc. universal?

These are only `tidyverse`, but SQL has very similar concepts.

> How to connect and join tables?

Next week! (You're welcome to read ahead.)

> Can you pipe too much?

No intrinsic limit, but: split into functions, simplify your analysis.

---

class: center, middle

## Today: Practice thinking about grammar of transformation

Friday: in-lab practice

---

## Data: Hotel bookings

- Data from two hotels: one resort and one city hotel
- Observations: Each row represents a hotel booking
- You can try it: [Application Exercise](https://rsconnect.calvin.edu:3939/content/17949583-af9b-4ac4-a5dd-4edc14773c86)

```{r message=FALSE}
hotels <- read_csv("data/hotels.csv")
head(hotels)
```

.floating-source[
Source: [TidyTuesday](https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-02-11/readme.md)
]


---
layout: true

## ascending / descending order

---

.pull-left[
```{r}
hotels %>%
  select(adults, children, babies) %>%
  arrange(babies) #<<
```
]

--

.pull-right[
```{r}
hotels %>%
  select(adults, children, babies) %>%
  arrange(desc(babies)) #<<
```
]

---

.pull-left[
```{r}
hotels %>%
  select(adults, children, babies) %>%
  arrange(babies) #<<
```
]
.pull-right[
```{r}
hotels %>%
  select(adults, children, babies) %>%
  arrange(-babies) #<<
```
]

---
layout: true

## `filter`

How could we remove the resort hotel? (`hotel` being `"Resort Hotel"`)

---

```{r eval=FALSE}
hotels %>%
  filter(___)
```

---

```{r}
hotels %>% 
  filter(hotel != "Resort Hotel")
```

---
layout: false

## `filter` keeps rows matching conditions

---

## Multiple conditions

Any bookings for only kids (no `adults`, but `children` or `babies`)?

--

```{r}
hotels %>%
  filter( 
    adults == 0,     
    children >= 1 | babies >= 1     # | means or  #<<
    ) %>%
  select(adults, babies, children)
```

---

## Logical operators in R

<br>

operator    | definition                   || operator     | definition
------------|------------------------------||--------------|----------------
`<`         | less than                    ||`x`&nbsp;&#124;&nbsp;`y`     | `x` OR `y` 
`<=`        |	less than or equal to        ||`is.na(x)`    | test if `x` is `NA`
`>`         | greater than                 ||`!is.na(x)`   | test if `x` is not `NA`
`>=`        |	greater than or equal to     ||`x %in% y`    | test if `x` is in `y`
`==`        |	exactly equal to             ||`!(x %in% y)` | test if `x` is not in `y`
`!=`        |	not equal to                 ||`!x`          | not `x`
`x & y`     | `x` AND `y`                  ||              |

---
layout: true

## Which market segments book most in advance?

.pull-left-narrow.smaller-table[
```{r echo=FALSE}
hotels %>% 
  group_by(market_segment) %>% 
  summarize(lead_time = mean(lead_time)) %>% 
  arrange(desc(lead_time)) %>% 
  knitr::kable()
```
]

---

.pull-right-wide[
How would we compute this?
]

---

.pull-right-wide[
```{r}
hotels %>% 
  group_by(market_segment) %>% 
  summarize(
    lead_time = mean(lead_time))
```
]

---

.pull-right-wide[
```{r}
hotels %>% 
  group_by(market_segment) %>% 
  summarize(
    lead_time = mean(lead_time)) %>% 
  arrange(desc(lead_time))
```
]

---
layout: true

## How many total nights for each booking?

---

```{r}
hotels %>% 
  select(hotel, stays_in_week_nights, stays_in_weekend_nights)
```

```{r eval=FALSE}
hotels %>% 
  mutate( #<<
    num_nights = ____)
```

---

```{r}
hotels %>%
  mutate( #<<
    num_nights = stays_in_week_nights + stays_in_weekend_nights) %>% 
  select(hotel, num_nights)
```

---
layout: false

## How long did each market segment stay?

--

```{r}
hotels %>%
  mutate(
    num_nights = stays_in_week_nights + stays_in_weekend_nights) %>% 
  group_by(market_segment) %>% 
  summarize(num_nights = mean(num_nights)) %>% 
  arrange(desc(num_nights))
```

---

## How many in each market segment was a repeating guestguest?

```{r}
hotels %>% distinct(is_repeated_guest)
```

--

```{r fraction_repeated}
hotels %>% 
  group_by(market_segment) %>% 
  summarize(frac_repeat = mean(is_repeated_guest)) %>% 
  ggplot(aes(y = fct_reorder(market_segment, frac_repeat), x = frac_repeat)) +
    geom_col()
```

