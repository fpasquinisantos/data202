---
title: "Making Inferences about Features"
author: "DATA 202 21FA"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "slides.css"]
    lib_dir: libs
    self_contained: false
    nature:
      ratio: "4:3"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r setup, include=FALSE, code=xfun::read_utf8('../slide-setup.R')}
```

```{r setup2, include=FALSE}
if (interactive()) source('../slide-setup.R')
library(tidyverse)
library(tidymodels)
library(patchwork)
library(vip)
```

## Logistics

- Final projects
- Midterm 2??
- Discussions
- Quizzes and Homework

---

## What's your goal?

* **Predict** unseen labels
  * How much will this house sell for?
  * Does this child have autism?
  * Is this a positive or negative movie review?
* **Infer** relationships between features and labels
  * How much does home size affect price?
  * Is DNA methylation a marker of autism?
  * Does "sick" indicate a positive or negative review?
* Understand the **causal** effect of interventions
  * How much will building an addition increase the price of my home?
  * Will antioxidants prevent autism?
  * Will cutting this scene make my movie get better reviews?

---

## Techniques for Inference

* Classical statistical inference
  * 2-sample t tests, chi squared tests, ANOVA, ...
  * inference about model parameters (coefficient standard errors etc.)
* Variable importance plots
* Benefit of adding each feature

---

## Objectives for Today

* Identify several different approaches for drawing conclusions about features
* Recognize potential challenges in making those inferences

---

## Palmer Penguins

.pull-left[
```{r penguins-logo, echo=FALSE, out.width="50%"}
include_graphics("https://raw.githubusercontent.com/allisonhorst/palmerpenguins/master/man/figures/logo.png")
```

```{r message=FALSE}
library(palmerpenguins)
penguins <- palmerpenguins::penguins %>% 
  filter(!is.na(bill_length_mm), !is.na(bill_depth_mm))
```
]

.pull-right[
```{r penguins-bill-depth, echo=FALSE}
include_graphics("https://raw.githubusercontent.com/allisonhorst/palmerpenguins/master/man/figures/culmen_depth.png")
```
]

.floating-source[
[Artwork by @allison_horst](https://allisonhorst.github.io/palmerpenguins/articles/art.html)
]
---

## How does bill length relate to bill depth?

.small-code[
```{r penguins-simpsons, warning=FALSE, echo=FALSE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(title = "Penguin bill dimensions", subtitle = "Palmer Station LTER", x = "Bill length (mm)", y = "Bill depth (mm)")
```
]

---

## How does bill length relate to bill depth?

```{r penguins-with-species, warning=FALSE, echo=FALSE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, color = species, shape = species)) +
  geom_point() +
  geom_smooth(method = "lm") +
  scale_color_manual(values = c("darkorange","purple","cyan4")) +
  labs(title = "Penguin bill dimensions",
       subtitle = "Bill length and depth for Adelie, Chinstrap and Gentoo Penguins at Palmer Station LTER",
       x = "Bill length (mm)",
       y = "Bill depth (mm)",
       color = "Penguin species",
       shape = "Penguin species") +
  theme(legend.position = c(0.85, 0.15),
        legend.background = element_rect(fill = "white", color = NA))
```

---

###  One big model

.panelset[
.panel[.panel-name[Fit Model]
```{r overall-model-fit}
overall_model <- linear_reg() %>%
  fit(bill_depth_mm ~ bill_length_mm, data = penguins)
tidy(overall_model, conf.int = TRUE)
```
]
.panel[.panel-name[Coefficients]
```{r overall-model-coef, message=FALSE, fig.asp = .3}
GGally::ggcoef_model(overall_model$fit) + labs(x = "Coefficient")
```
]

.panel[.panel-name[Predictions]
.small-code[
```{r single-model, message=FALSE}
augment(overall_model, penguins) %>% 
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +
    geom_point() +
    geom_line(aes(y = .pred), color = "blue", size = 1) +
    labs(title = "Penguin bill dimensions", subtitle = "Palmer Station LTER", x = "Bill length (mm)", y = "Bill depth (mm)")

```
]]
]

---

### Parallel slopes

.panelset[
.panel[.panel-name[Fit Model]
```{r parallel-slopes-fit}
parallel_slopes_model <- linear_reg() %>%
  fit(bill_depth_mm ~ bill_length_mm
      + species, #<<
      data = penguins)
tidy(parallel_slopes_model, conf.int = TRUE)
```
]
.panel[.panel-name[Coefficients]
```{r parallel-slopes-coef}
GGally::ggcoef_model(parallel_slopes_model$fit) + labs(x = "Coefficient")
```
]

.panel[.panel-name[Predictions]
.small-code[
```{r parallel-slopes-model, message=FALSE}
augment(parallel_slopes_model, penguins) %>% 
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm, color = species)) + #<<
    geom_point() +
    geom_line(aes(y = .pred), size = 1) +
    labs(title = "Penguin bill dimensions", subtitle = "Palmer Station LTER", x = "Bill length (mm)", y = "Bill depth (mm)")
```
]
]]

---

### Interactions

.panelset[
.panel[.panel-name[Fit Model]
```{r interaction-fit}
interaction_model <- linear_reg() %>%
  fit(bill_depth_mm ~ bill_length_mm
      * species, #<<
      data = penguins)
tidy(interaction_model, conf.int = TRUE)
```
]
.panel[.panel-name[Coefficients]
```{r interaction-coef}
GGally::ggcoef_model(interaction_model$fit) + labs(x = "Coefficient")
```
]

.panel[.panel-name[Predictions]
.small-code[
```{r interaction-model, message=FALSE}
augment(interaction_model, penguins) %>% 
  ggplot(aes(x = bill_length_mm, y = bill_depth_mm, color = species)) + #<<
    geom_point() +
    geom_line(aes(y = .pred), size = 1) +
    labs(title = "Penguin bill dimensions", subtitle = "Palmer Station LTER", x = "Bill length (mm)", y = "Bill depth (mm)")
```
]
]]

---

## LINE Assumptions for making inference

- **Linearity**: there's actually a linear relationship
- **Independence**: there's no pattern to the errors
- **Normality of residuals**: no major outliers
- **Equal variance of residuals**: variability doesn't change systematically

These are colloquial wordings. See textbook [section E.4](https://mdsr-book.github.io/mdsr2e/ch-regression.html#assumptions-underlying-regression) for technical and how to verify.

---

## Examples of broken assumptions

- **Linearity**: the hotter the temperature, the more each degree of temperature matters
- **Independence**: ridership for adjacent hours is similar
- **Normality of residuals**: spike in demand after championship game
- **Equal variance of residuals**: bigger variability in demand on weekends vs weekdays

---

## Variable Importance Plots

```{r load-data, echo=FALSE}
#data(ames, package = "modeldata")
ames <- AmesHousing::make_ames()
ames_all <- ames %>%
  filter(Gr_Liv_Area < 4000, Sale_Condition == "Normal") %>%
  mutate(across(where(is.integer), as.double)) %>%
  mutate(Sale_Price = Sale_Price / 1000)
rm(ames)
```

```{r train-test-split, echo=FALSE}
set.seed(10) # Seed the random number generator
ames_split <- initial_split(ames_all, prop = 2 / 3)
ames_train <- training(ames_split)
ames_test <- testing(ames_split)
```

.small-code[
```{r tree-vip, fig.asp=0.4}
regresion_workflow <- workflow() %>%  add_model(decision_tree(mode = "regression") %>% set_engine('rpart')) 

model <- regresion_workflow %>% 
  add_recipe(recipe(Sale_Price ~ ., data = ames_train)) %>% 
  fit(data = ames_train)

model %>% extract_fit_engine() %>% vip::vip(num_features = 15L)
```
]

---

## How much does it help to have a feature in?

```{r make-resamples, cache=TRUE, echo=FALSE}
set.seed(0)
resamples <- vfold_cv(ames_train, v = 10)
```

.small-code[
```{r tree-all-features, cache=TRUE}
regresion_workflow %>% 
  add_recipe(recipe(Sale_Price ~ ., data = ames_train)) %>% 
  fit_resamples(resamples = resamples, metrics = metric_set(mae, rmse)) %>% collect_metrics()
```



```{r tree-without-qual, cache=TRUE}
regresion_workflow %>% 
  add_recipe(recipe(Sale_Price ~ ., data = ames_train) %>% step_rm(ends_with("Qual"))) %>% #<<
  fit_resamples(resamples = resamples, metrics = metric_set(mae, rmse)) %>% collect_metrics()
```
]

---

## Variable Importance without the Quality Features

```{r tree-vip-without-qual, fig.asp = 0.4}
regresion_workflow %>% 
  add_recipe(recipe(Sale_Price ~ ., data = ames_train) %>% step_rm(ends_with("Qual"))) %>% #<<
  fit(data = ames_train) %>%
  extract_fit_engine() %>% vip::vip(num_features = 15L)
```


---

## Appendix: code

.small-code[
```{r get-labels, echo=FALSE}
labels_of_non_echoed_code <- setdiff(
  knitr::all_labels(echo == FALSE),
  c("setup", "get-labels")
)
```

```{r all-code, ref.label=labels_of_non_echoed_code, eval=FALSE}
```
]
