---
title: "HW 4: Python and Plotly"
output: 
  tufte::tufte_html:
    css: ../hw.css
    tufte_variant: "envisioned"
    highlight: pygments
link-citations: yes
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggformula)
library(plotly)
```

## Goals

We've been studying the *grammar of graphics* and the *grammar of data transformation*.
We have seen both through the specific lenses of the "tidyverse" (specifically `ggplot2` and `dplyr`).
But these concepts also help us understand and work with a variety of different tools.
This week we'll look at two of them: Plot.ly and Seaborn.

Seaborn is a Python package, so we'll also be learning how we can get two
programming languages to work together. Fortunately almost all of the hard
work is already done for us thanks to a package called `reticulate`.

Our specific goal will be to redo some graphs from Homework 1.

## *Before* getting started

In the R **console** (not the R Markdown document), run the following:

```{r}
library(reticulate)
py_discover_config()
```

What happens next depends on whether you're on a Calvin machine or your own computer.

**If you are on the RStudio server or one of the lab machines**, you should see something like:

```
python:         /opt/anaconda/bin/python
libpython:      /opt/anaconda/lib/libpython3.7m.so
pythonhome:     /opt/anaconda:/opt/anaconda
version:        3.7.4 (default, Aug 13 2019, 20:35:49)  [GCC 7.3.0]
numpy:          /opt/anaconda/lib/python3.7/site-packages/numpy
numpy_version:  1.17.2

NOTE: Python version was forced by RETICULATE_PYTHON
```

That means everything is already configured.

**If you're on your own computer**, you may need to `install.packages("reticulate")`.
Once you've done that and run the above lines, you'll probably see a message about installing
Miniconda. Answer "yes". When installation is done, run the following line to
ensure that the Python libraries we'll be using are installed (they should be
already installed on the RStudio server and lab machines).

```r
if (!py_module_available("seaborn")) py_install("seaborn")
# For later:
if (!py_module_available("pandas")) py_install("pandas")
if (!py_module_available("sklearn")) py_install("scikit-learn")
```

You may need to restart your R session (or RStudio) for everything to work.

## Tips

To make it easy to insert a Python code chunk: 

- Under the Tools menu, select "Modify Keyboard Shortcuts".
- Search for "Python"
- Map "Insert Chunk Python" to Command+Alt+Shift+i (because "Insert Chunk R" is Command+Alt+i).


## Getting Started

Find your repo in [our GitHub organization](https://github.com/Calvin-DS202-FA20/)
and clone it as usual.

**IMPORTANT**: To avoid crashes on the RStudio server, add the following line
directly below `library(reticulate)` in your `Rmd`:

```r
py_run_string("import matplotlib.pyplot as plt; plt.switch_backend('agg')")
```

Once you've added that, Knit and make sure that the Python code block runs.
Then, Run All in your R Markdown editor and make sure that the Python code runs there too.


*Note*: Since plotly generates HTML, we need to use the `html_document` output format
instead of `github_document`. (The template already reflects this change.)
The downside of this is that you won't be able to preview the HTML on GitHub.

The repo includes our HW 1 data. (You're welcome to use the re-wrangling of it
that we did for HW3 instead.)

```{r read-data, message=FALSE}
daily_rides <- read_csv("data/day.csv")
```



## Plotly

Plotly has interfaces in several different languages. For this assignment, we'll
try using the R interface.

The organization of the Plotly documentation can be confusing. Here's how I navigate it:

* For a broad overview and *narrative* documentation, see this book: [Interactive web-based data visualization with R, plotly, and shiny](https://plotly-r.com/index.html),
particularly the [Overview](https://plotly-r.com/overview.html) chapter.
* For a gallery of examples with code, see the [docs on the Plotly website](https://plotly.com/r/).
* For details of how to use a specific function, see that function's help (e.g., `?plot_ly`)

https://plotly-r.com/index.html

1. Replicate [Homework 1](https://cs.calvin.edu/courses/data/202/ka37/hw/hw01/hw01-warmup-inst.html) Exercise 4 using Plotly.

Try this in two ways: (1) constructing a plot with ggplot and using `ggplotly`
and (2) calling `plot_ly` directly.

The first approach will look like:

```{r eval=FALSE}
p <- ggplot(daily_rides, aes(x = ..., y = ...)) +
  geom_point() + 
  ...
ggplotly(p)
```

The second approach will look like (note that we use `%>%` instead of `+` and 
we need `~` before each variable name):

```{r eval=FALSE}
daily_rides %>% 
  plot_ly(x = ~..., y = ~...) %>% 
  add_markers() %>% 
  layout(title = "")
```

*Note*: Replicating the `geom_smooth` with `plot_ly` requires advanced tricks.
So just don't plot the smooth.

## Seaborn

[Seaborn](https://seaborn.pydata.org/) is a Python library for data visualization.
So to use it we're going to need to get our data into Python, and get the
graph back into our R Markdown environment. Fortunately, the `reticulate` package
takes care of the hard work.

### Getting data across the bridge

```{marginfigure}
Since this is Python, `.` actually means `get attribute`.
```

You can access R data from Python using `r.variable_name` or `r["variable_name"]`.
(The second approach is needed if you want to access a variable with a `.` in its
name, for example.) I recommend moving data over *once* using an explicit assignment
statement at the beginning of a code block, then using the Python variable exclusively.

```{python}
cars = r.mtcars
cars.head(5)
```

R `data.frame`s and `tibble`s get translated into a [Pandas](https://pandas.pydata.org/)
DataFrame. They'll look a bit different and have a bit different functionality,
but the underlying concepts are nearly the same. We'll learn more about how
Pandas works in coming weeks. For now, here are two useful Pandas methods (besides
`.head()` which you just saw above):

```{python}
cars.info()
cars.describe()
```

### Seaborn

Now that we know how to get data into Python, we can use Seaborn. The easiest way
to make a plot is to look in the [gallery](https://seaborn.pydata.org/examples/index.html)
to find a similar plot and adapt the code. To go deeper, the [tutorial](https://seaborn.pydata.org/tutorial.html)
gives an overview of how Seaborn works, and the [API](https://seaborn.pydata.org/api.html)
documents each function individually.

The canonical way to import `seaborn` is:

```python
import matplotlib.pyplot as plt
import seaborn as sns
```

Finally, to get the plot to show up in R Markdown, you may need to use
`plt.show()` at the end of your code chunk.

### Matplotlib

Seaborn builds on [Matplotlib](https://matplotlib.org/), which is a low-level
plotting library for Python. It's very powerful but (I think) has a very
confusing API. Unfortunately, tasks like setting axis labels require digging
into Matplotlib. See the example below for how to do that, and the Matplotlib
[tutorials](https://matplotlib.org/tutorials/index.html) and [example gallery]
(https://matplotlib.org/gallery/index.html) for more advanced customizations.


2. Replicate Homework 1 Exercise 4 using Seaborn.

Use [`relplot`](https://seaborn.pydata.org/generated/seaborn.relplot.html#seaborn.relplot).
The aesthetic mappings are very similar to `ggplot`, though Seaborn treats
`row` and `col` (column) as aesthetics instead of facets, and names a few aesthetics
(like `color`) differently.

Here's a start for you; you'll need to change at least two things to replicate
the exercise.

*Note*: Seaborn's smoothing functions don't work with dates. So don't try to
replicate the `geom_smooth`.

```{python}
import matplotlib.pyplot as plt
import seaborn as sns
```


```{python}
rides = r.daily_rides
sns.relplot(x = "date", y = "total", kind = "line", data = rides);
plt.xlabel("Date")
plt.ylabel("Total number of rides")
plt.show()
```

