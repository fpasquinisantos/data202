---
title: "HW 3: Bikeshare Aggregation"
output: 
  tufte::tufte_html:
    css: ../hw.css
    tufte_variant: "envisioned"
    highlight: pygments
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Disable a warning message.
options(dplyr.summarise.inform = FALSE)

show_df <- function(x, ...) {
  if (knitr::is_latex_output() || knitr::is_html_output())
    # Knitting
    knitr::kable(x, ...)
  else
    # Running chunks. kable is annoying in that case.
    x
}
```


<!-- For next time: -->
<!-- "Thread it through" needs more explanation (add to grouping variables) -->
<!-- Students got confused about "Unknown" vs NA -->



In this exercise, we'll continue our study of the bike sharing data, but we’re
starting to take off the training wheels: rather than using
pre-wrangled data, you’ll be doing some of the data wrangling yourself!

In this exercise you'll:

* *refine* your skills in creating reproducible documents (R Markdown), graphics (ggplot2), and filtering functions
* *practice* grouping and aggregation functions
* *see* some ways to work with dates

## Getting started

Pull your portfolio repo and find `hw/hw03`. Edit title and author, knit commit push, you know the drill.

The template uses the following packages.

```{r packages, message=FALSE}
library(tidyverse)
library(lubridate)
# Import some functions from lubridate using less confusing names
get_year <- lubridate::year; get_month <- lubridate::month; get_day <- lubridate::day; get_weekday <- lubridate::wday
```


# Load Data

We downloaded the data from the [Capital BikeShare program](https://www.capitalbikeshare.com/system-data). Note the license agreement there. We removed some columns of the data that we aren't using to reduce the size of the dataset you have to download.

The data files are broken up by year. Here we read in the data for 2011, which is the first of the two years included in the dataset for Homework 1 and 2.
The template already includes these lines, so you can just Run All to get the data loaded.

```{marginfigure}
*Optionally*, once you finish with the rest of the homework, you can use the commented code to load 2012 data.
You will also need the code in the Appendix to download the 2012 data since it was not included in your repo.
```


```{r load-data}
# Read the 2011 data, specifying data types for each column.
rides_2011 <- read_csv("data/rides_2011.csv.xz", col_types = cols(
  start_time = col_datetime(),
  duration = col_double(),
  rider_type = col_factor()
))
# Optional extension: read the 2012 data.
# This is commented out in the template to reduce memory and disk space usage.
# Note: you'll need to run the code in the Appendix to download this data.
#
# rides_2012 <- read_csv("data/rides_2012.csv.xz", col_types = cols(
#   start_time = col_datetime(),
#   duration = col_double(),
#   rider_type = col_factor()
# ))
rides <- bind_rows(
  rides_2011
  #rides_2012
)
```


Each row is a *ride*. For each ride we're given the start time of the trip, its duration, and rider type.

```{marginfigure}
According to the website:

Member Type – Indicates whether user was a "registered" member (Annual Member, 30-Day Member or Day Key Member) or a "casual" rider (Single Trip, 24-Hour Pass, 3-Day Pass or 5-Day Pass)
```

::: {.exercises}

1. Report some basic size and content information about the `rides` data frame.

2. What units is `duration` probably measured in? Use a reproducible computation from the data to justify your answer.

```{r include=FALSE}
rides %>% summarize(median(duration) / 60, max(duration) / 60 / 60)
```


*Supplemental exercise*: Try making a new column with `duration` in a different unit. For example, if `duration` was in years, 
you could create a column `duration_months` by computing `duration * 12`. Once you have that, try to *round* the result to the nearest whole number using `round(THING)`.

3. Make a table that shows how many rides were taken by registered riders and how many were taken by non-registered riders. Example result:

```{marginfigure}
We used `knitr::kable()` to make the tables in these instructions look nice.
You can give it a try--once you have everything else working!

Also, you may use `count` if you know it, but I really recommend you use `summarize(n = n())`--overall it is less confusing.
```

```{r count-rider-type, echo=FALSE}
rides %>%
  group_by(rider_type) %>% 
  summarize(rides = n()) %>% 
  show_df()
```

4. Create a dataframe like the one used in Homework 2 that includes the number of rides in each day, broken down by rider type. Call it `daily_rides`. Suggested steps:

    1. Make columns for the year, month, and day. Within a `mutate`, you can use `get_year(start_time)` to pull the year out of a timestamp.
    2. Count the number of rides for each combination of year, month, day, and rider type.

The first few rows should look like:

```{r echo=FALSE}
daily_rides <- rides %>% 
  mutate(year = get_year(start_time), month = get_month(start_time), day = get_day(start_time), weekday = get_weekday(start_time, label = TRUE)) %>% 
  group_by(year, month, day) %>% 
  summarize(rides = n())
daily_rides %>% head() %>% show_df()
```

*Hint*: If you're having any trouble with this, go back to Exercise 2 and do the Supplemental Exercise there. You'll need a very similar approach here.

5. How many rows does `daily_rides` have? How many *should* it have? Do those two numbers match?

6. Make `daily_rides_by_type`, a data frame just like `daily_rides` but breaking down the count by casual vs registered rider, like the data in hw02 did. (Hint: think about how many rows *this* data frame should have.) The first few rows of the result should look like:

```{r count-by-hour-and-rider-type, echo=FALSE}
daily_rides_by_type <- rides %>% 
  mutate(year = get_year(start_time), month = get_month(start_time), day = get_day(start_time), weekday = get_weekday(start_time, label = TRUE)) %>% 
  group_by(year, month, day, weekday, rider_type) %>% 
  summarize(rides = n())
daily_rides_by_type %>% ungroup() %>% select(-weekday) %>% head() %>% show_df()
```



7. Recreate the "How does ridership vary over a typical week?" plot from [Homework 2](https://cs.calvin.edu/courses/data/202/21fa/hw/hw02/hw02-vis-inst.html) using this dataset.

Notes:

- There was a reason that the exercises are in this order.
- Add a column named `weekday`. Here's an expression that will get a labeled day of the week from a timestamp: `get_weekday(start_time, label = TRUE)`
  - You'll need to add this column early enough that you still have a `start_time`, but think about how to "thread it through" your aggregation so you still have it at the end.
  - Make sure that the number of rows doesn't change when you do this!
- Omit the "Unknown" rider type.
- If you're only using the 2011 rides, the specific values will be a bit different than what you saw in hw02 because that also included 2012.
  You can add the 2012 data too if you like; see the notes at the beginning and in the Appendix.

For reference, here's what I got when I used this dataset:

```{r recreate-hw02, echo=FALSE}
daily_rides_by_type %>% 
  filter(rider_type != "Unknown") %>% 
  ggplot(aes(x = weekday, y = rides / 1000, fill = rider_type)) +
    geom_boxplot() +
    labs(y = "Rides (thousands)", x = "Day of Week", fill = "Type of Rider", title = "Distribution of rides by day of week")
```

8. Show the same summary as the plot above, but in tabular form.

```{r weekday-rides-daily-medians, echo=FALSE}
weekday_rides_medians <- daily_rides_by_type %>% 
  filter(rider_type != "Unknown") %>% 
  group_by(weekday, rider_type) %>% 
  summarize(median_rides = median(rides))
weekday_rides_medians %>% show_df()
```


### Bonus: make it look pretty

Now that you've gotten the basic table, let's tweak it to make the result look better by adding two steps to the end of your pipeline. (**Make sure you get the above working before trying this.**)

- `pivot_wider(names_from = rider_type, values_from = median_rides)`
- `knitr::kable()`

When you *knit*, you should see:

```{r rides-by-weekday-table-daily, echo=FALSE}
weekday_rides_medians %>% 
  pivot_wider(names_from = rider_type, values_from = median_rides) %>% 
  show_df()
```

:::

## Appendix: Preprocessing

This is the code that I used to download and preprocess the dataset. If you want the 2012 data, you'll need to run the commented-out `preprocFile` code to get it.

```{r eval=FALSE}
preprocFile <- function(url, destFile) {
  data <- url %>%
    pins::pin() %>%
    map_dfr( ~ read_csv(
      .,
      col_types = cols_only(
        Duration = col_double(),
        `Start date` = col_datetime(format = ""),
        `Member type` = col_character()
      )
    )) %>%
    select(start_time = `Start date`,
         duration = `Duration`,
         rider_type = `Member type`)
  write_csv(data, destFile)
  #system2("gzip", c("-9v", destFile))
  system2("xz", c("--best", destFile))
}
preprocFile(
  "https://s3.amazonaws.com/capitalbikeshare-data/2011-capitalbikeshare-tripdata.zip",
  "data/rides_2011.csv"
)
# preprocFile(
#   "https://s3.amazonaws.com/capitalbikeshare-data/2012-capitalbikeshare-tripdata.zip",
#   "rides_2012.csv"
# )
```

