---
title: "Joining data from multiple sources"
author: "DATA 202 21FA, based on [datasciencebox.org](https://datasciencebox.org/)"
output:
  xaringan::moon_reader:
    css: ["xaringan-themer.css", "slides.css"]
    lib_dir: libs
    nature:
      ratio: "4:3"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
---

```{r child = "../slide-setup.Rmd"}
```

```{r packages, include=FALSE}
knitr::opts_chunk$set(comment = "")
options(dplyr.print_max = 10)

library(tidyverse)
xaringanExtra::use_freezeframe(overlay = TRUE)
```


```{r include=FALSE}
notability <- tibble::tribble(
                 ~name,                                                                                              ~known_for,
        "Ada Lovelace",                                                                              "first computer algorithm",
         "Marie Curie", "theory of radioactivity,  discovery of elements polonium and radium, first woman to win a Nobel Prize",
        "Janaki Ammal",                                                               "hybrid species, biodiversity protection",
     "Chien-Shiung Wu",         "confim and refine theory of radioactive beta decy, Wu experiment overturning theory of parity",
   "Katherine Johnson",                  "calculations of orbital mechanics critical to sending the first Americans into space",
          "Vera Rubin",                                                                              "existence of dark matter",
         "Gladys West",      "mathematical modeling of the shape of the Earth which served as the foundation of GPS technology",
  "Flossie Wong-Staal",          "first scientist to clone HIV and create a map of its genes which led to a test for the virus",
     "Jennifer Doudna",             "one of the primary developers of CRISPR, a ground-breaking technology for editing genomes"
  ) %>% arrange(name)

notability_multi <- tibble::tribble(
                 ~name,                                                                                         ~known_for,
        "Ada Lovelace",                                                                         "first computer algorithm",
         "Marie Curie",                                                                          "theory of radioactivity",
         "Marie Curie",                                                        "discovery of elements polonium and radium",
         "Marie Curie",                                                                 "first woman to win a Nobel Prize",
        "Janaki Ammal",                                                                                   "hybrid species",
        "Janaki Ammal",                                                                          "biodiversity protection",
     "Chien-Shiung Wu",                                                "confim and refine theory of radioactive beta decy",
     "Chien-Shiung Wu",                                                       "Wu experiment overturning theory of parity",
   "Katherine Johnson",             "calculations of orbital mechanics critical to sending the first Americans into space",
          "Vera Rubin",                                                                         "existence of dark matter",
         "Gladys West", "mathematical modeling of the shape of the Earth which served as the foundation of GPS technology",
  "Flossie Wong-Staal",     "first scientist to clone HIV and create a map of its genes which led to a test for the virus",
     "Jennifer Doudna",        "one of the primary developers of CRISPR, a ground-breaking technology for editing genomes"
  )

professions <- tibble::tribble(
                 ~name,                          ~profession,
        "Ada Lovelace",                      "Mathematician",
         "Marie Curie",              "Physicist and Chemist",
        "Janaki Ammal",                           "Botanist",
     "Chien-Shiung Wu",                          "Physicist",
   "Katherine Johnson",                      "Mathematician",
   "Rosalind Franklin",                            "Chemist",
          "Vera Rubin",                         "Astronomer",
         "Gladys West",                      "Mathematician",
  "Flossie Wong-Staal", "Virologist and Molecular Biologist",
     "Jennifer Doudna",                         "Biochemist"
  )

professions_multi <- tibble::tribble(
                 ~name,                          ~profession,
        "Ada Lovelace",                      "Mathematician",
         "Marie Curie",              "Physicist",
         "Marie Curie",              "Chemist",
        "Janaki Ammal",                           "Botanist",
     "Chien-Shiung Wu",                          "Physicist",
   "Katherine Johnson",                      "Mathematician",
   "Rosalind Franklin",                            "Chemist",
          "Vera Rubin",                         "Astronomer",
         "Gladys West",                      "Mathematician",
  "Flossie Wong-Staal", "Virologist",
  "Flossie Wong-Staal", "Molecular Biologist",
     "Jennifer Doudna",                         "Biochemist"
  )

dates <- tibble::tribble(
                          ~name, ~birth_year, ~death_year,
                 "Janaki Ammal",       1897L,       1984L,
              "Chien-Shiung Wu",       1912L,       1997L,
            "Katherine Johnson",       1918L,       2020L,
            "Rosalind Franklin",       1920L,       1958L,
                   "Vera Rubin",       1928L,       2016L,
                  "Gladys West",       1930L,          NA,
           "Flossie Wong-Staal",       1947L,          NA,
              "Jennifer Doudna",       1964L,          NA
           )


nobel <- read_csv("../../ex/ex04/data/nobel.csv")

```

## Q&A

> What does `%in%` do?

- Don't confuse with `%>%` or `==`

```{r eval=FALSE}
nobel %>% filter(country == c("USA", "France"))
```

(doesn't work!)

```{r}
nobel %>% filter(country %in% c("USA", "France"))
```

---

## Q&A

> How do I remember all this syntax and keep everything straight?

It takes work. But you can do it. Tips:

- Don't "just make it work".
- Understand *why* something works (explain it!)
- Try out variations!

---

## Data: Women in science 

Information on 10 women in science who changed the world

.small[
```{r echo=FALSE}
professions %>% select(name) %>% kable()
```
]

.floating-source[
Source: [Discover Magazine](https://www.discovermagazine.com/the-sciences/meet-10-women-in-science-who-changed-the-world)
]

---


## Inputs

.panelset[

.panel[.panel-name[professions]
```{r}
professions
```
]

.panel[.panel-name[dates]
```{r}
dates
```
]

.panel[.panel-name[notability]
```{r}
notability
```
]

]

---

## Desired output

```{r echo=FALSE}
professions %>%
  left_join(dates) %>%
  left_join(notability)
```

---

## First try: paste them together

```{r echo=FALSE}
professions %>% head(9) %>% bind_cols(notability %>% select(-name)) %>% knitr::kable()
```

---

## What was wrong?

--

How do we know which rows match up?

--

Need a **key**.

.question[What can serve as a **key** for this data?]

---

## **Mutating** joins

* I have a data frame `x`
* I want extra information about things in `x`
* Some other table, `y`, has that information.
* A "join" lets me look it up.
<!-- * Needs a <span style="background: blue; color: white; padding: 5px;">key</span> : what has to match. Must match *exactly*. -->

```{r echo=FALSE, out.width="30%", fig.align='center'}
include_graphics("img/original-dfs.png")
```

.small[Graphics thanks to [tidyexplain](https://github.com/gadenbuie/tidyexplain)]


---

## Types of joins

If `x` and `y` match up one-to-one, no difference.

What to do when things don't exactly line up?

* **full** or **outer** join: Leave blanks (`NA`) for mismatches
* **inner** join: Drop rows with any mismatches
* **left** / **right** join: Drop rows where one of the sides has a mismatch

---

## Setup

.pull-left[
```{r echo=FALSE}
x <- tibble(key = c(1, 2, 3), xdata = paste0('x', key))
y <- tibble(key = c(1, 2, 4), ydata = paste0('y', key))
```

```{r}
x
y
```
]
.pull-right[
```{r echo=FALSE}
include_graphics("https://raw.githubusercontent.com/gadenbuie/tidyexplain/master/images/static/png/original-dfs.png")
```
]

---

## `left_join()`

All rows from `x`.

.pull-left[
```{r}
left_join(x, y, by = "key")
```
]
.pull-right[
```{r echo=FALSE}
include_graphics("img/left-join.gif")
```
]


---

## `left_join()`

```{r}
professions %>%
  left_join(dates) #<<
```

---

## `right_join()`

All rows from `y`.

.pull-left[
```{r}
right_join(x, y)
```
]
.pull-right[
```{r echo=FALSE}
include_graphics("img/right-join.gif")
```
]


---

## `right_join()`


```{r}
professions %>%
  right_join(dates) #<<
```


---

## `full_join()`

All rows from both `x` and `y`. Leave `NA` for mismatches.

.pull-left[
```{r}
full_join(x, y, by = "key")
```
]
.pull-right[
```{r echo=FALSE}
include_graphics("img/full-join.gif")
```
]

---

## `full_join()`

```{r}
dates %>%
  full_join(notability) #<<
```


---

## `inner_join()`

All matching rows. Drops mismatches.

.pull-left[
```{r}
inner_join(x, y, by = "key")
```
]
.pull-right[
```{r echo=FALSE}
include_graphics("img/inner-join.gif")
```
]

---

## `inner_join()`

```{r}
dates %>%
  inner_join(notability) #<<
```


---

## Summary of Mutating Joins

- `full_join()`: all rows from both `x` and `y`
- `inner_join()`: all *matching* rows from `x` where there are matching values in y.
- `left_join()`: all rows from `x`
- `right_join()`: all rows from `y`

Multiple matches? Return all combinations.

---


.question[
We want to get the dates and works of all the scientists. Which join function should we use?
]

```{r echo=FALSE}
professions %>%
  left_join(dates) %>%
  left_join(notability)
```


---

.pull-left[
```{r}
names(professions)
names(dates)
names(notability)
```
]
.pull-right[
```{r}
nrow(professions)
nrow(dates)
nrow(notability)
```
]

---

```{r}
professions %>%
  left_join(dates) %>%
  left_join(notability)
```


---

class: middle

# Case study: Grocery sales

---

## Grocery sales

- Have:
  - *Purchases*: One row per customer per item, listing purchases they made
  - *Prices*: One row per item in the store, listing their prices
- **Want**: Total revenue

```{r include=FALSE}
purchases <- tibble::tribble(
               ~customer_id,          ~item,
                         "c1",        "bread",
                         "c1",         "milk",
                         "c1",       "banana",
                         "c2",         "milk",
                         "c2", "toilet paper"
               )

prices <- tibble::tribble(
           ~item, ~price,
       "avocado",    0.5,
        "banana",   0.15,
         "bread",      1,
          "milk",    0.8,
  "toilet paper",      3
  )
```

.pull-left[
```{r eval=FALSE}
purchases
```

```{r echo = FALSE}
purchases %>% kable()
```
]
.pull-right[
```{r eval = FALSE}
prices
```

```{r echo=FALSE}
prices %>% kable()
```

]

---

## Grocery sales

```{r}
purchases %>% 
  left_join(prices) #<<
```


---

## Grocery sales

.panelset[

.panel[.panel-name[Total revenue]
.pull-left[
```{r}
purchases %>% 
  left_join(prices) #<<
```
]
.pull-right[
```{r}
purchases %>% 
  left_join(prices) %>%
  summarize(total_revenue = sum(price)) #<<
```
]
]

.panel[.panel-name[Revenue per customer]

.pull-left[
```{r}
purchases %>% 
  left_join(prices)
```
]
.pull-right[
```{r}
purchases %>% 
  left_join(prices) %>%
  group_by(customer_id) %>% #<<
  summarize(total_revenue = sum(price))
```
]

]

]

---

## Extension: Multiple matching rows

.panelset[

.panel[.panel-name[professions_multi]
```{r}
professions_multi
```
]

.panel[.panel-name[dates]
```{r}
dates
```
]

.panel[.panel-name[notability_multi]
```{r}
notability_multi
```
]

]


---

## Other types of joins

These are less common:

*filtering* joins

- `semi_join()`: include a row from `x` only if there's some match in `y`
- `anti_join()`: include a row from `x` only if there's *no* match in `y`

*nest* join

- `nest_join()`: get bundles of all matching rows from `y` (most flexible)

---

## Specifying keys

- Keys must match *exactly*
- Can join on multiple columns (first name **and** last name)
- Default join: columns with same names
- Specify what columns to use: `left_join(x, y, by = c("first_name", "last_name"))`

---

class: center, middle

## General notes


---

## A note on `mutate`

* Badly named. Think "add_computed_column".
* **DON'T** think of it operating on a variable ("mutate the ride's start time").
* **DO** think of it operating on a data frame ("add a column computed by
flooring the start time)

---

## Speaking of better names

> `select` vs `filter`?

Maybe should have been named `select_columns` and `select_rows`.
