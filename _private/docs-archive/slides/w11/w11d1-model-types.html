<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Different Types of Models</title>
    <meta charset="utf-8" />
    <meta name="author" content="DATA 202 21FA" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/font-awesome/css/all.css" rel="stylesheet" />
    <link href="libs/font-awesome/css/v4-shims.css" rel="stylesheet" />
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link href="libs/tile-view/tile-view.css" rel="stylesheet" />
    <script src="libs/tile-view/tile-view.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Different Types of Models
### DATA 202 21FA

---







.small-code[

```r
data(ames, package = "modeldata")
ames_all &lt;- ames %&gt;%
  filter(Gr_Liv_Area &lt; 4000, Sale_Condition == "Normal") %&gt;%
  mutate(across(where(is.integer), as.double)) %&gt;%
  mutate(Sale_Price = Sale_Price / 1000)
rm(ames)
```


```r
metrics &lt;- yardstick::metric_set(mae, mape, rsq_trad)

set.seed(10) # Seed the random number generator
ames_split &lt;- initial_split(ames_all, prop = 2 / 3)
ames_train &lt;- training(ames_split)
ames_test &lt;- testing(ames_split)
```







```r
model2 &lt;-
  decision_tree(mode = "regression", tree_depth = 30) %&gt;%
  fit(Sale_Price ~ Latitude + Longitude, data = ames_train)
```
]

---

## Objectives

What type of model for what type of data?

- Describe how a Random Forest makes predictions
- Describe how a linear model makes predictions
- Compare and contrast linear and tree models

Reference: [Fitting and Predicting with `parsnip`](https://parsnip.tidymodels.org/articles/articles/Examples.html)

---

class: center, middle

# Random Forests

---

## Why?









&lt;img src="w11d1-model-types_files/figure-html/compare-models-traintest-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

## Using random forests


```r
forest1 &lt;- rand_forest(mode = "regression") %&gt;% 
  fit(Sale_Price ~ Latitude + Longitude, ames_train)
show_latlong_model(ames_train, forest1)
```

&lt;img src="w11d1-model-types_files/figure-html/show-forest1-1.png" width="60%" style="display: block; margin: auto;" /&gt;

---

## A random forest has many trees.


```r
forest_internals &lt;- extract_fit_engine(forest1)
forest_internals
```

```
Ranger result

Call:
 ranger::ranger(x = maybe_data_frame(x), y = y, num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1)) 

Type:                             Regression 
Number of trees:                  500 
Sample size:                      1608 
Number of independent variables:  2 
Mtry:                             1 
Target node size:                 5 
Variable importance mode:         none 
Splitrule:                        variance 
OOB prediction error (MSE):       1444.623 
R squared (OOB):                  0.6894006 
```

---

## Each tree was trained on a different subset of data


```r
ranger::treeInfo(forest_internals, 1) %&gt;% select(-splitvarID) %&gt;% head(10) %&gt;% kable()
```



| nodeID| leftChild| rightChild|splitvarName |  splitval|terminal | prediction|
|------:|---------:|----------:|:------------|---------:|:--------|----------:|
|      0|         1|          2|Latitude     |  42.04601|FALSE    |         NA|
|      1|         3|          4|Latitude     |  42.01889|FALSE    |         NA|
|      2|         5|          6|Latitude     |  42.05305|FALSE    |         NA|
|      3|         7|          8|Longitude    | -93.63958|FALSE    |         NA|
|      4|         9|         10|Longitude    | -93.67910|FALSE    |         NA|
|      5|        11|         12|Longitude    | -93.64695|FALSE    |         NA|
|      6|        13|         14|Longitude    | -93.65092|FALSE    |         NA|
|      7|        15|         16|Longitude    | -93.65184|FALSE    |         NA|
|      8|        17|         18|Latitude     |  41.99299|FALSE    |         NA|
|      9|        19|         20|Latitude     |  42.02273|FALSE    |         NA|

---

## RF averages the predictions of each tree


```r
forest_internals %&gt;% 
  predict(
    data = ames_test %&gt;% head(8),
    predict.all = TRUE, num.trees = 5) %&gt;% 
  pluck("predictions")
```

```
       [,1]     [,2]    [,3]     [,4]     [,5]
[1,] 185.00 192.7500 185.750 191.0000 187.1000
[2,] 186.25 178.8333 225.000 176.7500 615.0000
[3,] 171.20 185.0000 173.500 166.5000 170.0000
[4,] 246.60 214.8333 209.750 215.7000 237.5000
[5,] 173.00 160.8000 320.759 278.0000 229.0883
[6,] 173.00 182.8000 320.759 278.0000 229.0883
[7,] 203.00 200.2667 164.380 160.9500 188.0000
[8,] 227.00 227.3250 231.875 226.6667 233.5800
```




---

## Value of Diversity

.scripture[
```
I looked and there before me
was a great multitude that no one could count,
from every nation, tribe, people and language,
standing before the throne.
```

.ref[Revelation 7:9, as quoted in Calvin's "From Every Nation"]
]

- Random Forests work because they combine diverse perspectives (from different training data, different choices)
- Reflects value of diversity in God's Kingdom (see also Rev 5:9, 1 Cor 12, etc.)

---

class: center, middle

# Linear Models

---

## Fitting a linear model


```r
linear_model &lt;- linear_reg() %&gt;%
  fit(Sale_Price ~ Gr_Liv_Area, data = ames_train)
linear_model
```

```
parsnip model object

Fit time:  3ms 

Call:
stats::lm(formula = Sale_Price ~ Gr_Liv_Area, data = data)

Coefficients:
(Intercept)  Gr_Liv_Area  
    22.9161       0.1029  
```

---

## Aside: you may have seen this in stats class.


```r
stats::lm(
  formula = Sale_Price ~ Gr_Liv_Area,
  data = ames_train)
```

```

Call:
stats::lm(formula = Sale_Price ~ Gr_Liv_Area, data = ames_train)

Coefficients:
(Intercept)  Gr_Liv_Area  
    22.9161       0.1029  
```


---

We'll use one example home from the test set.


```r
example_home &lt;- ames_test %&gt;% slice(1)
example_home %&gt;% select(Gr_Liv_Area, Sale_Price)
```

```
# A tibble: 1 × 2
  Gr_Liv_Area Sale_Price
        &lt;dbl&gt;      &lt;dbl&gt;
1        1804        189
```

---


## What computations can a linear model do?

* *Add* up terms.
* Each term: *multiply* a number by a constant.

.pull-left[

```r
intercept &lt;- 22.9161
coef_living_area &lt;- 0.1029
```



```r
intercept + coef_living_area * 1804
```

```
[1] 208.5477
```
]

.pull-right[.small-code[

```r
ggplot(ames_all, aes(x = Gr_Liv_Area, y = Sale_Price)) +
  geom_point(alpha = .25) +
  geom_hline(yintercept = example_home$Sale_Price, color = "red") +
  geom_vline(xintercept = example_home$Gr_Liv_Area, color = "red") +
  geom_point(data = example_home, color = 'red', size = 5) +
  geom_function(fun = function(x) intercept + coef_living_area * x, color = "blue")
```

&lt;img src="w11d1-model-types_files/figure-html/price-vs-liv-area-1.png" width="100%" style="display: block; margin: auto;" /&gt;
]]

---

## Do remodeled homes sell for more?

`Year Remod/Add`: Remodel date *(same as construction date if no remodeling or additions)*
(from dataset documentation)


```r
ames_2 &lt;- ames_train %&gt;% mutate(remodeled = Year_Remod_Add != Year_Built)
```


.small-code[

```r
ggplot(ames_2, aes(x = Gr_Liv_Area, y = Sale_Price, color = remodeled)) +
  geom_point(alpha = .25) +
  geom_smooth(method = "lm", se = FALSE)
```

&lt;img src="w11d1-model-types_files/figure-html/remodeled-1.png" width="70%" style="display: block; margin: auto;" /&gt;
]

---

## Aside: the *sum-as-count* pattern

.pull-left[

```r
ames_2 %&gt;%
  group_by(remodeled) %&gt;% 
  summarize(n = n()) %&gt;% 
  mutate(proportion = n / sum(n))
```

```
# A tibble: 2 × 3
  remodeled     n proportion
  &lt;lgl&gt;     &lt;int&gt;      &lt;dbl&gt;
1 FALSE       866      0.539
2 TRUE        742      0.461
```
]

.pull-right[

```r
ames_2 %&gt;% summarize(
  num_remodeled = sum(remodeled),
  prop_remodeled = mean(remodeled)
)
```

```
# A tibble: 1 × 2
  num_remodeled prop_remodeled
          &lt;int&gt;          &lt;dbl&gt;
1           742          0.461
```


Why does this work?



```r
as.numeric(remodeled[1:10])
```


```
 [1] 0 1 0 1 0 0 0 1 1 0
```

&lt;!--
.small[This code needs to run in an environment where `remodeled` is defined, like
a `mutate` or `summarize` of our dataset.]
--&gt;

Its *sum* is the number of 1's (rows where the condition is true). Its *mean* is the sum divided by the total number,
i.e., the *proportion*.

]

---

## Conditional Logic: Simple Conditions

How could a *linear model* treat remodeled homes differently from non-remodeled?

```
if remodeled:
  Sale_Price = intercept_remodeled + coef_sqft * Gr_Liv_Area
else:
  Sale_Price = intercept_other + coef_sqft * Gr_Liv_Area
```

--

### Solution: "**dummy encoding**"

```
Sale_Price = 
   intercept_other 
   + coef_remodeled * (1 if remodeled)
   + coef_sqft      * Gr_Liv_Area
```

---


```r
ames_train_2 &lt;- ames_train %&gt;% 
  mutate(remodeled = as_factor(Year_Built != Year_Remod_Add))
```


---

.small[


```r
ames_recipe_3 &lt;- 
  recipe(Sale_Price ~ Gr_Liv_Area + remodeled, data = ames_train_2) %&gt;% 
* step_dummy(remodeled) %&gt;%
  #step_range(all_numeric(), -all_outcomes(), min = 0, max = 1) %&gt;%
  prep()
baked_ames_train &lt;- 
  ames_recipe_3 %&gt;% bake(new_data = ames_train_2)
baked_ames_train %&gt;% head(5) %&gt;% knitr::kable(format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; Gr_Liv_Area &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Sale_Price &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; remodeled_TRUE. &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 912 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 123.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1120 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 148.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1589 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 226.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 666 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 64.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 2643 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 380.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]

Why are is there no column for `remodeled_FALSE`?

---

## Now, fit as normal.

.small[

```r
ames_model_2 &lt;- linear_reg() %&gt;% set_engine("lm") %&gt;% 
  fit(Sale_Price ~ ., data = baked_ames_train)
ames_model_2 %&gt;% tidy() %&gt;% select(term, estimate) %&gt;% kable()
```



|term            |    estimate|
|:---------------|-----------:|
|(Intercept)     |  27.7730315|
|Gr_Liv_Area     |   0.1043859|
|remodeled_TRUE. | -15.1087279|
]

```
Sale_Price = 
27.77303 
   + 0.1043859 * Gr_Liv_Area
   + -15.10873  * (1 if remodeled)
```

or, in "code":

```
if remodeled:
  Sale_Price = 27.8 + 0.1 * Gr_Liv_Area - -15.1 * (1)
  Sale_Price = (27.8 - -15.1) + 0.1 * Gr_Liv_Area
else:
  Sale_Price = 27.8 + 0.1 * Gr_Liv_Area
```

---


```r
ggplot(baked_ames_train, aes(x = Gr_Liv_Area, y = Sale_Price, color = remodeled_TRUE.)) +
  geom_point() +
  geom_function(fun = function(x) (22.6434248 - 18424.0789) + .1091132 * x, color = "blue") +
  geom_function(fun = function(x) 22.6434248 + .1091132 * x, color = "green")
```

&lt;img src="w11d1-model-types_files/figure-html/price-vs-liv-area-remodeled-1.png" width="100%" style="display: block; margin: auto;" /&gt;

---

## More than two options

```
Bldg Type (Nominal): Type of dwelling
       1Fam	Single-family Detached	
       2FmCon	Two-family Conversion; originally built as one-family dwelling
       Duplx	Duplex
       TwnhsE	Townhouse End Unit
       TwnhsI	Townhouse Inside Unit
```

.small-code[
&lt;img src="w11d1-model-types_files/figure-html/bldg-type-1.png" width="80%" style="display: block; margin: auto;" /&gt;
]

---


.small[

```r
ames_train %&gt;% count(Bldg_Type) %&gt;% kable()
```



|Bldg_Type |    n|
|:---------|----:|
|OneFam    | 1324|
|TwoFmCon  |   31|
|Duplex    |   52|
|Twnhs     |   68|
|TwnhsE    |  133|


```r
ames_recipe_4 &lt;- 
  recipe(Sale_Price ~ Gr_Liv_Area + Bldg_Type, data = ames_train) %&gt;% 
* step_dummy(Bldg_Type) %&gt;%
  prep()
baked_ames_train &lt;- 
  ames_recipe_4 %&gt;% bake(new_data = ames_train_2)
baked_ames_train %&gt;% head(5) %&gt;% knitr::kable(format = "html")
```

&lt;table&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:right;"&gt; Gr_Liv_Area &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Sale_Price &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Bldg_Type_TwoFmCon &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Bldg_Type_Duplex &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Bldg_Type_Twnhs &lt;/th&gt;
   &lt;th style="text-align:right;"&gt; Bldg_Type_TwnhsE &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 912 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 123.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1120 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 148.8 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 1589 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 226.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 1 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 666 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 64.5 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:right;"&gt; 2643 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 380.0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
   &lt;td style="text-align:right;"&gt; 0 &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "4:3",
"highlightLines": true,
"highlightStyle": "solarized-light",
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
