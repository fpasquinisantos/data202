---
title: "Quiz 5 Experimental Supplement"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
#remotes::install_github("rundel/learnrhash")
library(learnr)
library(tidyverse)
library(nycflights13)
library(lubridate)
# Disable a warning message.
options(dplyr.summarise.inform = FALSE)
```

## NYC Flights 2013

For the next questions on this quiz we will work with the following datasets 
from the `nycflights13` package, which has the following five data frames.

- `flights`: all flights that departed from NYC in 2013
- `weather`: hourly meterological data for each airport
- `planes`: construction information about each plane
- `airports`: airport names and locations
- `airlines`: translation between two letter carrier codes and names

You can find out more about the package and the data contained in it 
[here](https://cran.r-project.org/web/packages/nycflights13/nycflights13.pdf), 
though any information you need specifically to answer the questions should be 
provided along with the question.

## Data joins

We'll be working with the `flights` and `airports` tables. They look like:

```{r}
flights
airports
```


### Question 1

The `dest` variable in the flights dataset gives us the airport code of 
destinations of flights leaving New York City airports in 2013.The following 
shows us which destinations had the highest number of flights out of NYC in 2013.

```{r most-pop-dest}
flights %>% 
  count(dest, sort = TRUE)
```

However the result is given in airport codes, not in terms of the real 
names of the airports. To get further information on the airports, we can use 
the `airports` data frame, which has the following variables:

- `faa`: FAA airport code.
- `name`: Usual name of the aiport.
- `lat`, `lon`: Location of airport.
- `alt`: Altitude, in feet.
- `tz`: Timezone offset from GMT.
- `dst`: Daylight savings time zone. A = Standard US DST: starts on the second 
  Sunday of March, ends on the first Sunday of November. U = unknown. N = no dst.
- `tzone`: IANA time zone, as determined by GeoNames webservice.

By joining the earlier result with the `airports` data frame we should be able 
to figure out which airports (i.e. their real names) had the highest number of flights out of NYC in 2013.

You will need to figure out two pieces of the code to get the answer: (1) Which type of join function to use, and (2) which variables to join by.
We have not discussed the `c("variable_from_left" = "variable_from_right")` syntax in class yet, but you can fill in the blank or look at the 
documentation for the merge function you choose. (There is also a minor syntax error in the template code, which you'll need to fix.)

```{r most-pop-dest-joined, exercise=TRUE}
flights %>%
  count(dest, sort = TRUE)
  ___(airports, by = c("variable_from_left" = "variable_from_right"))
```


```{r q1, echo=FALSE}
question(
    "Which destination had the highest number of flights leaving New York City 
    airports in 2013?",
    random_answer_order = TRUE, allow_retry = TRUE,
    answer("Chicago Ohare Intl", correct = TRUE),
    answer("Los Angeles Intl"),
    answer("Aeropuerto Internacional Luis Muñoz Marín"),
    answer("Lansdowne Airport")
  )
```

### Question 3

In this question we don't need to use a join function explicitly, but we will use 
information we get from one data frame to make decisions in another data frame.

Suppose we are only interested in flights from JFK (John F. Kennedy airport, 
one of the three major airports in New York City). We want to first find the 
day with the highest mean temperature at JFK. We can do this using the following:

```{r hottest-day-jfk}
weather %>%
  filter(origin == "JFK") %>%
  group_by(month, day) %>%
  summarise(mean_temp = mean(temp)) %>%
  arrange(desc(mean_temp))
```

Looks like 16 July had the highest mean temperature, with 87.4 degrees Fahrenheit.

What was the average departure delay (`dep_delay`), excluding NAs, on this day 
from JFK? Fill in the pipeline below to get the answer.

```{r hottest-day-jfk-dep-delay, exercise=TRUE}
flights %>%
  filter(
    origin ___ ,         # filter for correct origin airport
    month  ___,          # filter for correct month
    day    ___           # filter for correct day
  ) %>%
  summarise(
    mean_dep_delay = ___ # calculate mean departure delay
    )
```

```{r q3, echo=FALSE}
question(
    "What is the average departure delay on the day with the higestest average 
    temperature at JFK?",
    allow_retry = TRUE,
    answer("11.2", message = "Are you sure you filtered for correct origin 
           airport?"),
    answer("16.7", correct = TRUE),
    answer("8.71", message = "Are you sure you filtered for the correct month?"),
    answer("23.8", message = "Are you sure you filtered for the correct day?"),
    answer("NA", message = "Are you sure you excluded flights with departure 
           delays that are NAs?")
  )
```

### Question 4

Now let's look at the coldest day at JFK:

```{r coldest-day-jfk}
weather %>%
  filter(origin == "JFK") %>%
  group_by(month, day) %>%
  summarise(mean_temp = mean(temp)) %>%
  arrange(mean_temp)
```

Looks like it was 23 January, with a temperature average of 15.6 degrees 
Fahrenheit.

Fill in the pipeline below to create a histogram for departure delays on this 
day and answer the question below according to your histogram. Note that the 
departure delays are given in minutes. Use a `binwidth` of 10 minutes for your 
histogram.

```{r coldest-day-jfk-dep-delay, exercise=TRUE}
flights %>%
  filter(
    origin ___ ,         # filter for correct origin airport
    month  ___,          # filter for correct month
    day    ___           # filter for correct day
  ) %>%
  ggplot(mapping = aes(x = ___)) ___
  ___
```

```{r q4, echo=FALSE}
question(
    "Which of the following is *false* based on the visualization above?",
    allow_retry = TRUE,
    answer("There are no flights with departure delays above 100 minutes.", 
           correct = TRUE),
    answer("The distribution of departure delays is right skewed."),
    answer("There are over 50 flights with negative departure delays, 
           indicating that flight took off before the scheduled time.", 
           message = "Are you sure you used the correct bin width?"),
    answer("There are no flights with departure delays above 200 minutes.", 
           message = "Are you sure you filtered for the correct day?")
  )
```

### Question 5

The `flights` data frame has information on all flights from NYC airports in 
2013. One of the variables in this data frame is `carrier`, which is the two 
letter abbreviation of the airline. The airlines data frame has information 
`carrier` (the same two letter abbreviation) as well as the `name` of the airline,
e.g. `AA` is the two letter abbreviation for `American Airlines`.

Run the following pieces of code and observe the output. The code comments are 
designed to draw your attention to important pieces of the output as well.


- The data frame resulting from `left_join()`ing `flights` and `airlines` data 
frames also has 336,776 observations.
- The data frame resulting from `full_join()`ing `flights` and `airlines` data 
frames also has 336,776 observations.
- The data frame resulting from `anti_join()`ing `flights` and `airlines` data 
frames also has 0 observations.

```{r flights-airlines, exercise=TRUE}
# flights has 336776 observations
nrow(flights)

# left_join: flights  & airlines has 336776 observations
flights %>%
  left_join(airlines) %>%
  nrow()

# full_join: flights  & airlines has 336776 observations
flights %>%
  full_join(airlines) %>%
  nrow()

# anti_join: flights  & airlines has 0 observations
flights %>%
  anti_join(airlines) %>%
  nrow()
```

```{r q5, echo=FALSE}
question(
    "Which of the following is true based on these results?",
    allow_retry = TRUE,
    answer("There are no flights in the `flights` data frame whose carrier 
           information is not in the `airlines` data frame.", correct = TRUE),
    answer("`flights` and `airlines` data frames have the same number of rows."),
    answer("`flights` and `airlines` data frames have the same number of 
           columns."),
    answer("There are some carriers `airlines` data frame who did not fly out 
           of NYC in 2013 so there are no flights from them in the `flights` 
           data frame."),
    answer("The `airlines` data frame has information on all carriers in the 
           world.")
  )
```

## Better data visualizations

### Question 7

In the code below we find out the top 5 carriers flying out of NYC in 2013, and 
assign their carrier abbreviations, as a vector, to `top_carriers`.

```{r}
top_carriers <- flights %>% 
  count(carrier, sort = TRUE) %>%
  slice_head(n = 5) %>%
  pull(carrier)
top_carriers
```

Then, we calculate mean monthly departure delays for these top carriers, join 
this information with airline information to get carrier names, and plot the 
monthly averages over time.

```{r mean-dep-delay-month-ugly}
flights %>%
  filter(carrier %in% top_carriers) %>%
  group_by(carrier, month) %>%
  summarise(
    mean_dep_delay = mean(dep_delay, na.rm = TRUE)
  ) %>%
  left_join(airlines) %>%
  ggplot(aes(x = month, y = mean_dep_delay, color = name)) +
  geom_line()
```

```{r q7, echo=FALSE}
question(
    "Which of the following would *necessarily* improve this visualization? 
    Check all that apply.",
    allow_retry = TRUE, random_answer_order = TRUE,
    answer("Replace x-axis labels with month names.", correct = TRUE),
    # answer("Place airline names at the end of lines on the plot instead 
    #        of in the legend.", correct = TRUE),
    # answer("Fix the axis labels to remove underscores and use proper 
    #        capitalization.", correct = TRUE),
    # answer("Add a title.", correct = TRUE),
    answer("Indicate units of mean departure time.", correct = TRUE),
    # answer("Flip the coordinates so months are on the y-axis and 
    #        mean departure delays are on the x-axis."),
    answer("Change the background color of the plot."),
    answer("Change the colors of the lines.")
    # answer("Use bars instead of lines to represent the data.")
  )
```

### Question 8

The visualization below shows the number of flights by each 
carrier out of each of the three airports in NYC in 2013. 

```{r fig.height = 2.5}
ggplot(flights, aes(x = carrier)) +
  geom_bar() +
  facet_wrap(~ origin, scales = "free")
```

```{r q8, echo=FALSE}
question(
    "Which of the following would *necessarily* improve this visualization? 
    Check all that apply.",
    allow_retry = TRUE, random_answer_order = TRUE,
    answer("Flip the coordinates so carriers are on the y-axis and
           counts are on the x-axis, leaving more room for the labels.", correct = TRUE),
    # answer("Fix the scales of the axes so that the carriers are in the 
    #        same order for each and the counts are on the same scale.", 
    #        correct = TRUE),
    # answer("Place carrier names at an angle so they don't overlap."),
    # answer("Add a title.", correct = TRUE),
    answer("Use airline names instead of carrier codes.", correct = TRUE),
    answer("Change the background color of the plot."),
    answer("Use a different color for each bar.")
    # answer("Use a histogram to represent the data.")
  )
```

### Question 9

Below are two visualizations displaying the same information: monthly 
distribution of flights out of NYC airports in 2013.

```{r echo=FALSE}
flights %>%
  mutate(month_label = month(month, label = TRUE)) %>%
  ggplot(aes(x = factor(1), fill = month_label)) +
  geom_bar(width = 1) +
  coord_polar(theta = "y") + 
  labs(x = "", y = "") +
  theme_minimal() +
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid  = element_blank()) +
  labs(title = "Pie chart")
```

```{r echo=FALSE, fig.height = 2}
flights %>%
  mutate(month_label = month(month, label = TRUE)) %>%
  ggplot(aes(x = month_label)) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Bar chart", x = "", y = "")
```

```{r q9, echo=FALSE}
question(
    "Which of the following is true?",
    allow_retry = TRUE, random_answer_order = TRUE,
    answer("The bar chart reveals that the number of flights vary slightly 
           from month to month, which is hidden in the pie chart.", 
           correct = TRUE),
    answer("The bar chart is the best possible representation of these data."),
    answer("The bar chart would be improved if the same colors from the 
           pie chart were applied to the bars."),
    answer("The two visualizations are equally good for communicating the 
           monthly distribution  of flights out of NTC airports in 2013")
  )
```

### Question 10

For this last question let's focus on flights that departed early:

```{r early-departures}
early_departures <- flights %>%
  filter(dep_delay < 0)
```

There are `r nrow(early_departures)` such flights!

```{r early-departures-nrow}
nrow(early_departures)
```

Below are two plots that show the relationship between air time and distance 
traveled for these flights: one of them is a scatterplot (created with `geom_bin()`) 
and the other is a hexagonal heatmap (created with `geom_hex()`). Which is a 
better representation of these data, and why?

```{r early-departures-point, echo = FALSE, warning=FALSE}
ggplot(early_departures, aes(x = distance, y = air_time)) +
  geom_point() +
  labs(
    x = "Distance, in miles",
    y = "Air time, in minutes",
    title = "Air time vs. distance for flights that departed early",
    subtitle = "2013 departures from NYC airports"
  )
```

```{r early-departures-hex, echo = FALSE, warning=FALSE}
ggplot(early_departures, aes(x = distance, y = air_time)) +
  geom_hex() +
  labs(
    x = "Distance, in miles",
    y = "Air time, in minutes",
    title = "Air time vs. distance for flights that departed early",
    subtitle = "2013 departures from NYC airports"
  )
```

```{r q10, echo=FALSE}
question(
    "Which of the following is true?",
    allow_retry = TRUE, random_answer_order = TRUE,
    answer("The scatterplot is better because it shows each individual observation."),
    answer("The hexagonal heatmap is better because it shows density instead, which 
           makes it easier to see where there are higher/lower numbers of 
           observations.", correct = TRUE),
    answer("The hexagonal heatmap is better because it has nicer colors."),
    answer("The scatterplot is better because it's simpler.")
  )
```

## Submit

```{r context="server"}
learnrhash::encoder_logic()
```

If you have completed this quiz and are happy with all of your solutions,
please *click the button below* to generate (or update) your hash. Then,
copy-paste the entire hash into Moodle.

```{r encode, echo=FALSE}
shiny::tags$div(
  shiny::fixedRow(shiny::column(width = 3, 
                                shiny::actionButton("hash_generate", "Generate Submission")), 
                  shiny::column(width = 7), shiny::column(width = 2)), 
  shiny::tags$br(), learnrhash:::wrapped_verbatim_text_output("hash_output", TRUE),
  shiny::tags$br())
```
