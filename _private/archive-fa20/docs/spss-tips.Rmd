---
title: "Tips for working with SPSS data"
author: "K Arnold"
date: "10/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

Pew and other sources release data in a file format used by SPSS, a commercial
statistical analysis tool. Fortunately it's straightforward to read this data
in R, using the [`haven`](https://haven.tidyverse.org/) package.

I'll show an example with the American Trends Panel. 

```{r}
atp_w34 <- haven::read_sav("data/W34_Apr18/ATP W34.sav")
```

The easiest way to look at this data is to click on it in the "Environment" panel,
or run `View(atp_w34)` on the Console. (Remember not to leave a `View` call in
an Rmd when you Knit.)

You'll see that each column has a label. It might be hard to read all of them, so
here's a bit of magic code to make a table of just the column labels:

```{r}
getColumnLabels <- function(df) {
  tibble(
    name = names(df),
    label = map_chr(names(df), ~ attr(df[[.]], "label"))
  )
}
getColumnLabels(atp_w34)
```

Many of the columns are actually factors in disguise. To decode their labels,
call `as_factor`. For example, to get party affiliations and leanings from
the ATP data, we can do:

```{r}
atp_w34_wrangled <- atp_w34 %>% 
  mutate(
    party = as_factor(F_PARTY_FINAL),
    party_lean = as_factor(F_PARTYLN_FINAL),
    age = as_factor(F_AGECAT_FINAL))
atp_w34_wrangled %>% select(party, party_lean)
```

## Weights

Note that Pew survey data include *weights*. Read their Methodology sections for details about these weights.
Once you've identified the correct weights to use, you can use the `wt` parameter to `count`
to weight your counts accordingly, or the `weighted.mean` function if you're interested in a
specific outcome.

For example, the following gives the proportion of each party among *survey respondents*:

```{r}
atp_w34_wrangled %>% 
  count(party) %>% 
  mutate(proportion = n / sum(n))
```

while this gives the (estimated) proportion of each party in the US:

```{r}
atp_w34_wrangled %>% 
  count(party, wt = WEIGHT_W34) %>% 
  mutate(proportion = n / sum(n))
```

Add more variables to `count` to get cross-tabulations:

```{r}
atp_w34_wrangled %>% 
  count(party, age, wt = WEIGHT_W34) %>% 
  group_by(age) %>% # Get party membership within each age range
  mutate(proportion = n / sum(n))
```

