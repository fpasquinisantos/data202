---
title: "Example Project"
author: "K Arnold"
date: "11/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
```

```{r}
data <- read_csv("data/Steps.csv", col_types = cols(
  Start = col_character(), # We'll manually parse the date below
  Finish = col_character(),
  `Steps (count)` = col_double()
))
```

The dates are in a weird format:

```{r}
data %>% head(1)
```

I had to look up how to get `lubridate` to parse it:

```{r}
lubridate::parse_date_time("27-Jun-2016 18:26", "dmY HM")
```

(Notice that the time zone is wrong. More on that later.)

Tidy the data:

```{r}
steps <- data %>% mutate(
  date = parse_date_time(Start, "dmY HM")
) %>% 
  select(date, steps = `Steps (count)`)
steps
```

Let's make a couple quick plots. First, I wonder what the overall range of data is.

```{r}
steps %>% 
  group_by(month = floor_date(date, unit = "month")) %>% 
  summarize(steps = sum(steps)) %>% 
  ggplot(aes(x = month, y = steps)) + geom_line()
```

The first month is probably low because I got the phone at the end of the month.
The last month might be low because I took this snapshot mid-month.
And winter 2017-2018... I think you can tell when my kids were born.

I wonder if the time zone is right. Let's check the hourly distribution.

```{r}
steps %>% 
  group_by(hour = hour(date)) %>% 
  summarize(steps = sum(steps)) %>% 
  ggplot(aes(x = hour, y = steps)) + geom_col()
```

It looks like it's in local time. For our purposes that's fine. The small amount of
overnight walking may have been from an international trip.

Now let's see if we can reproduce Apple's plot. I think of it as an average of 
a bunch of daily curves, each with 24 rows: the cumulative number of steps taken by that numbered hour.

Since we're pretty sure that the data is sorted by increasing time, `cumsum` by 
date should just do it.

```{r}
steps_by_hour <- steps %>% 
  group_by(day = floor_date(date, unit = "day"), hour = hour(date)) %>% 
  summarize(steps = sum(steps))
# Now we have one row per hour
steps_by_hour
```


```{r}
cum_steps <- steps_by_hour %>% 
  group_by(day) %>% 
  mutate(cum_steps = cumsum(steps))
cum_steps
```

```{r}
ggplot(cum_steps, aes(x = hour, y = cum_steps)) + geom_point(alpha = .1)
```

Hm, that's weird. I'd expect that every day's 23rd hour has the total step count
that day, but it looks like hour 23 has not much data. In fact it looks like there
are a different number of hours each day!

```{r}
cum_steps %>% group_by(hour) %>% count()
```
Probable cause: there are some hours where there were no steps, so there were
no entries for that hour in the data frame. It's "missing" data, but we know
that missing means 0 here. 

To fix this, I could do a fancy join, but fortunately `tidyr` includes a `complete`
function (which I found by Googling "group_by missing combination"). Let's 
apply it to the data frame that was incomplete: the `steps_by_hour` table:

```{r}
steps_by_hour_complete <- 
  steps_by_hour %>%
  group_by(day) %>% 
  complete(hour = 0:23, fill = list(steps = 0))
steps_by_hour_complete %>% tail()  
#)
  #day = seq(min(steps_by_hour$day), max(steps_by_hour$day), by = "1 day"),
```

```{r}
cum_steps <- steps_by_hour_complete %>% 
  group_by(day) %>% 
  mutate(cum_steps = cumsum(steps))
```

Now we can try plotting that again. I use `group = day` to make each day plot 
its own separate line.

```{r}
ggplot(cum_steps, aes(x = hour, y = cum_steps, group = day)) +
  geom_line(alpha = .05)
```

That's starting to look right! Now let's try two different ways of making the
original vis. First, median:

```{r}
cum_steps %>% 
  group_by(hour) %>% 
  summarize(cum_steps = median(cum_steps)) %>% 
  ggplot(aes(x = hour, y = cum_steps)) + 
  geom_line()
```

That looks good. Now if we want to compare to the current day so far:

```{r}
cum_steps %>% 
  ungroup() %>% 
  filter(day == last(day))
```


```{r}
cum_steps %>% 
  group_by(hour) %>% 
  summarize(cum_steps = median(cum_steps)) %>% 
  ggplot(aes(x = hour, y = cum_steps)) + 
  geom_line() +
  geom_line(
    data = cum_steps %>% ungroup() %>% filter(day == last(day), hour <= 20),
    color = "#888888")
```

