---
title: "Calvin Context"
date: "`r lubridate::now()`"
output: 
  html_document:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, 
  fig.width = 10, fig.height = 4, 
  warning = FALSE, message = FALSE
)
library(labelled)
# library(flexdashboard)
library(ggformula)
library(lubridate)
library(tidyr)
library(dplyr)
library(stringr)
library(purrr)
library(cowplot)
library(reactable)
theme_set(theme_bw())

# library(odbc)
# library(dbplyr)

library(readxl)
library(readr)
library(rvest)
library(httr)
library(zoo)  # for rollmean()

```

```{r}
spectrum_url <- 
  "https://docs.google.com/spreadsheets/d/1emAYXREE195wnGbe_iWNlMpGDzOrv5VgMeEruLc9l_I/export?format=csv&gid=777006588"

Spectrum_raw <- readr::read_csv(spectrum_url)
```


```{r}
Spectrum <- 
  Spectrum_raw %>% 
  select(1:3) %>%
  set_names(c("date", "cum_tests", "cum_pos")) %>% 
  mutate(
    date = lubridate::ymd(date),
    delta_tests = cum_tests - lag(cum_tests, 1),
    delta_pos   = cum_pos - lag(cum_pos, 1),
    frac_pos_new = delta_pos / delta_tests,
    days_since_last = as.numeric(date - lag(date, 1), units = "days"),
    tests_per_day = delta_tests / days_since_last,
    new_pos_per_day = delta_pos / days_since_last,
    centered_date = date - ddays(days_since_last / 2),
    new_pos7 = rollmean(new_pos_per_day, 7, fill = NA, align = "center"),
    frac_pos7 = rollmean(frac_pos_new, 7, fill = NA, align = "center"),
    new_tests7 = rollmean(tests_per_day, 7, fill = NA, align = "center")
)
spectrum_positives_plot <- Spectrum %>% 
  gf_point(new_pos_per_day ~ centered_date, size = 0.5, alpha = 0.4) %>%
  gf_line(new_pos7 ~ centered_date, color = "blue") %>% 
  gf_labs(
    title = "Spectrum Health Positive Tests Per Day",
    y = "",
    x = ""
  ) %>%
  gf_lims(y = c(0, NA))

spectrum_tests_plot <- Spectrum %>% 
  gf_point(tests_per_day ~ centered_date, size = 0.5, alpha = 0.4) %>%
  gf_line(new_tests7 ~ centered_date, color = "blue") %>% 
  gf_labs(
    title = "Spectrum Health Total Tests Per Day",
    y = "",
    x = ""
  ) %>%
  gf_lims(y = c(0, NA))

spectrum_positivity_plot <- 
  Spectrum %>%
  gf_point(frac_pos_new ~ centered_date, size = 0.5, alpha = 0.4) %>%
  gf_line(frac_pos7 ~ centered_date, color = "blue") %>%
  gf_labs(
    title = "Spectrum Health Positivity Rate",
    y = "",
    x = ""
  ) %>%
  gf_refine(scale_y_continuous(labels = scales::percent, limits = c(0, NA))) 
spectrum_tests_plot

plot_grid(spectrum_positives_plot, spectrum_positivity_plot)

```

```{r fig.width=7, fig.height=3}
spectrum_hospitalized_plot <- Spectrum_raw %>% 
  select(Date, Hospitalized) %>%
  mutate(Date = lubridate::ymd(Date)) %>% 
  drop_na(Hospitalized) %>% 
  slice(3:n()) %>% # Take only data from after the big gap
  mutate(hospitalized3 = rollmean(Hospitalized, 3, fill = NA, align = "center")) %>% 
  gf_line(hospitalized3 ~ Date, color = "blue", size = 1) %>% 
  gf_point(Hospitalized ~ Date) %>% 
  gf_lims(y = c(0, NA)) %>% 
  gf_labs(title = "Hospitalized Covid patients in Spectrum Health facilities", subtitle = "Omits patients with pending tests", y = "")
```

```{r my-spectrum-surge-model, eval=FALSE, include=FALSE}
library(fable)
library(tsibble)
spectrum_hospitalized <- Spectrum_raw %>% 
  select(date = Date, hospitalized = Hospitalized) %>%
  mutate(date = lubridate::ymd(date)) %>% 
  drop_na(hospitalized) %>% 
  slice(20:n()) %>% 
  as_tsibble(index = date)
#autoplot(spectrum_hospitalized)
spectrum_hospitalized %>% model(
  ets = ETS(hospitalized ~ trend("Md")),
  arima = ARIMA(hospitalized)
) %>% forecast(h = "1 months") %>% autoplot(spectrum_hospitalized)
```


```{r include = FALSE}
lag_days <- 3
tailna <- function(x, n = 3) {
  x[(length(x) - n + 1): length(x)] <- NA
  x
}
```

Kent County and Michigan plots show daily counts and 7-day rolling averages
using data available at <https://www.michigan.gov/coronavirus/0,9753,7-406-98163_98173---,00.html>

Notes: 

* The most recent few days of COVID reports from the State of Michigan are typically incomplete. 
For this reason, the rolling average is not computed using data from the last `r lag_days` days.
* The availability of tests and the criteria determining who gets tested have changed over time.

```{r root, include = FALSE}
root_url <- "https://www.michigan.gov/coronavirus/"
```

```{r today-path, include = FALSE}
toplevel_html <- read_html(root_url)
today_path <- toplevel_html %>%
  html_node(".stat-container .moreLink a") %>%
  html_attr("href") %>% 
  url_absolute(root_url)
```

```{r details, include = FALSE}
details_html <- read_html(today_path)
```

```{r read-excel-url, include = FALSE}
read_excel_url <- function(url, dirname) {
  filename <- url_parse(url)$path %>% basename()
  outfilename <- file.path(dirname, filename)
  #cat("Downloading ", url, " to ", outfilename)
  httr::GET(url, httr::write_disk(outfilename))
  res <- read_excel(outfilename)
  res
}
```

```{r spreadsheets, include = FALSE}
spreadsheets <- details_html %>%
  html_nodes(xpath = "//a[contains(@href, \".xlsx\")]") %>%
  {
    tibble(
      title = html_text(.),
      url = html_attr(., "href")
    )
  }
```

```{r retrieved, include = FALSE}
MI_download_dirname <- str_c("dl/", Sys.time() %>% strftime("%Y-%m-%d %H_%M_%S"))
dir.create(MI_download_dirname, recursive = TRUE)

retrieved <- 
  spreadsheets %>%
  mutate(
    full_url = xml2::url_absolute(url, root_url),
    contents = purrr::map(full_url, ~ read_excel_url(., MI_download_dirname))
  )

getSheet <- function(name) {
  retrieved %>% 
  filter(str_detect(title, coll(name, ignore_case = TRUE))) %>% 
  pull(contents) %>% 
  chuck(1)
}
```


```{r MI-Kent, include = FALSE}
MI <- 
  getSheet("Cases and Deaths by County by Date") %>% 
  mutate(Date = lubridate::as_date(Date))

Kent <- 
  MI %>% dplyr::filter(COUNTY == "Kent") %>% 
  group_by(CASE_STATUS) %>%
  mutate(
    Cases7 = rollmean(tailna(Cases, lag_days), k = 7, fill = NA),
    Deaths7 = rollmean(tailna(Deaths, lag_days), k = 7, fill = NA),
    Deaths14 = rollmean(tailna(Deaths, lag_days), k = 14, fill = NA),
  ) %>%
  set_variable_labels(
    Cases7 = "Cases",
    Deaths7 = "Deaths",
    Deaths14 = "Deaths"
  )

MI <- 
  MI %>% 
  arrange(Date) %>%
  group_by(COUNTY, CASE_STATUS) %>% 
  mutate(
    Cases7 = rollmean(tailna(Cases, lag_days), k = 7, fill = NA),
    Deaths7 = rollmean(tailna(Deaths, lag_days), k = 7, fill = NA),
    Deaths14 = rollmean(tailna(Deaths, lag_days), k = 14, fill = NA),
  ) %>% 
  set_variable_labels(
    Cases7 = "Cases",
    Deaths7 = "Deaths",
    Deaths14 = "Deaths"
  )
```

<!-- Date range (Kent County): `r range(Kent$Date, na.rm = TRUE) %>% paste(collapse = " - ")` -->

<!-- Date range (MI): `r range(MI$Date, na.rm = TRUE) %>% paste(collapse = " - ")` -->


```{r, Kent-plots, echo = FALSE, message = FALSE}
kent1 <- 
  Kent %>% arrange(Date) %>% filter(CASE_STATUS == "Confirmed") %>%
  # dashplot(value = Cases7, time = Date, breaks = c(0, 50, 100, 200)) %>%
  gf_line(Cases7 ~ Date, color = "maroon") %>%
  gf_point(Cases ~ Date, alpha = 0.3, color = "black", size = 0.5) %>%
  gf_lims(y = c(0, NA)) %>%
  gf_labs(title = "Kent County Confirmed COVID Cases", y = "Cases", x = "")
```

```{r, kent-plots-generate, echo = FALSE, message = FALSE}
kent2 <- 
  Kent %>% arrange(Date) %>% filter(CASE_STATUS == "Confirmed") %>%
  # dashplot(value = Deaths7, time = Date, breaks = c(0, 4, 8, 20)) %>%
  gf_line(Deaths14 ~ Date, color = "maroon") %>%
  gf_point(Deaths ~ Date, alpha = 0.3, color = "black", size = 0.5) %>%
  gf_lims(y = c(0, NA)) %>%
  gf_labs(title = "Kent County Confirmed COVID Deaths", y = "Deaths", x = "")
```


```{r, mi-plots-generate, echo = FALSE, message = FALSE}
mi1 <- MI %>% filter(CASE_STATUS == "Confirmed") %>%
  group_by(Date) %>% 
  summarise(Cases = sum(Cases), Deaths = sum(Deaths)) %>%
  arrange(Date) %>% 
  gf_point(Cases ~ Date, alpha = 0.3, size = 0.4, show.legend = FALSE) %>%
  gf_line(rollmean(tailna(Cases, lag_days), k = 7, fill = NA) ~ Date, 
          na.rm = TRUE, color = 'maroon') %>%
  gf_lims(y = c(0, NA)) %>%
  gf_labs(title = "Michigan Confirmed COVID Cases", x = "")

mi2 <- MI %>% filter(CASE_STATUS == "Confirmed") %>%
  group_by(Date) %>% 
  summarise(Cases = sum(Cases), Deaths = sum(Deaths)) %>%
  arrange(Date) %>% 
  gf_point(Deaths ~ Date, alpha = 0.3, size = 0.4, show.legend = FALSE) %>%
  gf_line(rollmean(tailna(Deaths, lag_days), k = 7, fill = NA) ~ Date, 
          na.rm = TRUE, color = 'maroon') %>%
  gf_lims(y = c(0, NA)) %>%
  gf_labs(title = "Michigan Confirmed COVID Deaths", x = "")
```

### Michigan

```{r, mi-plots, fig.width = 9, fig.height = 2.5}
plot_grid(mi1, mi2, ncol = 2)
```

### Kent County

```{r, kent-plots, fig.width = 9, fig.height = 2.5}
plot_grid(kent1, kent2, ncol = 2)
```

### Spectrum Health

```{r, spectrum-plots, fig.width = 9, fig.height = 2.5}
plot_grid(spectrum_positives_plot, spectrum_positivity_plot, ncol = 2)
```

```{r spectrum-hospitalized-plot, fig.width=9, fig.height=2.5}
spectrum_hospitalized_plot
```



```{r, include = FALSE}
MI %>% 
  filter(CASE_STATUS == "Confirmed") %>%
  arrange(desc(Date)) %>%
  mutate(Cases7 = round(Cases7, 1)) %>%
  mutate(Deaths7 = round(Deaths7, 1)) %>%
  select(County = COUNTY, Date, matches('Cases'), matches('Deaths')) %>% 
  reactable(filterable = TRUE, striped = TRUE, searchable = TRUE)
```


```{r fig.width = 9, fig.height = 2.5}
kent_tests <- getSheet("Diagnostic Tests by Result and County") %>% 
  filter(COUNTY == "Kent") %>% 
  mutate(
    new_pos = Positive,
    new_pos7 = rollmean(new_pos, 7, fill = NA, align = "center"),
    frac_pos_new = Positive / Total,
    frac_pos_new7 = rollmean(frac_pos_new, 7, fill = NA, align = "center")
  )

getSheet("Diagnostic Tests by Result and County") %>% 
  filter(COUNTY == "Kent") %>% 
  gf_point(Positive ~ MessageDate) %>% 
  gf_line(rollmean(Positive, 7, fill = NA, align = "center") ~ MessageDate, color = "maroon") %>% 
  gf_labs(x = "Date", title = "New cases reported in Kent County")

getSheet("Diagnostic Tests by Result and County") %>% 
  filter(COUNTY == "Kent") %>% 
  mutate(is_weekend = case_when(
    lubridate::wday(MessageDate, label = TRUE) %in% c("Sat", "Sun") ~ "weekend",
    TRUE ~ "weekday"
  )) %>% 
  gf_point(Total ~ MessageDate, color = ~ is_weekend) %>% 
  gf_line(rollmean(Total, 3, fill = NA, align = "center") ~ MessageDate, color = "maroon") %>% 
  gf_labs(x = "Date", title = "Kent County total tests done")


# getSheet("Diagnostic Tests by Result and County") %>% 
#   group_by(MessageDate) %>% 
#   summarize(Positive = sum(Positive)) %>% 
#   gf_point(Positive ~ MessageDate) %>% 
#   gf_line(rollmean(Positive, 7, fill = NA, align = "center") ~ MessageDate, color = "maroon") %>% 
#   gf_labs(x = "Date", title = "New cases reported in Michigan")


kent_tests %>% 
  slice(-(1:10)) %>% # Remove the first few days of tests, which were extremely high
  gf_point(frac_pos_new ~ MessageDate) %>% 
  gf_line(frac_pos_new7 ~ MessageDate, color = "maroon") %>% 
  gf_refine(scale_y_continuous(
    labels = scales::percent,
    oob = scales::oob_squish)) %>% 
  gf_labs(x = "Date", y = "", title = "Positivity Rate in Kent County")
  
```


```{r}
Kent_wide <- MI %>%
  dplyr::filter(COUNTY == "Kent") %>%
  pivot_wider(id_cols = Date, names_from = CASE_STATUS, values_from = c(Cases, Deaths))

getSheet("Diagnostic Tests by Result and County") %>% 
  filter(COUNTY == "Kent") %>% 
  left_join(
    Kent_wide,
    by = c("MessageDate" = "Date")
  ) %>% 
  rename(date = MessageDate) %>% 
  pivot_longer(
    -c(COUNTY, date),
    names_to = "measure") %>% 
  filter(measure %in% c("Positive", "Cases_Confirmed", "Cases_Probable")) %>% 
  group_by(measure) %>% 
  #mutate(value7 = rollmean(tailna(value), 7, fill = NA, align = "center")) %>% 
  filter(date > "2020-10-01") %>% 
  ggplot(aes(x = date, y = value, color = measure, group = .group)) +
  geom_point() +
  #gf_point(value ~ date, color = ~measure) +
  geom_line(aes(y = rollmean(tailna(value), 7, fill = NA, align = "center"), group = .group))
  #gf_line(value7 ~ date, color = ~measure) %>% 
  #gf_labs(x = "Date", title = "New cases reported in Kent County")

```

