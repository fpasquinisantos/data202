---
title: "Geo Data using Plotly"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document shows examples of two simple mapping tasks using Plotly. More details are available in the [plotly-r book](https://plotly-r.com/maps.html).

We'll be using the `tidyverse` and the `plotly` package.

```{r message=FALSE}
library(tidyverse)
library(plotly)
```

## Markers

When you just want to mark something on a map, you can give lat/long coordinates to `add_markers`.

For example, let's use a dataset of US cities:

```{r}
maps::us.cities %>% head()
```

Here's how to draw it on a map.

```{r geo-markers-example}
maps::us.cities %>% 
  # Fix the column names.
  rename(state = country.etc) %>%
  # Keep only larger cities.
  filter(pop > 100000) %>% 
  # Construct the "geo" projection.
  plot_geo() %>%
  # Add state markers
  add_markers(
    # Set marker position.
    x = ~long, 
    y = ~lat, 
    # Set other aesthetics (here, redundantly encode population)
    size = ~pop, 
    color = ~pop,
    # Customize the label.
    text = ~ glue::glue("{name}, population {scales::comma(pop)}"),  
    hoverinfo = "text"
  ) %>% 
  layout(
    # Zoom into just USA.
    geo = list(
      scope = 'usa'
    )
  )
```

## Choropleths

Plotly has builtin support for countries and US states. Any other granularity requires manually working with GeoJSON files; see
the documentation.

Let's make a world population map. First, let's construct a dataset of the most recent data that Gapminder has for each country:

```{r choropleth-example-data}
library(gapminder)
latest_country_data <- gapminder::gapminder_unfiltered %>%
  arrange(year) %>% 
  group_by(country) %>%
  slice_tail(n = 1) %>% 
  left_join(gapminder::country_codes, by = "country")
```

Now we add a "choropleth" trace. Note that this has the typical problem of choropleth maps and densities; see
[Fundamentals of Data Visualization](https://clauswilke.com/dataviz/geospatial-data.html#choropleth-mapping)
for some discussion of this.

```{r choropleth-example}
latest_country_data %>% 
  plot_geo() %>% 
  add_trace(
    type = "choropleth",
    # Specify that the "country" column contains the country names.
    locations = ~country,
    locationmode = "country names",
    # Use fill to show population. (I don't know why it's called 'z' and not 'fill'.)
    z = ~pop
  )
```



```{r include=FALSE}
#geojson <- pins::pin("https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson") %>% 
#jsonlite::fromJSON(simplifyVector = FALSE)
```
