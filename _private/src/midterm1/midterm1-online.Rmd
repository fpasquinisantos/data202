---
title: "Midterm 1 Take-Home Portion"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(learnr)
library(dplyr)
library(tidyr)
library(readr)
library(scales)
library(stringr)
library(forcats)
library(ggplot2)
library(learnrhash)
# Disable a warning message.
options(dplyr.summarise.inform = FALSE)
theme_set(theme_light())

set.seed(0)

car_prices <- readxl::read_excel("data/kuiper.xlsx") %>% janitor::clean_names()
fuel_eco <- read_csv("data/guide2005-2004oct15.csv") %>% janitor::clean_names()
```


## Visualization

This exercise uses a dataset from [Kuiper 2017](https://www.tandfonline.com/doi/full/10.1080/10691898.2008.11889579)
of car sale prices from Kelly Blue Book for several hundred 2005 used General Motors (GM) cars.
The [link to the data set](http://ww2.amstat.org/publications/jse/v16n3/kuiper.xls) can be found at the bottom of the article,
if you're interested in running this analysis on your own computer.

```{r load-data, eval=FALSE}
car_prices <- readxl::read_excel("data/kuiper.xlsx") %>% 
  janitor::clean_names()
```

(The [`janitor`](http://sfirke.github.io/janitor/) package provides some convenient
[utilities](http://sfirke.github.io/janitor/articles/janitor.html) for cleaning data.
Here we used `clean_names` to make sane formatting for all of the names.)

Let's take a quick look at the data:

```{r show-data, echo=TRUE}
car_prices %>% head()
car_prices %>% glimpse()
```

### Reproduce a plot

#### Price by Mileage

*Mileage* refers to how many miles the car has been driven.

**Write code to reproduce the following visualization**, intended to show that
lower-mileage cars tend to be valued more highly.

Tips:

* See the [Visualization Tweaks](https://cs.calvin.edu/courses/data/202/fa20/notes/visualization.html#tweaks)
  section of the course notes for tips on the scales.

```{r mileage-plot, echo=FALSE}
car_prices %>% 
  ggplot(aes(x = mileage, y = price / 1000, color = type, shape = type)) +
  geom_point() +
  scale_x_continuous(labels = scales::comma) +
  labs(x = "Mileage (mi)", y = "Price ($1000)")
```

```{r mileage-plot-reproduce, exercise=TRUE}
car_prices %>% ___
```



**Extra credit (save this for last!)**: can you figure out how to make this plot? It shows the same data in 
each pane, but highlights the cars of each given type. 

Tip: two `geom_point` layers, one with `data` set to `car_prices` *without the `type` column*.

```{r mileage-plot-improved, echo=FALSE}
car_prices %>%
  ggplot(aes(x = mileage / 1000, y = price / 1000, color = make, shape = make)) +
  geom_point(data = car_prices %>% select(-"type"), color = "grey", size = .5) + 
  geom_point(size = 1) +
  facet_wrap(vars(type)) + 
  labs(x = "Mileage (1000 mi)", y = "Price ($1000)")
```

```{r mileage-plot-improved-repro, exercise=TRUE}

```

### High or Low Mileage

**Write code to reproduce the following visualization**, intended to show whether
mileage affects price differently for different types of cars.
Consider a car to be "low mileage" if its mileage is less than the median
mileage.


```{r mileage-lo-hi, echo=FALSE}
car_prices %>% 
  #group_by(type) %>% 
  mutate(low_mileage = if_else(mileage < median(mileage), "Low mileage", "High mileage")) %>% 
  ggplot(aes(y = fct_reorder(type, price), x = price / 1000, color = low_mileage)) +
    geom_boxplot() +
    labs(y = "", x = "Price ($1000)", color = "") +
    xlim(c(0, NA))
```

```{r mileage-lo-hi-reproduce, exercise=TRUE}

```

Note on ordering: I used `fct_reorder` to reorder the car `type` by `price`, but it's fine if you don't.

## Data Wrangling

**Make a table** that clearly shows the most and least common car `make` in this data set.

```{r most-common-make-sol, include=FALSE}
car_prices %>% 
  group_by(make) %>%
  summarize(n = n()) %>% 
  arrange(desc(n))
```

```{r most-common-make-repro, exercise=TRUE}

```

**Make a table** showing which car `type` has the highest and lowest average price.
Include only 4-door cars (`doors`).

```{r price-by-type-table-sol, include=FALSE}
car_prices %>%
  filter(doors == 4) %>% 
  group_by(type) %>% 
  summarize(avg_price = mean(price)) %>% 
  arrange(desc(avg_price))
```

```{r price-by-type-table, exercise=TRUE}

```


## Align, Combine, and Reshape

**Note**: This section includes several steps. To allow you to make progress
even if you're struggling with an earlier step, each Code cell runs in a fresh
environment with a correct answer for the two intermediate variables
(`fuel_eco_avg` and `car_prices_and_eco`) pre-loaded.

For increasingly many consumers, fuel economy is a deciding factor in purchasing
decisions. However, the Kelly Blue Book data set doesn't include any fuel economy
data. Fortunately the US Department of Energy and the EPA put together
<https://www.fueleconomy.org>. That site provides both consumer-facing tools
to compare the monetary and environmental fuel costs of various vehicles.
Fortunately they also release machine-readable [data files](https://www.fueleconomy.gov/feg/download.shtml).
According to the Kuiper 2017 article, all of the vehicles were 2005 model year
and less than a year old, so the 2005 data has been downloaded for you:

```{r load-mpg, eval=FALSE, echo=TRUE}
fuel_eco <- read_csv("data/guide2005-2004oct15.csv") %>% janitor::clean_names()
```

Notable columns are (descriptions are quoted from the EPA's [guide](https://www.fueleconomy.gov/feg/pdfs/guides/FEG2005.pdf)):

* `manufacturer` and `carline_name`: the make and model of the car tested.
* `cty`: *City* represents urban driving, in which a vehicle is started in the morning (after being parked all night) and driven in stop-and-go rush hour traffic
* `hwy`: *Highway* represents a mixture of rural and interstate highway driving in warmed-up vehicles, typical of longer trips in free-flowing traffic.
* `cmb`: *Combined* city and highway MPG estimates ... assume you will drive 55% in the city and 45% on the highway.

(Full documentation from the source is available [here](https://www.fueleconomy.gov/feg/epadata/Readme.txt)
but is not needed for these exercises.)

We first briefly verify that the *carline name* is sufficiently unique to describe a car; there
are no cars with the same name but different manufacturers:

```{r verify-distinct, echo=TRUE}
fuel_eco %>% distinct(carline_name) %>% nrow()
fuel_eco %>% distinct(manufacturer, carline_name) %>% nrow()
```

Good to go. But a brief look at the dataset immediately reveals two potential problems:

```{r show-fuel-eco-caps, echo=TRUE}
fuel_eco %>% 
  arrange(manufacturer, carline_name) %>% 
  select(manufacturer, carline_name, cty, hwy, cmb) %>% head(5)
```

*First problem*: *each car may be reported several times* in the EPA dataset, once
for each different engine option or transmission type. We could work out
some of that data from the `trim` column, but for a first pass, let's just
take the *average* mileages for a given `carline_name`.

**Make a table called `fuel_eco_avg`** that gives the average `cty`, `hwy`, and `cmb`
fuel economy for each car. (Use `manufacturer` and `carline_name` to identify cars.)
While you're at it, use more sensible names:
`city`, `highway`, and `combined`. The result should look like:


```{r compute-fuel-eco-avg, include=FALSE, eval=TRUE}
fuel_eco_avg <- 
  fuel_eco %>% 
  group_by(manufacturer, carline_name) %>% 
  summarize(
    city = mean(cty),
    highway = mean(hwy),
    combined = mean(cmb)
  )
```


```{r show-fuel-eco-avg, eval=TRUE}
fuel_eco_avg
```

```{r fuel-eco-avg-repro, exercise=TRUE}

```


*Second problem*: the EPA uses all-caps for car names but the Kelly Blue Book didn't.
So none of the EPA's `carline_name`s in `fuel_eco` will match the `model`s in `car_prices`.
Let's look at `car_prices` again for reference:

```{r show-car-prices-head, echo=TRUE}
car_prices %>%
  distinct(make, model) %>%
  head(5)
```

But we won't let that stop us! Here's a strategy: ignore case. Specifically:

**Make a table called `car_prices_and_eco`** that has the city, highway, and
combined fuel economy for all of the cars in `car_prices`.
To ignore case in the matching, *upper-case* (`str_to_upper()`) the models in
`car_prices` and  put the result in a *new column*, which you can then use to
look up fuel economies in `fuel_eco_avg`. For cars that don't match the EPA
data even after
ignoring case, leave the fuel economies at `NA` (don't drop the row).

Tip: how many rows should the result have?

Notes:

- Include a caclucation at the end that shows how many rows in `car_prices` didn't match the EPA data
- A correct `fuel_eco_avg` data frame is provided for you here, regardless of what you wrote in the previous exercise.


```{r join-repro, exercise=TRUE, exercise.setup = "compute-fuel-eco-avg", exercise.eval=TRUE}

# How many rows didn't match?
```


```{r compute-join, include=FALSE, eval=TRUE, exercise.setup = "compute-fuel-eco-avg"}
car_prices_and_eco <- 
  car_prices %>% 
  mutate(carline_name = str_to_upper(model)) %>% 
  left_join(
    fuel_eco_avg,
    by = "carline_name")
```



```{r non-matches, include=FALSE}
car_prices_and_eco %>% 
  summarise(n = sum(is.na(combined)), frac = mean(is.na(combined)))
```

**Reproduce the following plot** using the `car_prices_and_eco` data frame.

*Notes*:

- You will need to reshape the data.
- The code will use a correct `car_prices_and_eco` data frame, regardless of what you wrote in the previous exercise.

```{r price-by-eco}
car_prices_and_eco %>% 
  pivot_longer(c(city, highway, combined), names_to = "measure", values_to = "economy") %>% 
  drop_na(economy) %>%  # note: without this the y axis extends longer
  ggplot(aes(x = economy, y = price / 1000, color = fct_relevel(measure, "city", "highway", "combined"))) +
  geom_point(alpha = .5) +
  geom_smooth() +
  labs(x = "Fuel Economy", y = "Price ($1000)", color = "Measure")
```

```{r price-by-eco-repro, exercise=TRUE, exercise.setup ="compute-join", exercise.eval=TRUE}

```

*Note*: I used `fct_relevel` to adjust the order of the measures, but you may 
leave it at the default order for full credit.

## Submit

```{r context="server"}
learnrhash::encoder_logic()
```

```{r encode, echo=FALSE}
learnrhash::encoder_ui(
  ui_before = shiny::div(
    "When you're all done, click the button below to generate a code, then copy and paste it to Moodle."
  )
)
```
